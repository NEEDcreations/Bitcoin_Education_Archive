<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://mempool.space">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="description" content="A curated Bitcoin education archive with 146 topics, 8800+ messages, and 3000+ images ‚Äî for the world.">
    <meta name="theme-color" content="#f7931a">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BTC Archive">
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preload" href="channel_index.js" as="script">

    <!-- Open Graph / Twitter Cards -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bitcoineducation.quest">
    <meta property="og:title" content="Bitcoin Education Archive">
    <meta property="og:description" content="A curated library of 146 topics, 8,800+ messages, and 3,000+ images ‚Äî Bitcoin education for the world.">
    <meta property="og:image" content="https://bitcoineducation.quest/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bitcoin Education Archive">
    <meta name="twitter:description" content="A curated library of 146 topics, 8,800+ messages, and 3,000+ images ‚Äî Bitcoin education for the world.">
    <meta name="twitter:image" content="https://bitcoineducation.quest/og-image.png">

    <title>Bitcoin Education Archive</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        *, *::before, *::after { box-sizing: border-box; }
        button, a, [onclick] { touch-action: manipulation; }
        html, body { overflow-x: hidden; scroll-behavior: smooth; }
        img { max-width: 100%; height: auto; }
        
        /* Smooth page load */
        body { opacity: 0; animation: bodyFadeIn 0.4s ease-out 0.1s forwards; }
        @keyframes bodyFadeIn { to { opacity: 1; } }
        
        /* Theme Variables */
        :root {
            --bg: #020617; --bg-side: #0f172a; --border: #1e293b;
            --text: #e2e8f0; --text-dim: #94a3b8; --text-muted: #64748b; --text-faint: #475569;
            --accent: #f97316; --accent-bg: rgba(249,115,22,0.15); --accent-glow: rgba(249,115,22,0.3);
            --heading: #fff; --link: #38bdf8;
            --input-bg: #020617; --msg-border: rgba(255,255,255,0.03);
            --card-bg: rgba(255,255,255,0.03); --overlay: rgba(0,0,0,0.92);
        }
        [data-theme="light"] {
            --bg: #f8fafc; --bg-side: #ffffff; --border: #e2e8f0;
            --text: #1e293b; --text-dim: #475569; --text-muted: #64748b; --text-faint: #94a3b8;
            --accent: #ea580c; --accent-bg: rgba(234,88,12,0.1); --accent-glow: rgba(234,88,12,0.2);
            --heading: #0f172a; --link: #2563eb;
            --input-bg: #f1f5f9; --msg-border: rgba(0,0,0,0.06);
            --card-bg: rgba(0,0,0,0.03); --overlay: rgba(255,255,255,0.95);
        }

        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; display: flex; height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; }
        
        /* Theme Toggle */
        .theme-toggle { background: none; border: 1px solid var(--border); color: var(--text-dim); width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; margin-left: 10px; }
        .theme-toggle:hover { border-color: var(--accent); color: var(--accent); }

        /* Sidebar */
        aside { width: 320px; background: var(--bg-side); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; transition: background 0.3s; }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .sidebar-header h2 { color: var(--accent); font-size: 1rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 900; line-height: 1.3; }
        .sidebar-header p { color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; }
        .channels { flex: 1; overflow-y: auto; padding: 12px; }
        .search-box { padding: 12px; border-bottom: 1px solid var(--border); }
        .search-input { width: 100%; padding: 10px 14px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; font-family: inherit; outline: none; }
        .search-input:focus { border-color: var(--accent); }
        .random-btn { background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; font-size: 1.3rem; width: 48px; height: 48px; cursor: pointer; transition: 0.2s; touch-action: manipulation; -webkit-tap-highlight-color: rgba(247,147,26,0.2); display: inline-flex; align-items: center; justify-content: center; }
        .random-btn:hover { border-color: var(--accent); transform: rotate(15deg); }
        .random-btn:active { transform: scale(0.95); }
        .mobile-close { position: absolute; top: 16px; right: 16px; background: var(--bg-side); border: 1px solid var(--border); color: var(--text-dim); font-size: 1.2rem; cursor: pointer; z-index: 101; line-height: 1; width: 40px; height: 40px; border-radius: 8px; display: none; align-items: center; justify-content: center; }
        .search-input::placeholder { color: var(--text-faint); }
        .search-results { padding: 12px; display: none; overflow-y: auto; flex: 1; background: var(--bg-side); }
        .search-results.active { display: block; }
        .sr-item { padding: 10px 14px; border-radius: 8px; cursor: pointer; color: var(--text-dim); font-size: 0.9rem; margin-bottom: 4px; border-left: 3px solid transparent; transition: 0.15s; }
        .sr-item:hover, .sr-item:active { background: var(--accent-bg); color: var(--heading); border-left-color: var(--accent); }
        .sr-item .sr-cat { font-size: 0.65rem; color: var(--text-faint); text-transform: uppercase; letter-spacing: 1px; }
        .sr-item .sr-match { color: var(--accent); font-size: 0.8rem; margin-top: 4px; line-height: 1.4; }
        .cat-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-faint); letter-spacing: 2px; margin: 20px 0 8px 12px; font-weight: 800; }
        .cat-toggle { cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding-right: 12px; transition: color 0.2s; user-select: none; }
        .cat-toggle:hover { color: var(--accent); }
        .cat-arrow { font-size: 0.55rem; transition: transform 0.2s; }
        .cat-group { overflow: hidden; transition: max-height 0.3s ease; }
        .ch-btn { display: block; width: 100%; text-align: left; background: none; border: none; color: var(--text-dim); padding: 11px 14px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; font-family: inherit; position: relative; }
        .ch-btn:hover { background: var(--card-bg); color: var(--text); transform: translateX(2px); }
        .ch-btn.active { background: var(--accent-bg); color: var(--accent); font-weight: 700; border-left: 3px solid var(--accent); }
        .ch-btn.visited::after { content: " ‚úì"; color: #22c55e; font-size: 0.75rem; font-weight: 800; }
        .ch-btn::before { content: "# "; color: var(--text-faint); font-weight: 700; }
        .ch-btn:active { transform: scale(0.98); }
        
        /* Main */
        main { flex: 1; overflow-y: auto; }
        
        /* Smooth page transitions */
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeSlideIn 0.35s ease-out; }

        .hero { padding: 80px 60px 40px; max-width: 1300px; margin: 0 auto; }
        .hero .cat { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); font-weight: 800; margin-bottom: 12px; }
        .hero h1 { font-size: 2.4rem; font-weight: 900; color: var(--heading); letter-spacing: -0.5px; line-height: 1.25; margin-bottom: 16px; }
        .hero .desc { color: var(--text-muted); font-size: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 30px; margin-bottom: 0; }
        
        /* Messages */
        .messages { max-width: 1300px; margin: 0 auto; padding: 0 60px 80px; overflow-x: hidden; }
        .msg { padding: 20px 0; border-bottom: 1px solid var(--msg-border); }
        .msg-text { color: var(--text); font-size: 1.05rem; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; max-width: 100%; }
        .msg-text strong, .msg-text b { color: var(--heading); }
        .tw-preview { margin: 12px 0; padding: 16px 20px; background: linear-gradient(135deg, rgba(29,155,240,0.08), rgba(247,147,26,0.08)); border: 1px solid rgba(29,155,240,0.3); border-radius: 12px; cursor: pointer; transition: 0.3s; position: relative; display: flex; align-items: center; gap: 14px; }
        .tw-preview:hover { border-color: #1d9bf0; box-shadow: 0 0 20px rgba(29,155,240,0.2); transform: translateY(-1px); }
        .tw-preview-icon { font-size: 1.8rem; flex-shrink: 0; }
        .tw-preview-content { flex: 1; min-width: 0; }
        .tw-preview-url { color: var(--text); font-size: 0.9rem; font-weight: 600; word-break: break-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tw-preview-hint { color: #1d9bf0; font-size: 0.85rem; margin-top: 4px; font-weight: 600; }
        .tw-preview-arrow { color: #1d9bf0; font-size: 1.2rem; flex-shrink: 0; transition: 0.2s; }
        .tw-preview:hover .tw-preview-arrow { transform: translateX(3px); }
        .tw-load-btn { display: none; }
        .tw-embedded { border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin: 8px 0; background: var(--card-bg); }
        .tw-embedded .tw-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.8rem; color: var(--text-faint); }
        .tw-embedded .tw-body { color: var(--text); font-size: 0.95rem; line-height: 1.6; }
        .tw-embedded .tw-footer { margin-top: 8px; font-size: 0.75rem; color: var(--text-faint); }
        .tw-loading { color: var(--text-faint); font-size: 0.85rem; padding: 12px; }
        .yt-embed { position: relative; width: 100%; max-width: 560px; padding-bottom: min(315px, 56.25%); height: 0; overflow: hidden; border-radius: 12px; margin: 12px 0; }
        .yt-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px; }
        .orange-glow { color: #f7931a; font-weight: 700; font-size: 1.1em; text-shadow: 0 0 20px rgba(247,147,26,0.4); padding: 16px 20px; margin-top: 8px; background: rgba(247,147,26,0.08); border: 1px solid rgba(247,147,26,0.25); border-radius: 12px; display: block; }
        .msg-img { max-width: 100%; border-radius: 12px; margin-top: 14px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .msg-img:hover { border-color: var(--accent); box-shadow: 0 8px 30px var(--accent-glow); }
        .msg-link { color: var(--link); text-decoration: none; word-break: break-all; }
        .msg-link:hover { text-decoration: underline; }
        /* Back to top */
        .back-to-top { position: fixed; bottom: 82px; right: 190px; width: 44px; height: 44px; border-radius: 50%; background: var(--accent); color: #fff; border: none; font-size: 1.3rem; cursor: pointer; z-index: 50; opacity: 0; transform: translateY(10px); transition: 0.3s; pointer-events: none; box-shadow: 0 4px 15px var(--accent-glow); }
        .back-to-top.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .back-to-top:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--accent-glow); }
        .scroll-to-bottom { bottom: 30px; right: 190px; }

        /* Reading progress bar */
        .progress-bar { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: linear-gradient(90deg, #eab308, #f97316); z-index: 300; transition: width 0.15s; pointer-events: none; }
        @media (max-width: 900px) { .progress-bar { top: 52px; } }

        /* Share buttons */
        .share-bar { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
        .share-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; text-decoration: none; cursor: pointer; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-dim); font-family: inherit; transition: 0.2s; }
        .share-btn:hover { border-color: var(--accent); color: var(--accent); }
        .share-btn.copied { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* Image gallery mode */
        .gallery-toggle { display: none; padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-dim); font-size: 0.8rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: 0.2s; margin-top: 12px; }
        .gallery-toggle:hover { border-color: var(--accent); color: var(--accent); }
        .gallery-toggle.active { background: var(--accent-bg); border-color: var(--accent); color: var(--accent); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; padding: 20px 0; }
        @media (max-width: 900px) { .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 6px; } }
        .gallery-grid img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .gallery-grid img:hover { border-color: var(--accent); transform: scale(1.03); box-shadow: 0 4px 15px var(--accent-glow); }

        .load-more-btn { display: block; width: 100%; padding: 16px; margin: 30px 0; background: var(--accent-bg); border: 1px solid var(--accent-glow); border-radius: 12px; color: var(--accent); font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; transition: 0.2s; }
        .load-more-btn:hover { background: var(--accent-glow); }
        .msg-img { content-visibility: auto; }
        
        /* Sidebar Promo */
        .quest-start-btn { display: block; width: calc(100% - 24px); margin: 8px 12px; padding: 10px; background: var(--accent-bg); border: 1px solid var(--accent-glow); border-radius: 8px; color: var(--accent); font-size: 0.85rem; font-weight: 700; cursor: pointer; font-family: inherit; transition: 0.2s; text-align: center; }
        .quest-start-btn:hover { background: var(--accent); color: #fff; }

        .sidebar-promo { display: block; text-align: left; padding: 12px; color: var(--text-faint); font-size: 0.8rem; text-decoration: none; border-top: 1px solid var(--border); transition: 0.2s; letter-spacing: 0.5px; }
        .sidebar-promo:hover { color: var(--accent); background: var(--accent-bg); }

        /* Ranking Bar */
        #rankBar { display: none; flex-direction: column; padding: 12px 20px; border-top: 1px solid var(--border); background: var(--bg); cursor: pointer; }
        .rank-info { display: flex; align-items: center; gap: 10px; }
        .rank-level { font-weight: 800; font-size: 0.9rem; color: var(--accent); }
        .rank-user { color: var(--text-dim); font-size: 0.85rem; }
        .rank-pts { margin-left: auto; color: var(--accent); font-weight: 700; font-size: 0.85rem; }
        .rank-progress { height: 4px; background: var(--border); border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .rank-progress-fill { height: 100%; background: linear-gradient(90deg, #f97316, #eab308); border-radius: 4px; transition: width 0.5s; }
        .rank-next { font-size: 0.7rem; color: var(--text-faint); margin-top: 4px; }

        /* Toasts */
        .rank-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #f97316; color: #fff; padding: 12px 20px; border-radius: 10px; font-size: 0.9rem; font-weight: 700; z-index: 300; opacity: 0; transition: 0.3s; pointer-events: none; box-shadow: 0 8px 25px rgba(249,115,22,0.3); }
        .rank-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Leaderboard */
        #leaderboard { display: none; position: fixed; right: 20px; bottom: 20px; width: 340px; max-height: 70vh; background: var(--bg-side); border: 1px solid var(--border); border-radius: 16px; z-index: 150; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); transition: 0.3s; }
        #leaderboard.open { display: block; animation: fadeSlideIn 0.3s ease-out; }
        #leaderboard.minimized { max-height: 48px; overflow: hidden; border-radius: 24px; width: auto; cursor: pointer; }
        .lb-min-bar { display: none; padding: 12px 18px; font-size: 0.85rem; font-weight: 700; color: var(--accent); text-align: center; }
        #leaderboard.minimized .lb-min-bar { display: block; }
        #leaderboard.minimized .lb-header, #leaderboard.minimized .lb-list, #leaderboard.minimized .lb-levels { display: none; }
        @media (max-width: 900px) { #leaderboard { right: 10px; left: 10px; bottom: 10px; width: auto; max-height: 60vh; -webkit-overflow-scrolling: touch; border-radius: 16px; } }
        .lb-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .lb-header h3 { color: var(--heading); font-size: 1.1rem; }
        .lb-header div { display: flex; align-items: center; }
        .lb-close { background: none; border: 1px solid var(--border); color: var(--text-dim); font-size: 1.1rem; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .lb-close:hover { border-color: var(--accent); color: var(--accent); }
        .lb-list { padding: 8px; }
        .lb-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; }
        .lb-row:hover { background: var(--card-bg); }
        .lb-me { background: var(--accent-bg); border: 1px solid var(--accent-glow); }
        .lb-rank { font-size: 0.9rem; min-width: 30px; color: var(--text-muted); }
        .lb-name { color: var(--text); font-size: 0.9rem; flex: 1; }
        .lb-score { color: var(--accent); font-weight: 700; font-size: 0.85rem; }
        .lb-levels { padding: 12px 20px; border-top: 1px solid var(--border); }
        .lb-levels h4 { color: var(--text-faint); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .lb-level-row { display: flex; justify-content: space-between; padding: 4px 0; color: var(--text-muted); font-size: 0.8rem; }

        /* Username Modal */
        #usernameModal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay); z-index: 10000; overflow-y: scroll; -webkit-overflow-scrolling: touch; }
        #usernameModal.open { display: block; }
        .username-box { background: var(--bg-side); border: 1px solid var(--border); border-radius: 20px; padding: 40px; max-width: 400px; width: 90%; text-align: center; margin: 20px auto; position: relative; }
        @media (max-width: 900px) { .username-box { padding: 20px 16px; width: 95%; margin: 10px auto; } }
        .username-box h2 { color: #fff; margin-bottom: 8px; font-size: 1.5rem; }
        .username-box p { color: #64748b; margin-bottom: 24px; font-size: 0.95rem; }
        .username-box input { width: 100%; padding: 14px 18px; background: #020617; border: 1px solid var(--border); border-radius: 10px; color: #fff; font-size: 1rem; font-family: inherit; outline: none; margin-bottom: 16px; text-align: center; }
        .username-box input:focus { border-color: var(--accent); }
        .username-box button { background: #f97316; color: #fff; border: none; padding: 14px 30px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; width: 100%; }
        .username-box button:hover { background: #ea580c; }
        .username-box .skip { color: #475569; font-size: 0.85rem; margin-top: 12px; cursor: pointer; display: block; }
        .username-box .skip:hover { color: var(--text-dim); }

        @media (max-width: 900px) {
            #leaderboard { right: 10px; left: 10px; bottom: 70px; width: auto; }
            #lbFloatBtn { bottom: 70px !important; right: 16px !important; padding: 10px 14px !important; font-size: 0.85rem !important; z-index: 140; }
            #floatingRandomBtn { bottom: 70px !important; right: auto !important; left: 16px !important; transform: none !important; }
            #userDisplay { top: auto !important; bottom: 72px !important; right: auto !important; left: 16px !important; font-size: 0.75rem !important; padding: 6px 10px !important; max-width: 55% !important; }
            .rank-toast { top: 60px; left: 50%; right: auto; bottom: auto; font-size: 0.8rem; }
        }

        /* Badge Toast */
        .badge-toast { position: fixed; bottom: 30px; left: 30px; display: flex; gap: 14px; align-items: center; background: var(--bg-side); border: 1px solid #22c55e; padding: 16px 20px; border-radius: 14px; z-index: 300; opacity: 0; transform: translateY(20px); transition: 0.4s; box-shadow: 0 8px 30px rgba(34,197,94,0.2); }
        .badge-toast.show { opacity: 1; transform: translateY(0); }
        .badge-toast-emoji { font-size: 2rem; }
        .badge-toast-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #22c55e; font-weight: 800; }
        .badge-toast-name { color: var(--heading); font-weight: 700; font-size: 1rem; }
        .badge-toast-desc { color: var(--text-muted); font-size: 0.8rem; }

        /* Badges Grid */
        .badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; padding: 12px; }
        .badge-item { text-align: center; padding: 12px 6px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-bg); transition: 0.2s; position: relative; cursor: pointer; }
        .badge-item.earned { border-color: var(--accent-glow); }
        .badge-item.locked { opacity: 0.4; }
        .badge-item:hover { opacity: 1; transform: translateY(-2px); }
        .badge-emoji { font-size: 1.5rem; margin-bottom: 4px; }
        .badge-name { font-size: 0.65rem; color: var(--text-dim); font-weight: 600; }
        .badge-tooltip { display: none; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-side); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; white-space: nowrap; z-index: 160; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none; }
        .badge-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--border); }
        .badge-item:hover .badge-tooltip, .badge-item.tapped .badge-tooltip { display: block; }
        @keyframes badgeBounce { 0% { transform: scale(0); } 50% { transform: scale(1.3); } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }

        /* Quest Modal */
        #questModal { display: none; position: fixed; inset: 0; background: var(--overlay); z-index: 260; justify-content: center; align-items: center; overflow-y: auto; padding: 20px; }
        #questModal.open { display: flex; }
        #questInner { background: var(--bg-side); border: 1px solid var(--border); border-radius: 20px; padding: 40px; max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .quest-header { text-align: center; margin-bottom: 30px; }
        .quest-badge { display: inline-block; background: var(--accent); color: #fff; padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 800; letter-spacing: 1px; margin-bottom: 12px; }
        .quest-header h2 { color: var(--heading); font-size: 1.5rem; margin-bottom: 8px; }
        .quest-header p { color: var(--text-muted); font-size: 0.9rem; }
        .quest-q { margin-bottom: 24px; }
        .quest-q-num { color: var(--accent); font-weight: 800; font-size: 0.75rem; margin-bottom: 6px; }
        .quest-q-text { color: var(--heading); font-size: 1.05rem; font-weight: 600; margin-bottom: 12px; line-height: 1.4; }
        .quest-options { display: flex; flex-direction: column; gap: 8px; }
        .quest-opt { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; color: var(--text); font-size: 0.95rem; cursor: pointer; text-align: left; font-family: inherit; transition: 0.15s; }
        .quest-opt:hover { border-color: var(--accent); }
        .quest-opt.selected { background: var(--accent-bg); border-color: var(--accent); color: var(--accent); font-weight: 700; }
        .quest-opt.correct { background: rgba(34,197,94,0.15); border-color: #22c55e; color: #22c55e; }
        .quest-opt.wrong { background: rgba(239,68,68,0.15); border-color: #ef4444; color: #ef4444; }
        .quest-opt:disabled { cursor: default; opacity: 0.8; }
        .quest-submit { width: 100%; padding: 16px; background: var(--accent); color: #fff; border: none; border-radius: 12px; font-size: 1.05rem; font-weight: 700; cursor: pointer; font-family: inherit; margin-top: 20px; transition: 0.2s; }
        .quest-submit:disabled { opacity: 0.4; cursor: not-allowed; }
        .quest-submit:not(:disabled):hover { filter: brightness(1.1); }
        .quest-skip { width: 100%; padding: 12px; background: none; border: none; color: var(--text-faint); font-size: 0.9rem; cursor: pointer; font-family: inherit; margin-top: 8px; }
        .quest-skip:hover { color: var(--text-dim); }
        .quest-result { text-align: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
        .quest-result-msg { font-size: 1.3rem; font-weight: 800; color: var(--heading); margin-bottom: 20px; }
        .quest-retry { width: 100%; padding: 14px; background: var(--accent-bg); border: 1px solid var(--accent); border-radius: 12px; color: var(--accent); font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; margin-bottom: 10px; }
        .quest-done { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 12px; color: #fff; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }

        /* Home Page */
        .home-page { display: flex; animation: fadeSlideIn 0.4s ease-out; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 60px 30px; background: radial-gradient(ellipse at 30% 20%, rgba(249,115,22,0.08) 0%, transparent 60%), radial-gradient(ellipse at 70% 80%, rgba(121,45,228,0.06) 0%, transparent 60%); }
        .home-page.hidden { display: none; }
        .home-inner { max-width: 650px; }
        .home-logos { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .channel-logos { display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 16px; }
        .channel-logos .channel-logo-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 24px rgba(247,147,26,0.35); image-rendering: -webkit-optimize-contrast; }
        .channel-logos svg { width: 50px; height: 50px; }
        .donate-circle { position: relative; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; touch-action: manipulation; }
        .donate-circle::after { content: 'Donate'; position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; font-weight: 700; color: #f7931a; opacity: 0; transition: opacity 0.2s; white-space: nowrap; pointer-events: none; }
        .donate-circle:hover::after { opacity: 1; }
        .home-btc { filter: drop-shadow(0 0 30px rgba(247,147,26,0.4)); }
        .home-ln { filter: drop-shadow(0 0 30px rgba(247,147,26,0.4)); }
        .home-title { font-size: 3.5rem; font-weight: 900; color: var(--heading); letter-spacing: -1px; line-height: 1.15; margin-bottom: 20px; }
        .home-subtitle { font-size: 1.2rem; color: #64748b; margin-bottom: 40px; line-height: 1.6; }
        .home-credits { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 24px 30px; margin-bottom: 40px; text-align: left; }
        .home-credits p { color: var(--text-dim); font-size: 1rem; margin-bottom: 8px; line-height: 1.6; }
        .home-credits p:last-child { margin-bottom: 0; }
        .home-credits strong { color: var(--accent); }
        .home-stats { display: flex; justify-content: center; gap: 40px; margin-bottom: 40px; }
        .home-stat { display: flex; flex-direction: column; align-items: center; }
        .home-stat-num { font-size: 2rem; font-weight: 900; color: var(--accent); }
        .home-stat-label { font-size: 0.8rem; color: #475569; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
        .daily-channel { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 20px 24px; margin-bottom: 30px; cursor: pointer; transition: 0.2s; text-align: left; }
        .daily-channel:hover { border-color: var(--accent); box-shadow: 0 4px 20px var(--accent-glow); }
        .daily-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); font-weight: 800; margin-bottom: 8px; }
        .daily-title { color: var(--heading); font-size: 1.15rem; font-weight: 700; margin-bottom: 4px; }
        .daily-desc { color: var(--text-muted); font-size: 0.85rem; line-height: 1.4; }

        .home-cta { background: var(--accent); color: #fff; border: none; padding: 22px 60px; border-radius: 16px; font-size: 1.4rem; font-weight: 800; cursor: pointer; font-family: inherit; transition: 0.2s; letter-spacing: 0.5px; box-shadow: 0 4px 20px var(--accent-glow); margin-bottom: 30px; touch-action: manipulation; }
        .home-cta:hover { background: #ea580c; transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 40px rgba(249,115,22,0.4); }
        .home-cta:active { transform: translateY(0) scale(0.98); transition: 0.05s; }
        .suggest-box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 30px; text-align: left; }
        .suggest-input { width: 100%; padding: 10px 14px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; font-family: inherit; outline: none; margin-bottom: 10px; resize: vertical; }
        .suggest-input:focus { border-color: var(--accent); }
        .suggest-input::placeholder { color: var(--text-faint); }
        .suggest-submit { width: 100%; padding: 12px; background: var(--accent); color: #fff; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer; font-family: inherit; transition: 0.2s; }
        .suggest-submit:hover { filter: brightness(1.1); }
        .suggest-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        #suggestStatus { text-align: center; margin-top: 10px; font-size: 0.85rem; }

        .home-footer { margin-top: 30px; color: #334155; font-size: 0.85rem; }

        @media (max-width: 900px) {
            .home-title { font-size: 2.4rem; }
            .home-stats { gap: 24px; }
            .home-stat-num { font-size: 1.5rem; }
        }

        /* Lightbox */
        .lightbox { display: none; position: fixed; inset: 0; background: var(--overlay); z-index: 200; justify-content: center; align-items: center; cursor: zoom-out; }
        .lightbox.open { display: flex; }
        .lightbox img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        
        /* Mobile nav bar */
        .mobile-bar { display: none; }

        /* Mobile */
        /* Tablet breakpoint */
        @media (max-width: 1100px) and (min-width: 901px) {
            aside { width: 280px; }
            .hero { padding: 60px 40px 30px; }
            .messages { padding: 0 40px 80px; }
            .ch-btn { font-size: 0.85rem; padding: 9px 12px; }
        }

        /* Mobile breakpoint */
        @media (max-width: 900px) {
            aside { display: none; position: fixed; inset: 0; z-index: 100; width: 100%; max-width: 100%; }
            aside.open { display: flex; padding-bottom: 140px; }
            body { flex-direction: column; }
            main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-top: 54px; }
            .mobile-bar { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-side); border-bottom: 1px solid var(--border); flex-shrink: 0; position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
            .mobile-bar h2 { color: var(--accent); font-size: 0.85rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
            .mobile-bar button { background: none; border: 1px solid var(--border); color: var(--text-dim); padding: 8px 14px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit; -webkit-tap-highlight-color: transparent; touch-action: manipulation; transition: background 0.15s, color 0.15s, border-color 0.15s; }
            .mobile-bar button:active { background: rgba(249,115,22,0.15); color: var(--accent); border-color: var(--accent); }
            .mobile-close { display: flex !important; }
            .theme-toggle { position: absolute; top: 16px; right: 64px; z-index: 101; }
            #audioBtn { position: absolute; top: 16px; right: 108px; z-index: 101; }
            #volumeSlider { position: absolute; top: 24px; right: 152px; z-index: 101; width: 40px !important; }
            .hero { padding: 20px 16px 14px; }
            .hero h1 { font-size: 1.4rem; line-height: 1.3; }
            .hero .desc { font-size: 0.9rem; }
            .messages { padding: 0 16px 120px; }
            .msg { padding: 16px 0; }
            .msg-text { font-size: 0.95rem; line-height: 1.7; }
            .msg-img { max-width: 100%; height: auto; border-radius: 8px; }
            .msg-link { font-size: 0.85rem; }
            .share-bar { gap: 6px; }
            .share-btn { padding: 6px 10px; font-size: 0.75rem; }
            .back-to-top { bottom: 130px; right: 16px; left: auto; width: 40px; height: 40px; font-size: 1.1rem; }
            .scroll-to-bottom { bottom: 80px; right: 16px; left: auto; }
            .home-page { padding: 30px 16px; min-height: auto; }
            .home-title { font-size: 2rem; letter-spacing: -1px; }
            .home-subtitle { font-size: 1rem; margin-bottom: 24px; }
            .home-stats { gap: 12px; flex-wrap: wrap; }
            .home-stat-num { font-size: 1.3rem; }
            .home-stat-label { font-size: 0.7rem; }
            .home-credits { padding: 14px; }
            .home-credits p { font-size: 0.85rem; }
            .home-logos svg { width: 56px; height: 56px; }
            .channel-logos .channel-logo-img { width: 64px; height: 64px; }
            .channel-logos svg { width: 40px; height: 40px; }
            .daily-channel { padding: 14px; }
            .home-cta { padding: 16px 30px; font-size: 1.05rem; width: 100%; }
            .quest-start-btn { margin: 6px 10px; }
            .ch-btn { padding: 12px 14px; font-size: 0.9rem; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
            .cat-label { margin: 16px 0 6px 10px; }
            /* Quest modal mobile */
            #questInner { padding: 24px 18px; border-radius: 16px; }
            .quest-header h2 { font-size: 1.2rem; }
            .quest-q-text { font-size: 0.95rem; }
            .quest-opt { padding: 14px 16px; font-size: 0.9rem; }
            /* Guest points banner mobile */
            #guestPointsBanner { top: 56px !important; right: 8px !important; left: 8px !important; max-width: 100% !important; font-size: 0.8rem !important; padding: 8px 12px !important; border-radius: 10px !important; }
            /* Badge toast mobile */
            .badge-toast { bottom: 80px; left: 10px; right: 10px; }
            /* Lightbox mobile */
            .lightbox img { max-width: 95vw; max-height: 85vh; }
            /* YouTube embeds mobile */
            .yt-embed { max-width: 100%; }
            /* Twitter previews mobile */
            .tw-preview { padding: 12px 14px; }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .home-title { font-size: 1.5rem; }
            .home-subtitle { font-size: 0.9rem; }
            .home-stats { gap: 8px; }
            .home-stat-num { font-size: 1.1rem; }
            .mobile-bar h2 { font-size: 0.75rem; }
            .channel-logos .channel-logo-img { width: 54px; height: 54px; }
            .channel-logos svg { width: 34px; height: 34px; }
            .hero h1 { font-size: 1.2rem; }
            .msg-text { font-size: 0.9rem; }
            .home-cta { padding: 14px 20px; font-size: 0.95rem; }
        }
        /* Hide Google Translate bar */
        .goog-te-banner-frame { display: none !important; }
        body { top: 0 !important; }
        .skiptranslate { display: none !important; }
        #goog-gt-tt { display: none !important; }
    </style>
</head>
<body>
    <!-- Mobile top bar -->
    <div class="mobile-bar">
        <div onclick="goHome()" style="cursor:pointer;display:flex;align-items:center;gap:10px;">
            <svg viewBox="0 0 64 64" width="28" height="28" style="flex-shrink:0;"><circle cx="32" cy="32" r="30" fill="#f7931a"/><g transform="rotate(14,32,32)"><text x="32" y="44" text-anchor="middle" font-size="36" font-weight="bold" fill="#fff" font-family="Arial,sans-serif">B</text><line x1="28" y1="12" x2="28" y2="52" stroke="#fff" stroke-width="3"/><line x1="36" y1="12" x2="36" y2="52" stroke="#fff" stroke-width="3"/></g></svg>
            <h2 style="margin:0;line-height:1.2;">BITCOIN<br>EDUCATION ARCHIVE</h2>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
            <span id="mobileUserInfo" onclick="if(auth&&auth.currentUser&&!auth.currentUser.isAnonymous){showUsernamePrompt()}else{toggleMenu()}" style="font-size:0.75rem;color:var(--text-muted);cursor:pointer;display:none;"></span>
            <button onclick="toggleMenu()">‚ò∞ Menu</button>
        </div>
    </div>

    <aside id="sidebar">
        <button class="mobile-close" onclick="toggleMenu()">‚úï</button>
        <div class="sidebar-header">
            <div onclick="goHome()" style="cursor:pointer;display:flex;align-items:center;gap:10px;">
                <svg viewBox="0 0 64 64" width="28" height="28" style="flex-shrink:0;"><circle cx="32" cy="32" r="30" fill="#f7931a"/><g transform="rotate(14,32,32)"><text x="32" y="44" text-anchor="middle" font-size="36" font-weight="bold" fill="#fff" font-family="Arial,sans-serif">B</text><line x1="28" y1="12" x2="28" y2="52" stroke="#fff" stroke-width="3"/><line x1="36" y1="12" x2="36" y2="52" stroke="#fff" stroke-width="3"/></g></svg>
                <h2 style="margin:0;line-height:1.2;">BITCOIN<br>EDUCATION ARCHIVE</h2>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
                <button class="theme-toggle" onclick="toggleAudio()" title="Toggle sound" id="audioBtn" style="font-size:1rem;background:none;border:1px solid var(--border);color:var(--text-dim);width:32px;height:32px;border-radius:8px;cursor:pointer;">üîä</button>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.5" oninput="setVolume(this.value)" style="width:50px;height:4px;accent-color:#f7931a;cursor:pointer;" title="Volume">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode" id="themeBtn">üåô</button>
            </div>
        </div>
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç Search all channels..." oninput="doSearch(this.value)">
            <div style="display:flex;gap:8px;margin-top:8px;justify-content:center;">
                <button class="random-btn" onclick="goRandom()" title="Random Channel">üé≤</button>
                <button class="random-btn" onclick="goRandomArt()" title="Random Art">üé®</button>
                <button class="random-btn" onclick="goRandomMeme()" title="Random Meme">üòÇ</button>
            </div>
        </div>
        <div class="search-results" id="searchResults"></div>
        <div class="channels" id="channelList">
            <div id="favsSection" style="display:none;">
                <div class="cat-label">‚≠ê Your Saved Channels</div>
                <div id="favsList"></div>
            </div>
            <div class="cat-label cat-toggle" onclick="toggleCat(this)" data-expanded="true">Properties Layer 1 <span class="cat-arrow">‚ñº</span></div>
            <div class="cat-group">
            <button class="ch-btn active" onclick="go('whitepaper',this)">üìÑ whitepaper</button>
            <button class="ch-btn" onclick="go('decentralized',this)">üë™ decentralized-censorship-resistant</button>
            <button class="ch-btn" onclick="go('scarce',this)">üçÄ scarce-unforgeable</button>
            <button class="ch-btn" onclick="go('secure',this)">‚Ñ¢ secure-fungible</button>
            <button class="ch-btn" onclick="go('money',this)">üí∞ money-deflationary</button>
            <button class="ch-btn" onclick="go('peaceful',this)">‚òÆ peaceful-neutral</button>
            <button class="ch-btn" onclick="go('dominant',this)">üèÜ dominant-recognizable</button>
            <button class="ch-btn" onclick="go('organic',this)">üå≥ organic-empowering</button>
            <button class="ch-btn" onclick="go('supranational',this)">üïä supranational-lindy</button>
            <button class="ch-btn" onclick="go('programmable',this)">ü§ñ programable-interoperable</button>
            <button class="ch-btn" onclick="go('use-cases',this)">‚úî use-cases</button>

            </div>
            <div class="cat-label cat-toggle" onclick="toggleCat(this)" data-expanded="false">Experienced Topics <span class="cat-arrow">‚ñ∂</span></div>
            <div class="cat-group" style="display:none;">
            <button class="ch-btn" onclick="go('maximalism',this)">üíØ maximalism</button>
            <button class="ch-btn" onclick="go('problems-of-money',this)">üìâ problems-of-money</button>
            <button class="ch-btn" onclick="go('self-custody',this)">üîë self-custody-security</button>
            <button class="ch-btn" onclick="go('privacy-nonkyc',this)">ü§´ privacy-nonkyc</button>
            <button class="ch-btn" onclick="go('nodes',this)">üíª nodes</button>
            <button class="ch-btn" onclick="go('mining',this)">üåã mining</button>
            <button class="ch-btn" onclick="go('pow-vs-pos',this)">üí™ pow-vs-pos</button>
            <button class="ch-btn" onclick="go('energy',this)">üí° energy</button>
            <button class="ch-btn" onclick="go('difficulty-adjustment',this)">üò§ difficulty-adjustment</button>
            <button class="ch-btn" onclick="go('layer-2-lightning',this)">‚ö° layer-2-lightning</button>
            <button class="ch-btn" onclick="go('fedi-ark',this)">üõ° fedi-ark</button>
            <button class="ch-btn" onclick="go('chaumian-mints',this)">üí∏ chaumian-mints-ecash</button>
            <button class="ch-btn" onclick="go('ctv-covenants',this)">üìú ctv-bip119-covenants</button>
            <button class="ch-btn" onclick="go('extension-blocks',this)">üöß extension-blocks</button>
            <button class="ch-btn" onclick="go('op-codes',this)">üë®‚Äçüíª op-codes-simplicity</button>
            <button class="ch-btn" onclick="go('bitvm',this)">üñ• bitvm</button>
            <button class="ch-btn" onclick="go('layer-3-sidechains',this)">üì± layer-3-sidechains</button>
            <button class="ch-btn" onclick="go('stablecoins',this)">ü™ô stablecoins</button>
            <button class="ch-btn" onclick="go('smart-contracts',this)">üì± smart-contracts</button>
            <button class="ch-btn" onclick="go('blockchain-timechain',this)">‚õì blockchain-timechain</button>
            <button class="ch-btn" onclick="go('regulation',this)">üèõ regulation-policy</button>
            <button class="ch-btn" onclick="go('cryptography',this)">üîí cryptography-cypherpunks</button>
            <button class="ch-btn" onclick="go('core-source-code',this)">üíæ core-source-code</button>
            <button class="ch-btn" onclick="go('developers',this)">üñ• developers</button>
            <button class="ch-btn" onclick="go('investment-strategy',this)">ü§ë investment-strategy</button>
            <button class="ch-btn" onclick="go('evidence-against-alts',this)">‚ö† evidence-against-alts</button>
            <button class="ch-btn" onclick="go('consensus',this)">üåê consensus</button>

            </div>
            <div class="cat-label cat-toggle" onclick="toggleCat(this)" data-expanded="false">Resources <span class="cat-arrow">‚ñ∂</span></div>
            <div class="cat-group" style="display:none;">
            <button class="ch-btn" onclick="go('one-stop-shop',this)">üõë one-stop-shop</button>
            <button class="ch-btn" onclick="go('faq-glossary',this)">‚ùì faq-glossary</button>
            <button class="ch-btn" onclick="go('nostr',this)">üíú nostr</button>
            <button class="ch-btn" onclick="go('misconceptions-fud',this)">ü§° misconceptions-fud</button>
            <button class="ch-btn" onclick="go('books',this)">üìö books</button>
            <button class="ch-btn" onclick="go('videos',this)">üì∫ videos</button>
            <button class="ch-btn" onclick="go('podcasts',this)">üîä podcasts</button>
            <button class="ch-btn" onclick="go('articles-threads',this)">üìÉ articles-threads</button>
            <button class="ch-btn" onclick="go('informational-sites',this)">üìÉ informational-sites</button>
            <button class="ch-btn" onclick="go('curriculum',this)">üéì curriculum</button>
            <button class="ch-btn" onclick="go('research-theses',this)">‚úç research-theses</button>
            <button class="ch-btn" onclick="go('games',this)">üéÆ games</button>
            <button class="ch-btn" onclick="go('music',this)">üéµ music</button>
            <button class="ch-btn" onclick="go('movies-tv',this)">üé¨ movies-tv</button>
            <button class="ch-btn" onclick="go('hardware',this)">üíª hardware</button>
            <button class="ch-btn" onclick="go('poems-stories',this)">üìí poems-stories</button>
            <button class="ch-btn" onclick="go('apps-tools',this)">üçé apps-tools</button>
            <button class="ch-btn" onclick="go('projects-diy',this)">üîß projects-diy</button>
            <button class="ch-btn" onclick="go('art-inspiration',this)">ü§© art-inspiration</button>
            <button class="ch-btn" onclick="go('graphics',this)">üé® graphics</button>
            <button class="ch-btn" onclick="go('charts',this)">üìä charts</button>
            <button class="ch-btn" onclick="go('swag-merch',this)">üëï swag-merch</button>
            <button class="ch-btn" onclick="go('jobs-earn',this)">üë∑ jobs-earn</button>
            <button class="ch-btn" onclick="go('social-media',this)">üëç social-media</button>
            <button class="ch-btn" onclick="go('fun-facts',this)">üéâ fun-facts</button>
            <button class="ch-btn" onclick="go('news-adoption',this)">üì∞ news-adoption</button>
            <button class="ch-btn" onclick="go('history',this)">üìÜ history</button>
            <button class="ch-btn" onclick="go('international',this)">üåç international</button>
            <button class="ch-btn" onclick="go('satoshi-nakamoto',this)">ü¶∏ satoshi-nakamoto</button>
            <button class="ch-btn" onclick="go('giga-chad',this)">üëë giga-chad</button>
            <button class="ch-btn" onclick="go('health',this)">ü•© health</button>
            <button class="ch-btn" onclick="go('web5',this)">5‚É£ web5</button>
            <button class="ch-btn" onclick="go('memes-funny',this)">üòÇ memes-funny</button>

            </div>
            <div class="cat-label cat-toggle" onclick="toggleCat(this)" data-expanded="false">Additional Info <span class="cat-arrow">‚ñ∂</span></div>
            <div class="cat-group" style="display:none;">
            <button class="ch-btn" onclick="go('100_sats',this)">üíØ 100 Sats</button>
            <button class="ch-btn" onclick="go('analogies',this)">üîã Analogies</button>
            <button class="ch-btn" onclick="go('austrian_school_of_economics',this)">üá¶üáπ Austrian School</button>
            <button class="ch-btn" onclick="go('bip119',this)">üöß BIP119</button>
            <button class="ch-btn" onclick="go('bitcoin_exam',this)">üéì Bitcoin Exam</button>
            <button class="ch-btn" onclick="go('bitcoin_vs_real_estate',this)">üè† Bitcoin vs Real Estate</button>
            <button class="ch-btn" onclick="go('block_time-block-size',this)">‚è∞ Block Time-Block-Size</button>
            <button class="ch-btn" onclick="go('burn_bitcoin',this)">üî• Burn Bitcoin</button>
            <button class="ch-btn" onclick="go('byzantine_generals__problem',this)">‚öî Byzantine Generals</button>
            <button class="ch-btn" onclick="go('chaumian_e-cash_and_blind_signatures',this)">üí≤ Chaumian E-cash</button>
            <button class="ch-btn" onclick="go('coin_mixing_coinjoin_coin_control_utxo',this)">üåÄ Coin Mixing/Coinjoin</button>
            <button class="ch-btn" onclick="go('consensus',this)">ü§ù Consensus</button>
            <button class="ch-btn" onclick="go('cyles',this)">üö≤ Cycles</button>
            <button class="ch-btn" onclick="go('derivation_path',this)">‚Üï Derivation Path</button>
            <button class="ch-btn" onclick="go('discrete_log_contracts__dlcs',this)">üìù DLCs</button>
            <button class="ch-btn" onclick="go('dollar-bitcoin_milkshake_theory',this)">ü•§ Dollar-Bitcoin Milkshake Theory</button>
            <button class="ch-btn" onclick="go('dust',this)">‚è≥ Dust</button>
            <button class="ch-btn" onclick="go('elevator_pitches',this)">‚Üï Elevator Pitches</button>
            <button class="ch-btn" onclick="go('environment___energy',this)">üå≥ Environment & Energy</button>
            <button class="ch-btn" onclick="go('faith___religion',this)">üôè Faith & Religion</button>
            <button class="ch-btn" onclick="go('fedimints',this)">üíö Fedimints</button>
            <button class="ch-btn" onclick="go('feedback_loops',this)">‚û∞ Feedback Loops</button>
            <button class="ch-btn" onclick="go('1_first_principles',this)">1‚É£ First Principles</button>
            <button class="ch-btn" onclick="go('free_and_open_source_software__foss',this)">üíø FOSS</button>
            <button class="ch-btn" onclick="go('game_theory',this)">üèà Game Theory</button>
            <button class="ch-btn" onclick="go('geopolitics___macroeconomics',this)">üí∞ Geopolitics</button>
            <button class="ch-btn" onclick="go('governance',this)">üèõ Governance</button>
            <button class="ch-btn" onclick="go('ham_radio',this)">üìª Ham Radio</button>
            <button class="ch-btn" onclick="go('human_rights__social_justice_and_freedo',this)">üóΩ Human Rights</button>
            <button class="ch-btn" onclick="go('improved_incentive_structure',this)">‚úÖ Incentive Structure</button>
            <button class="ch-btn" onclick="go('laws_of_thermodynamics',this)">üî• Laws of Thermodynamics</button>
            <button class="ch-btn" onclick="go('lightning_node',this)">‚ö° Lightning Node</button>
            <button class="ch-btn" onclick="go('lindy_effect',this)">üë¥ Lindy Effect</button>
            <button class="ch-btn" onclick="go('market_cap',this)">üß¢ Market Cap</button>
            <button class="ch-btn" onclick="go('math',this)">‚ûï Math</button>
            <button class="ch-btn" onclick="go('mathematics',this)">‚ûï Mathematics</button>
            <button class="ch-btn" onclick="go('mev',this)">‚õè MEV</button>
            <button class="ch-btn" onclick="go('0_mining__hashing',this)">0‚É£ Mining (Hashing)</button>
            <button class="ch-btn" onclick="go('network_effects',this)">üåê Network Effects</button>
            <button class="ch-btn" onclick="go('open_source',this)">‚≠ï Open Source</button>
            <button class="ch-btn" onclick="go('oracle',this)">üîÆ Oracle</button>
            <button class="ch-btn" onclick="go('orange-pilling',this)">üü† Orange-Pilling</button>
            <button class="ch-btn" onclick="go('ordinals',this)">üî¢ Ordinals</button>
            <button class="ch-btn" onclick="go('ordinals__nfts_on_bitcoin__and_block_spa',this)">üî¢ Ordinals & Block Space</button>
            <button class="ch-btn" onclick="go('peace_and_anti-war',this)">‚òÆ Peace and Anti-War</button>
            <button class="ch-btn" onclick="go('philosophy',this)">üçé Philosophy</button>
            <button class="ch-btn" onclick="go('politics',this)">üèõ Politics</button>
            <button class="ch-btn" onclick="go('predictions',this)">üîÆ Predictions</button>
            <button class="ch-btn" onclick="go('public_key_vs_private_key',this)">üóù Public vs Private Key</button>
            <button class="ch-btn" onclick="go('rbf',this)">‚Üî RBF</button>
            <button class="ch-btn" onclick="go('risks__threats__attack_vectors__weaknes',this)">‚öî Risks & Threats</button>
            <button class="ch-btn" onclick="go('rollups',this)">ü•ê Rollups</button>
            <button class="ch-btn" onclick="go('sats__or__bits',this)">üí¨ Sats or Bits?</button>
            <button class="ch-btn" onclick="go('scalability',this)">üåê Scalability</button>
            <button class="ch-btn" onclick="go('sidechains',this)">‚ôª Sidechains</button>
            <button class="ch-btn" onclick="go('soft_vs_hard_forks',this)">üç¥ Soft vs Hard Forks</button>
            <button class="ch-btn" onclick="go('softwar',this)">üìñ Softwar</button>
            <button class="ch-btn" onclick="go('2__solved_technical_problems',this)">2‚É£ Solved Problems</button>
            <button class="ch-btn" onclick="go('simplified_payment_verification__spv',this)">‚úî SPV</button>
            <button class="ch-btn" onclick="go('stablecoins',this)">ü™ô Stablecoins</button>
            <button class="ch-btn" onclick="go('stratum_v2',this)">üü© Stratum V2</button>
            <button class="ch-btn" onclick="go('submarine_swap',this)">‚õµ Submarine Swap</button>
            <button class="ch-btn" onclick="go('swaps',this)">‚Üî Swaps</button>
            <button class="ch-btn" onclick="go('ta_tips',this)">üìà TA Tips</button>
            <button class="ch-btn" onclick="go('tail_emission',this)">üêà Tail Emission</button>
            <button class="ch-btn" onclick="go('taproot',this)">üß∞ Taproot</button>
            <button class="ch-btn" onclick="go('taro',this)">ü•ï Taro</button>
            <button class="ch-btn" onclick="go('the_future',this)">üîÆ The Future</button>
            <button class="ch-btn" onclick="go('time',this)">‚è∞ Time</button>
            <button class="ch-btn" onclick="go('time_preference',this)">üïë Time Preference</button>
            <button class="ch-btn" onclick="go('toxicity',this)">‚ò£ Toxicity</button>
            <button class="ch-btn" onclick="go('transaction_fees',this)">üí≤ Transaction Fees</button>
            <button class="ch-btn" onclick="go('unpopular_opinions',this)">üíÄ Unpopular Opinions</button>
            <button class="ch-btn" onclick="go('utxos',this)">üï≥ UTXOs</button>
            <button class="ch-btn" onclick="go('vbyte',this)">üèã vByte</button>

            </div>
            <div class="cat-label cat-toggle" onclick="toggleCat(this)" data-expanded="true">Referral Links <span class="cat-arrow">‚ñº</span></div>
            <div class="cat-group">
            <button class="ch-btn" onclick="go('referral-links',this)">üîó free-btc-referral-links</button>
            </div>
        </div>
        <button class="quest-start-btn" onclick="startQuestManual()">‚ö° Start a Quest</button>
        <button class="quest-start-btn" onclick="startScholarQuest()" style="background:var(--card-bg);border:2px solid #f7931a;color:var(--text);margin-top:4px;transition:0.2s;" onmouseover="this.style.background='linear-gradient(135deg,#f7931a,#ea580c)';this.style.color='#fff';this.style.boxShadow='0 0 20px rgba(247,147,26,0.4)';" onmouseout="this.style.background='var(--card-bg)';this.style.color='var(--text)';this.style.boxShadow='none';">üéì Bitcoin Scholar Certification Quest</button>
        <button class="quest-start-btn" style="background:none;border:2px solid var(--accent);color:var(--accent);margin-top:4px;font-weight:700;" onclick="go('forum')">üó£Ô∏è Community Forum</button>
        <button class="quest-start-btn" style="background:none;border:2px solid var(--accent);color:var(--accent);margin-top:4px;font-weight:700;" onclick="go('marketplace')">üõí Marketplace</button>
        <button class="quest-start-btn" style="background:linear-gradient(135deg,#f7931a,#ea580c);color:#fff;margin-top:4px;font-weight:700;border:none;box-shadow:0 4px 15px rgba(247,147,26,0.3);" onclick="if(typeof enterNachoMode==='function')enterNachoMode()">ü¶å Nacho Mode</button>
        <button id="supportBtn" class="quest-start-btn" style="background:none;border:1px solid var(--border);color:var(--text-muted);margin-top:4px;position:relative;" onclick="handleSupportClick()">üìß Support</button>
        <a href="https://603btc.com" target="_blank" class="sidebar-promo">‚ö° Powered by 603btc.com</a>
        <div id="rankBar"></div>
    </aside>
    <div class="progress-bar" id="progressBar"></div>
    <button class="back-to-top" id="backToTop" onclick="document.getElementById('main').scrollTo({top:0,behavior:'smooth'})">‚Üë</button>
    <button class="back-to-top scroll-to-bottom" id="scrollToBottom" onclick="var m=document.getElementById('main');m.scrollTo({top:m.scrollHeight,behavior:'smooth'})">‚Üì</button>
    <main id="main">
        <!-- Home / Landing -->
        <div id="home" class="home-page">
            <div class="home-inner">
                <div class="home-logos">
                    <img src="images/btc-grad-logo.jpg" alt="Bitcoin Education Archive" style="width:130px;height:130px;border-radius:50%;object-fit:cover;box-shadow:0 0 40px rgba(247,147,26,0.4);cursor:pointer;" onclick="goHome()" title="Home ‚Äî Long-press for Nacho Mode ü¶å">
                    <span class="donate-circle" onclick="showDonateModal()"><svg class="home-ln" viewBox="0 0 64 64" width="80" height="80" style="cursor:pointer;" title="Donate"><circle cx="32" cy="32" r="30" fill="#f7931a"/><polygon points="36,10 22,38 30,38 28,54 42,26 34,26" fill="#fff"/></svg></span>
                </div>
                <h1 class="home-title">Bitcoin Education Archive</h1>
                <p class="home-subtitle">A curated library of Bitcoin education ‚Äî complete with Quests to test your knowledge. Start your Quest today!</p>
                <div class="home-stats">
                    <div class="home-stat"><span class="home-stat-num">146</span><span class="home-stat-label">Channels</span></div>
                    <div class="home-stat"><span class="home-stat-num">8,800+</span><span class="home-stat-label">Messages</span></div>
                    <div class="home-stat"><span class="home-stat-num">3,000+</span><span class="home-stat-label">Images</span></div>
                    <div class="home-stat"><span class="home-stat-num" id="visitCount">‚Äî</span><span class="home-stat-label">Total Visits</span></div>
                </div>
                <div style="margin-top:16px;margin-bottom:8px;">
                    <button onclick="var msg=document.getElementById('contentNote');if(msg.style.display==='none'){msg.style.display='block';this.textContent='üìå A note about the content in our channels ‚ñ≤'}else{msg.style.display='none';this.textContent='üìå A note about the content in our channels ‚ñº'}" style="padding:10px 20px;background:none;border:1px solid var(--border);color:var(--text-muted);border-radius:10px;font-size:0.9rem;cursor:pointer;font-family:inherit;transition:0.2s;">üìå A note about the content in our channels ‚ñº</button>
                    <div id="contentNote" style="display:none;margin-top:12px;padding:16px 20px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:0.95rem;line-height:1.6;">
                        All YouTube links are embedded for you and contain videos that supplement the information in each channel. Additionally, channels are filled with tweets that were posted on Twitter over the last few years, and you can expand these tweets to view them in the channel.
                    </div>
                </div>
                <div id="giveawayBanner" style="margin-bottom:16px;padding:20px;background:linear-gradient(135deg,#f7931a 0%,#ea580c 100%);border-radius:16px;text-align:center;cursor:pointer;box-shadow:0 4px 20px rgba(247,147,26,0.3);position:relative;overflow:hidden;" onclick="showUsernamePrompt()">
                    <div style="position:absolute;top:-20px;right:-20px;font-size:5rem;opacity:0.15;pointer-events:none;">‚ö°</div>
                    <div style="font-size:1.8rem;margin-bottom:6px;">üéâ 25,000 SATS GIVEAWAY üéâ</div>
                    <div style="color:rgba(255,255,255,0.95);font-size:1rem;font-weight:600;">New users are entered for a chance to win!</div>
                    <div style="color:rgba(255,255,255,0.75);font-size:0.85rem;margin-top:6px;">Create an account & register below ‚¨áÔ∏è</div>
                    <div style="display:inline-block;margin-top:12px;padding:10px 24px;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.5);border-radius:10px;color:#fff;font-weight:700;font-size:0.95rem;letter-spacing:0.5px;">Sign Up Now ‚Üí</div>
                </div>
                <div id="dailySpinBanner" style="display:none;margin-bottom:16px;"></div>
                <div id="progressRings" style="margin-bottom:16px;"></div>
                <div id="dailyChallengeCard" style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px;"></div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
                    <button onclick="if(typeof showSpinWheel==='function')showSpinWheel()" style="padding:12px 4px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;touch-action:manipulation;-webkit-tap-highlight-color:rgba(247,147,26,0.2);"><span style="font-size:1.3rem;display:block;margin-bottom:2px;">üé°</span>Daily Spin</button>
                    <button onclick="if(typeof showPricePrediction==='function')showPricePrediction()" style="padding:12px 4px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;touch-action:manipulation;-webkit-tap-highlight-color:rgba(247,147,26,0.2);"><span style="font-size:1.3rem;display:block;margin-bottom:2px;">üìà</span>Predict Price</button>
                    <button onclick="if(typeof showNachoStory==='function')showNachoStory()" style="padding:12px 4px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;touch-action:manipulation;-webkit-tap-highlight-color:rgba(247,147,26,0.2);"><span style="font-size:1.3rem;display:block;margin-bottom:2px;">üìñ</span>Nacho Story</button>
                </div>
                <div id="continueReading" style="display:none;margin-bottom:16px;"></div>
                <div class="daily-channel" id="dailyChannel"></div>
                <div id="quoteOfDay" style="margin-top:16px;"></div>
                <div id="explorationMap" style="margin-top:16px;"></div>
                <div id="newbieBtnWrap" style="margin-top:24px;margin-bottom:0;">
                    <button id="newbieBtn" onclick="document.getElementById('newbieMsg').style.display='block';this.style.display='none';" style="padding:14px 32px;background:none;border:2px solid #22c55e;color:#22c55e;border-radius:12px;font-size:1.05rem;font-weight:700;cursor:pointer;font-family:inherit;transition:0.2s;width:100%;max-width:340px;" onmouseover="this.style.background='#22c55e';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='#22c55e'">üü¢ Brand new to Bitcoin?</button>
                    <div id="newbieMsg" style="display:none;margin-top:12px;padding:16px 20px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:0.95rem;line-height:1.5;">
                        We built a channel just for you. Visit <a href="#one-stop-shop" onclick="go('one-stop-shop');return false;" style="color:var(--accent);font-weight:700;text-decoration:underline;cursor:pointer;">one-stop-shop</a> to hit the highlights of Bitcoin.
                    </div>
                </div>
                <div id="welcomeBanner" style="display:none;margin-bottom:16px;padding:12px 20px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;text-align:center;cursor:pointer;" onclick="showUsernamePrompt()"></div>
                <div style="display:flex;flex-direction:column;align-items:center;gap:16px;margin-top:16px;margin-bottom:10px;">
                        <button class="home-cta" onclick="go('whitepaper')" style="margin-bottom:0;width:100%;max-width:340px;">Start Exploring ‚Üí</button>
                        <button id="authBtn" onclick="showUsernamePrompt()" style="display:block;padding:12px 30px;width:100%;max-width:340px;background:none;border:2px solid var(--accent);color:var(--accent);border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;transition:0.2s;touch-action:manipulation;" onmouseover="this.style.background='var(--accent)';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='var(--accent)'">Create Free Account / Sign In</button>
                        <button onclick="go('forum')" style="display:block;padding:12px 30px;width:100%;max-width:340px;background:none;border:2px solid var(--accent);color:var(--accent);border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;transition:0.2s;touch-action:manipulation;" onmouseover="this.style.background='var(--accent)';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='var(--accent)'">üó£Ô∏è Community Forum</button>
                        <button onclick="go('marketplace')" style="display:block;padding:12px 30px;width:100%;max-width:340px;background:none;border:2px solid var(--accent);color:var(--accent);border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;transition:0.2s;touch-action:manipulation;" onmouseover="this.style.background='var(--accent)';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='var(--accent)'">üõí Marketplace</button>
                        <button onclick="enterNachoMode()" style="display:block;padding:12px 30px;width:100%;max-width:340px;background:none;border:2px solid var(--accent);color:var(--accent);border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;transition:0.2s;touch-action:manipulation;" onmouseover="this.style.background='var(--accent)';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='var(--accent)'">ü¶å Nacho Mode</button>
                </div>
                <div style="margin-top:30px;padding:16px 20px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;">
                    <div style="font-size:1.2rem;margin-bottom:6px;">üë©‚Äçüéì</div>
                    <div style="color:var(--heading);font-weight:700;font-size:1rem;margin-bottom:4px;">Study with Flashcards</div>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:12px;">Prepare for Quests! Pick a topic and study with interactive flashcards.</p>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
                        <button onclick="startFlashcards('Bitcoin Basics')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">‚Çø Bitcoin Basics</button>
                        <button onclick="startFlashcards('Security & Storage')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üîë Security & Storage</button>
                        <button onclick="startFlashcards('Lightning Network')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">‚ö° Lightning Network</button>
                        <button onclick="startFlashcards('Mining & Energy')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">‚õèÔ∏è Mining & Energy</button>
                        <button onclick="startFlashcards('Economics & Money')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üí∞ Economics & Money</button>
                    </div>
                    <div id="moreFlashcards" style="display:none;margin-top:10px;">
                        <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
                            <button onclick="startFlashcards('Privacy & Sovereignty')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üïµÔ∏è Privacy & Sovereignty</button>
                            <button onclick="startFlashcards('History & Culture')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üìú History & Culture</button>
                            <button onclick="startFlashcards('Wallets & Tools')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üíº Wallets & Tools</button>
                            <button onclick="startFlashcards('Common Myths Debunked')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üö´ Common Myths Debunked</button>
                            <button onclick="startFlashcards('Technical Deep Dives')" style="padding:8px 16px;background:var(--bg-side);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üî¨ Technical Deep Dives</button>
                        </div>
                    </div>
                    <button id="expandFlashBtn" onclick="var m=document.getElementById('moreFlashcards');if(m.style.display==='none'){m.style.display='block';this.textContent='‚ñ≤ Show Less'}else{m.style.display='none';this.textContent='‚ñº Show More Topics'}" style="margin-top:10px;padding:6px 16px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-size:0.8rem;cursor:pointer;font-family:inherit;transition:0.2s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)'">‚ñº Show More Topics</button>
                </div>
                <div class="suggest-box" onclick="expandSuggest()" id="suggestBox" style="cursor:pointer;margin-top:30px;">
                    <h3 style="color:var(--heading);font-size:1rem;margin-bottom:8px;">üí° Suggest a Topic or Leave Feedback</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:0;">Want to see something added to the archive? Let us know!</p>
                    <div id="suggestFields" style="display:none;margin-top:12px;">
                        <input type="text" id="suggestName" placeholder="Your name (optional)" class="suggest-input" onclick="event.stopPropagation()">
                        <textarea id="suggestText" placeholder="What topic should we add? Or share your feedback!" class="suggest-input" rows="3" onclick="event.stopPropagation()"></textarea>
                        <button class="suggest-submit" onclick="event.stopPropagation();submitSuggestion()">Submit Suggestion</button>
                        <div id="suggestStatus"></div>
                    </div>
                </div>
                <div style="margin-top:20px;padding:20px;background:linear-gradient(135deg,rgba(247,147,26,0.05),rgba(247,147,26,0.02));border:2px dashed rgba(247,147,26,0.3);border-radius:12px;text-align:center;">
                    <div style="font-size:1.3rem;margin-bottom:6px;">üì£</div>
                    <div style="color:var(--heading);font-weight:700;font-size:1rem;margin-bottom:4px;">Sponsor This Space</div>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:12px;">Advertise your Bitcoin company here and reach thousands of Bitcoiners.</p>
                    <a href="mailto:info.603btc@gmail.com?subject=Sponsorship%20Inquiry%20-%20Bitcoin%20Education%20Archive" style="display:inline-block;padding:10px 24px;background:var(--accent);color:#fff;border-radius:10px;font-size:0.9rem;font-weight:700;text-decoration:none;font-family:inherit;">Inquire Now ‚Üí</a>
                    <div style="color:#fff;font-size:0.8rem;margin-top:8px;">info.603btc@gmail.com</div>
                </div>
                <div id="donateSection" style="margin-top:20px;padding:16px 20px;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;text-align:center;">
                    <div style="font-size:1.5rem;margin-bottom:6px;">‚ù§Ô∏è</div>
                    <div style="color:var(--heading);font-weight:700;font-size:1rem;margin-bottom:4px;">Support the Archive</div>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Donations are greatly appreciated and go towards site upkeep. Thank you for your support!</p>
                    <img src="donation-qr.jpg" alt="Bitcoin Donation QR Code" style="width:200px;height:auto;margin-bottom:12px;border:2px solid var(--border);border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.1);">
                    <div style="color:var(--accent);font-weight:600;font-size:0.95rem;margin-bottom:8px;">spontaneousleopard54@zeuspay.com</div>
                    <p style="color:var(--text-faint);font-size:0.85rem;margin-bottom:0;">‚ö†Ô∏è Donations are non-refundable</p>
                </div>
                <div class="home-credits">
                    <p><strong>Lead Curator:</strong> Pleb "<a href="https://x.com/NEEDcreations" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;">NEEDcreations</a>" Phil</p>
                    <p><strong>Other Contributors:</strong> Hundreds of Bitcoiners from Bitcoin Twitter, Bitcoin X, and the Bitcoin Education Discord community</p>
                </div>
                <p class="home-footer">Open source ¬∑ Free forever ¬∑ Built on GitHub Pages<br><a href="/privacy.html" style="color:var(--text-faint);font-size:0.75rem;">Privacy Policy</a> ¬∑ <a href="/terms.html" style="color:var(--text-faint);font-size:0.75rem;">Terms of Service</a></p>
            </div>
        </div>
        <div class="hero" id="hero"></div>
        <div class="messages" id="msgs"></div>
        <div id="forumContainer" style="display:none;"></div>
    </main>
    <div class="lightbox" id="lb" onclick="this.classList.remove('open')"><img id="lb-img"></div>
    <div id="questModal" onclick="if(event.target===this)closeQuest()"><div id="questInner"></div></div>
    <button id="lbFloatBtn" onclick="toggleLeaderboard()" style="position:fixed;bottom:20px;right:20px;z-index:140;background:var(--accent);color:#fff;border:none;border-radius:14px;padding:12px 18px;font-size:0.9rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;align-items:center;gap:6px;transition:0.2s;">üèÜ Leaderboard</button>
    <div id="leaderboard"></div>
    <div id="usernameModal" onclick="if(event.target===this)hideUsernamePrompt()">
        <div class="username-box">
            <h2>‚ö° Join the Leaderboard</h2>
            <p>Pick a username to start earning points as you explore the archive!</p>
            <input type="text" id="usernameInput" placeholder="Enter a username..." maxlength="20" onkeydown="if(event.key==='Enter')submitUsername()">
            <input type="email" id="emailInput" placeholder="üìß Email (optional)" style="margin-top:0;">
            <p style="color:#475569;font-size:0.75rem;margin:-8px 0 16px;">We'll never spam you. Only used if we launch future Bitcoin education updates.</p>
            <div id="giveawaySection" style="background:linear-gradient(135deg,rgba(247,147,26,0.1),rgba(234,88,12,0.05));border:1px solid rgba(247,147,26,0.3);border-radius:12px;padding:14px;margin-bottom:16px;text-align:left;">
                <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;margin-bottom:10px;">
                    <input type="checkbox" id="giveawayCheckbox" style="width:20px;height:20px;accent-color:#f7931a;margin-top:2px;flex-shrink:0;cursor:pointer;">
                    <span style="color:var(--text);font-size:0.9rem;font-weight:600;line-height:1.4;">üéâ Register for the <span style="color:#f7931a;">25,000 sats giveaway!</span></span>
                </label>
                <input type="text" id="giveawayLnAddress" placeholder="‚ö° Lightning address (e.g. you@walletofsatoshi.com)" style="width:100%;padding:12px 14px;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;font-family:inherit;outline:none;display:none;" oninput="this.style.borderColor='var(--border)'">
                <p id="giveawayNote" style="color:var(--text-faint);font-size:0.7rem;margin:6px 0 0;display:none;">Enter a Lightning address so we can send you the sats if you win! üèÜ</p>
            </div>
            <script>
                document.getElementById('giveawayCheckbox').addEventListener('change', function() {
                    document.getElementById('giveawayLnAddress').style.display = this.checked ? 'block' : 'none';
                    document.getElementById('giveawayNote').style.display = this.checked ? 'block' : 'none';
                });
            </script>
            <button onclick="submitUsername()">Start Learning ‚Üí</button>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
                <p style="color:var(--text-faint);font-size:0.75rem;margin-bottom:8px;">Or sign in to sync across devices:</p>
                <button onclick="signInWithGoogle()" style="width:100%;padding:12px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;transition:0.2s;margin-bottom:6px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18"> Sign in with Google
                </button>
                <button onclick="signInWithTwitter()" style="width:100%;padding:12px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;transition:0.2s;margin-bottom:6px;">
                    ùïè Sign in with Twitter/X
                </button>
                <button onclick="signInWithGithub()" style="width:100%;padding:12px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;transition:0.2s;margin-bottom:6px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/github.svg" width="18" height="18"> Sign in with GitHub
                </button>
                <button onclick="signInWithFacebook()" style="width:100%;padding:12px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:0.9rem;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;transition:0.2s;margin-bottom:6px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/facebook.svg" width="18" height="18"> Sign in with Facebook
                </button>
<!-- Apple sign-in removed -->
            </div>
            <span class="skip" onclick="hideUsernamePrompt()">Skip for now</span>
        </div>
    </div>

    <script src="channel_index.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer integrity="sha384-ajMUFBUFMCyjh8uxJg6bkGcKe9RTolyjwbxB3yES0QQMenP3Oztj/W9vA2SJPcIh" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" defer integrity="sha384-xD1t9dGSVKobUztxDkv6xUI0H4AnFz0NxwlgDJJ7FDlblG9xxr1Z9iauCZuJYj6p" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer integrity="sha384-XMIl1b2Ez9tKAM0R5q67/iLdfnlLBl9kfo40X5WMtCPb+3OLplrjnOxZTYCg1SKY" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js" defer integrity="sha384-G+YlsltNcQL59QCo5N1zoQkhGqujKRb2RBu6JuFYNU/ZjoPfdw1Ckm7M6wgDW3eR" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js" defer integrity="sha384-Cn425IPPqYFT0+lUg71+39dOh8zj/Ebpl97FkjUqrd+P37HLlysOYDvdw+N7tPuj" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js" defer></script>
    <script src="ranking.js?v=31" defer></script>
    <script src="quests.js" defer></script>
    <script src="scholar.js" defer></script>
    <script src="features.js" defer></script>
    <script src="badges.js" defer></script>
    <script src="tickets.js" defer></script>
    <script src="nacho.js?v=12" defer></script>
    <script src="nacho-live.js?v=7" defer></script>
    <script src="nacho-engage.js?v=6" defer></script>
    <script src="nacho-qa.js?v=16" defer></script>
    <script src="nacho-closet.js?v=8" defer></script>
    <script src="forum.js?v=8" defer></script>
    <script src="engagement.js?v=6" defer></script>
    <script src="marketplace.js?v=6" defer></script>
    <script src="mobile-ux.js?v=7" defer></script>
    <script>
    function openImg(src) {
        document.getElementById('lb-img').src = src;
        document.getElementById('lb').classList.add('open');
    }

    function isMobile() { return window.innerWidth <= 900; }

    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') !== 'light';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('btc_theme', isDark ? 'light' : 'dark');
    }
    // Restore saved theme
    (function() {
        const saved = localStorage.getItem('btc_theme');
        if (saved === 'light') {
            document.body.setAttribute('data-theme', 'light');
            setTimeout(() => { const b = document.getElementById('themeBtn'); if(b) b.textContent = '‚òÄÔ∏è'; }, 0);
        }
        // Set audio state
        setTimeout(() => { updateAudioUI(); }, 0);
    })();

    function setFloatingElementsVisible(visible) {
        var ids = ['nacho-container','nacho-toggle','lbFloatBtn','floatingRandomBtn','userDisplay','backToTop','scrollToBottom'];
        ids.forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.style.display = visible ? '' : 'none';
        });
    }

    function toggleMenu() {
        var sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('open');
        // Hide floating elements when sidebar is open on mobile (they block scrolling)
        setFloatingElementsVisible(!sidebar.classList.contains('open'));
    }

    function toggleCat(label) {
        var group = label.nextElementSibling;
        var arrow = label.querySelector('.cat-arrow');
        var expanded = label.getAttribute('data-expanded') === 'true';
        if (expanded) {
            group.style.display = 'none';
            label.setAttribute('data-expanded', 'false');
            if (arrow) arrow.textContent = '‚ñ∂';
        } else {
            group.style.display = '';
            label.setAttribute('data-expanded', 'true');
            if (arrow) arrow.textContent = '‚ñº';
        }
    }

    // Auto-expand the section when navigating to a channel
    function expandCatForChannel(btn) {
        if (!btn) return;
        var group = btn.closest('.cat-group');
        if (group && group.style.display === 'none') {
            var label = group.previousElementSibling;
            if (label && label.classList.contains('cat-toggle')) {
                group.style.display = '';
                label.setAttribute('data-expanded', 'true');
                var arrow = label.querySelector('.cat-arrow');
                if (arrow) arrow.textContent = '‚ñº';
            }
        }
    }

    function getFavs() { return JSON.parse(localStorage.getItem('btc_favs') || '[]'); }
    function setFavs(f) { localStorage.setItem('btc_favs', JSON.stringify(f)); renderFavs(); }

    function toggleFav(id, btn) {
        let favs = getFavs();
        if (favs.includes(id)) {
            favs = favs.filter(f => f !== id);
            if (btn) btn.innerHTML = '‚òÜ Save';
        } else {
            favs.push(id);
            if (btn) btn.innerHTML = '‚≠ê Saved';
            // Track for daily challenge
            sessionStorage.setItem('btc_fav_added', 'true');
        }
        setFavs(favs);
        // Sync to Firebase
        if (typeof syncFavsToFirebase === 'function') syncFavsToFirebase();
    }

    function renderFavs() {
        const favs = getFavs();
        const section = document.getElementById('favsSection');
        const list = document.getElementById('favsList');
        if (favs.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';
        list.innerHTML = favs.map(id => {
            const meta = CHANNELS[id];
            if (!meta) return '';
            const short = meta.title.length > 28 ? meta.title.substring(0, 28) + '...' : meta.title;
            return '<button class="ch-btn" onclick="go(\'' + id + '\',this)">‚≠ê ' + short + '</button>';
        }).join('');
    }

    let galleryMode = false;
    let currentChannelData = null;
    let currentChannelId = null;

    function toggleGallery(id) {
        galleryMode = !galleryMode;
        const btn = document.getElementById('galleryBtn');
        if (btn) {
            btn.classList.toggle('active', galleryMode);
            btn.textContent = galleryMode ? 'üìÑ List View' : 'üñºÔ∏è Gallery View';
        }
        renderContent(id);
    }

    function renderContent(id) {
        const d = currentChannelData;
        if (!d) return;
        const msgsEl = document.getElementById('msgs');

        if (galleryMode) {
            // Collect all images
            let allImgs = [];
            d.msgs.forEach(m => {
                if (m.imgs) m.imgs.forEach(img => allImgs.push(img));
            });

            let html = '<div class="gallery-grid">';
            const PAGE = 100;
            const showing = allImgs.slice(0, PAGE);
            showing.forEach(img => {
                html += '<img src="' + img + '" onclick="openImg(this.src)" loading="lazy">';
            });
            html += '</div>';
            if (allImgs.length > PAGE) {
                window._galleryImgs = allImgs;
                window._galleryOffset = PAGE;
                html += '<button class="load-more-btn" id="loadMoreGallery" onclick="loadMoreGallery()">Load more (' + (allImgs.length - PAGE) + ' remaining)</button>';
            }
            msgsEl.innerHTML = html;
        } else {
            // Normal list view - re-render
            const PAGE_SIZE = 50;
            // Skip the first message since it's already shown in the hero description
            const allMsgs = d.msgs.length > 1 ? d.msgs.slice(1) : d.msgs;

            function renderBatch(startIdx) {
                const batch = allMsgs.slice(startIdx, startIdx + PAGE_SIZE);
                let html = '';
                batch.forEach((m, bi) => {
                    html += '<div class="msg" id="msg-' + (startIdx + bi) + '">';
                    if (m.text) {
                        let t = m.text;
                        // Embed YouTube videos ‚Äî extract them first, replace with placeholders
                        let ytEmbeds = [];
                        t = t.replace(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([\w-]+)(?:[&?][^\s]*)?/g, function(match, id) {
                            ytEmbeds.push(id);
                            return '%%YT' + (ytEmbeds.length - 1) + '%%';
                        });
                        t = t.replace(/(?:https?:\/\/)?youtu\.be\/([\w-]+)(?:\?[^\s]*)?/g, function(match, id) {
                            ytEmbeds.push(id);
                            return '%%YT' + (ytEmbeds.length - 1) + '%%';
                        });
                        // Extract Twitter/X links for click-to-embed
                        let twEmbeds = [];
                        t = t.replace(/(?:https?:\/\/)?(?:twitter\.com|x\.com)\/([\w]+)\/status\/(\d+)(?:[^\s]*)?/g, function(match) {
                            const url = match.startsWith('http') ? match : 'https://' + match;
                            twEmbeds.push(url);
                            return '%%TW' + (twEmbeds.length - 1) + '%%';
                        });
                        // Now linkify remaining URLs
                        t = t.replace(/(https?:\/\/[^\s<>"]+)/g, '<a class="msg-link" href="$1" target="_blank">$1</a>');
                        // Restore YouTube embeds
                        t = t.replace(/%%YT(\d+)%%/g, function(match, idx) {
                            return '<div class="yt-embed"><iframe src="https://www.youtube-nocookie.com/embed/' + ytEmbeds[parseInt(idx)] + '" frameborder="0" allowfullscreen loading="lazy"></iframe></div>';
                        });
                        // Restore Twitter embeds as click-to-load cards
                        t = t.replace(/%%TW(\d+)%%/g, function(match, idx) {
                            const twUrl = twEmbeds[parseInt(idx)];
                            const twId = 'tw_' + Math.random().toString(36).substr(2, 8);
                            const isMob = typeof isMobile === 'function' && isMobile();
                            const handle = twUrl.match(/(?:twitter\.com|x\.com)\/([\w]+)\//);
                            const displayHandle = handle ? '@' + handle[1] : twUrl.replace(/https?:\/\/(www\.)?/, '');
                            return '<div class="tw-preview" id="' + twId + '" onclick="loadTweetEmbed(\'' + twId + '\',\'' + twUrl.replace(/'/g, "\\'") + '\')">' +
                                '<div class="tw-preview-icon">ùïè</div>' +
                                '<div class="tw-preview-content">' +
                                '<div class="tw-preview-url">' + displayHandle + '</div>' +
                                '<div class="tw-preview-hint">' + (isMob ? '‚ñ∂ Tap to display tweet' : '‚ñ∂ Click to display tweet') + '</div>' +
                                '</div>' +
                                '<div class="tw-preview-arrow">‚Üí</div>' +
                                '</div>';
                        });
                        t = t.replace(/üü† (.+)/g, '<span class="orange-glow">$1</span>');
                        html += '<div class="msg-text">' + t + '</div>';
                    }
                    if (m.imgs) m.imgs.forEach(img => {
                        if (m.link) {
                            html += '<a href="' + m.link + '" target="_blank" style="display:block;"><img class="msg-img" src="' + img + '" loading="lazy" title="Click to open source"></a>';
                        } else {
                            html += '<img class="msg-img" src="' + img + '" onclick="openImg(this.src)" loading="lazy">';
                        }
                    });
                    html += '</div>';
                });
                return html;
            }

            let msgsHtml = renderBatch(0);
            if (allMsgs.length > PAGE_SIZE) {
                msgsHtml += '<button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreMsgs()">Load more (' + (allMsgs.length - PAGE_SIZE) + ' remaining)</button>';
            }
            msgsEl.innerHTML = msgsHtml;
            window._currentMsgs = allMsgs;
            window._currentOffset = PAGE_SIZE;
        }

        // Add Next + Random buttons at the bottom
        // Use sidebar order for navigation
        if (!window._sidebarOrder) {
            window._sidebarOrder = [...document.querySelectorAll('.ch-btn')].map(b => {
                const m = b.getAttribute('onclick').match(/go\('([^']+)'/);
                return m ? m[1] : null;
            }).filter(Boolean);
        }
        const channelKeys = window._sidebarOrder.length > 0 ? window._sidebarOrder : Object.keys(CHANNELS);
        const currentIdx = channelKeys.indexOf(id);
        const nextId = currentIdx < channelKeys.length - 1 ? channelKeys[currentIdx + 1] : channelKeys[0];
        const nextTitle = CHANNELS[nextId] ? CHANNELS[nextId].title : nextId;

        const prevId = currentIdx > 0 ? channelKeys[currentIdx - 1] : channelKeys[channelKeys.length - 1];
        const prevTitle = CHANNELS[prevId] ? CHANNELS[prevId].title : prevId;

        let navHtml = '<div style="display:flex;gap:12px;justify-content:center;align-items:center;padding:30px 0 40px;border-top:1px solid var(--border);margin-top:30px;flex-wrap:wrap;">';
        navHtml += '<button onclick="go(\'' + prevId + '\')" style="padding:12px 24px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;font-size:0.95rem;font-weight:700;cursor:pointer;font-family:inherit;color:var(--text);transition:0.2s;">‚Üê Back</button>';
        navHtml += '<button onclick="goRandom()" style="padding:12px 18px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;font-size:1.1rem;cursor:pointer;transition:0.2s;" title="Random Channel">üé≤</button>';
        navHtml += '<button onclick="goRandomArt()" style="padding:12px 18px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;font-size:1.1rem;cursor:pointer;transition:0.2s;" title="Random Art">üé®</button>';
        navHtml += '<button onclick="goRandomMeme()" style="padding:12px 18px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;font-size:1.1rem;cursor:pointer;transition:0.2s;" title="Random Meme">üòÇ</button>';
        navHtml += '<button onclick="go(\'' + nextId + '\')" style="padding:12px 24px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:0.95rem;font-weight:700;cursor:pointer;font-family:inherit;transition:0.2s;">Next ‚Üí</button>';
        navHtml += '</div>';
        navHtml += '<div style="text-align:center;padding-bottom:20px;">';
        navHtml += '<button onclick="if(typeof startQuestManual===\'function\')startQuestManual()" style="padding:10px 20px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--text-muted);font-size:0.85rem;cursor:pointer;font-family:inherit;transition:0.2s;">‚ö° Ready to test your knowledge? Start a Quest</button>';
        navHtml += '</div>';
        // Read Next suggestions
        if (typeof renderReadNext === 'function') {
            navHtml += renderReadNext(id);
        }
        msgsEl.innerHTML += navHtml;

        msgsEl.classList.add('fade-in');
    }

    // Twitter/X embed
    let twttrLoaded = false;
    function loadTweetEmbed(containerId, url) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '<div class="tw-loading">Loading tweet...</div>';

        if (!twttrLoaded) {
            const s = document.createElement('script');
            s.src = 'https://platform.twitter.com/widgets.js';
            s.async = true;
            s.onload = function() { twttrLoaded = true; embedTweet(containerId, url); };
            document.head.appendChild(s);
        } else {
            embedTweet(containerId, url);
        }
    }

    function embedTweet(containerId, url) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        if (window.twttr && window.twttr.widgets) {
            const match = url.match(/status\/(\d+)/);
            if (match) {
                const tweetDiv = document.createElement('div');
                container.appendChild(tweetDiv);
                twttr.widgets.createTweet(match[1], tweetDiv, {
                    theme: document.body.getAttribute('data-theme') === 'light' ? 'light' : 'dark',
                    align: 'center',
                    conversation: 'none',
                    width: 500
                }).then(function(el) {
                    if (!el) {
                        container.innerHTML = '<div class="tw-embedded"><div class="tw-header">ùïè</div><div class="tw-body"><a class="msg-link" href="' + url + '" target="_blank">View on X ‚Üí</a></div></div>';
                    }
                });
            }
        } else {
            container.innerHTML = '<div class="tw-embedded"><div class="tw-header">ùïè</div><div class="tw-body"><a class="msg-link" href="' + url + '" target="_blank">View on X ‚Üí</a></div></div>';
        }
    }

    async function goRandom() {
        window._keepFloatingBtn = true;
        const keys = Object.keys(CHANNELS);
        if (!window._randomChannelHistory) window._randomChannelHistory = [];
        var avail = keys.filter(function(k) { return window._randomChannelHistory.indexOf(k) === -1; });
        if (avail.length === 0) { window._randomChannelHistory.length = 0; avail = keys; }
        const randomId = avail[Math.floor(Math.random() * avail.length)];
        window._randomChannelHistory.push(randomId);
        if (window._randomChannelHistory.length > Math.floor(keys.length * 0.3)) window._randomChannelHistory.shift();
        await go(randomId);
        window._keepFloatingBtn = false;
        showFloatingBtn('__random__', 'üé≤', 'Next Random Channel');
    }

    async function goRandomFromChannel(channelId, emoji, label) {
        window._keepFloatingBtn = true;
        const meta = CHANNELS[channelId];
        if (!meta) { window._keepFloatingBtn = false; return; }
        let d;
        if (channelCache[channelId]) {
            d = channelCache[channelId];
        } else {
            try {
                const resp = await fetch(meta.file);
                d = await resp.json();
                channelCache[channelId] = d;
            } catch(e) { return; }
        }

        // Find all messages that have images (skip first which is hero desc)
        const allMsgs = d.msgs.length > 1 ? d.msgs.slice(1) : d.msgs;
        const imgMsgs = [];
        allMsgs.forEach((m, i) => { if (m.imgs && m.imgs.length > 0) imgMsgs.push(i); });
        if (imgMsgs.length === 0) return;

        // Anti-repeat: track recent picks per channel, avoid them
        if (!window._randomHistory) window._randomHistory = {};
        if (!window._randomHistory[channelId]) window._randomHistory[channelId] = [];
        var history = window._randomHistory[channelId];
        // Keep history to ~20% of pool so we cycle through most before repeating
        var maxHistory = Math.min(Math.floor(imgMsgs.length * 0.2), 50);
        var available = imgMsgs.filter(function(idx) { return history.indexOf(idx) === -1; });
        if (available.length === 0) { history.length = 0; available = imgMsgs; } // Reset if exhausted
        var randomIdx = available[Math.floor(Math.random() * available.length)];
        history.push(randomIdx);
        if (history.length > maxHistory) history.shift();
        await go(channelId);

        const PAGE_SIZE = 50;
        if (randomIdx >= PAGE_SIZE) {
            const loadBtn = document.getElementById('loadMoreBtn');
            while (window._currentOffset <= randomIdx && loadBtn && document.contains(loadBtn)) {
                window.loadMoreMsgs();
            }
        }

        setTimeout(function() {
            const el = document.getElementById('msg-' + randomIdx);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.transition = 'box-shadow 0.3s, border-color 0.3s';
                el.style.boxShadow = '0 0 20px rgba(247,147,26,0.4)';
                el.style.borderColor = '#f7931a';
                setTimeout(function() {
                    el.style.boxShadow = '';
                    el.style.borderColor = '';
                }, 2000);
                window._keepFloatingBtn = false;
                showFloatingBtn(channelId, emoji, label);
            }
        }, 300);
    }

    function goRandomMeme() { return goRandomFromChannel('memes-funny', 'üòÇ', 'Next Random Meme'); }
    function goRandomArt() { return goRandomFromChannel('art-inspiration', 'üé®', 'Next Random Art'); }

    function showFloatingBtn(channelId, emoji, label) {
        var btn = document.getElementById('floatingRandomBtn');
        if (!btn) {
            btn = document.createElement('button');
            btn.id = 'floatingRandomBtn';
            btn.style.cssText = 'position:fixed;bottom:140px;right:180px;z-index:150;padding:12px 20px;background:var(--accent);color:#fff;border:none;border-radius:12px;font-size:0.9rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(0,0,0,0.3);transition:0.2s;display:flex;align-items:center;gap:6px;';
            document.body.appendChild(btn);
        }
        btn.innerHTML = emoji + ' ' + label;
        btn.onclick = channelId === '__random__'
            ? function() { goRandom(); }
            : function() { goRandomFromChannel(channelId, emoji, label); };
        btn.style.display = 'flex';
        function hideOnNav() {
            btn.style.display = 'none';
            window.removeEventListener('popstate', hideOnNav);
        }
        window.addEventListener('popstate', hideOnNav, { once: true });
    }

    window.goRandomMeme = goRandomMeme;
    window.goRandomArt = goRandomArt;

    window.loadMoreGallery = function() {
        const imgs = window._galleryImgs;
        const offset = window._galleryOffset;
        const grid = document.querySelector('.gallery-grid');
        const btn = document.getElementById('loadMoreGallery');
        const next = imgs.slice(offset, offset + 100);

        next.forEach(img => {
            const el = document.createElement('img');
            el.src = img;
            el.loading = 'lazy';
            el.onclick = function() { openImg(this.src); };
            grid.appendChild(el);
        });

        window._galleryOffset = offset + 100;
        if (window._galleryOffset >= imgs.length) {
            btn.remove();
        } else {
            btn.textContent = 'Load more (' + (imgs.length - window._galleryOffset) + ' remaining)';
        }
    };

    function shareNostr(text, url) {
        const note = text + '\n\n' + url;
        // Copy to clipboard first
        navigator.clipboard.writeText(note).then(() => {
            showToast('üìã Note copied! Paste it in Primal to post.');
        }).catch(() => {});
        // Open Primal home where they can paste
        window.open('https://primal.net/home', '_blank');
    }

    window.showDonateModal = function() {
        var existing = document.getElementById('donateModal');
        if (existing) existing.remove();
        var modal = document.createElement('div');
        modal.id = 'donateModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);-webkit-overflow-scrolling:touch;overflow-y:auto;padding:20px;';
        var lnAddr = 'spontaneousleopard54@zeuspay.com';
        modal.innerHTML =
            '<div style="background:var(--bg-side,#1a1a2e);border:2px solid var(--accent,#f7931a);border-radius:16px;padding:24px 20px;max-width:340px;width:100%;text-align:center;position:relative;box-shadow:0 8px 40px rgba(0,0,0,0.5);margin:auto;">' +
                '<button onclick="document.getElementById(\'donateModal\').remove()" style="position:absolute;top:10px;right:12px;background:none;border:1px solid var(--border,#333);color:var(--text-muted,#888);width:32px;height:32px;border-radius:8px;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation;">‚úï</button>' +
                '<div style="font-size:2rem;margin-bottom:8px;">‚ö°</div>' +
                '<div style="color:var(--heading,#fff);font-weight:700;font-size:1.1rem;margin-bottom:4px;">Support the Archive</div>' +
                '<p style="color:var(--text-muted,#aaa);font-size:0.85rem;margin-bottom:14px;">Donations are greatly appreciated and go towards site upkeep. Thank you for your support!</p>' +
                '<img src="donation-qr.jpg" alt="Bitcoin Donation QR Code" style="max-width:180px;width:60%;height:auto;margin-bottom:12px;border:2px solid var(--border,#333);border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.2);">' +
                '<div style="margin-bottom:12px;">' +
                    '<div style="color:var(--accent,#f7931a);font-weight:600;font-size:0.8rem;word-break:break-all;margin-bottom:8px;">' + lnAddr + '</div>' +
                    '<button id="donateCopyBtn" style="padding:8px 20px;background:var(--accent-bg,rgba(247,147,26,0.1));border:1px solid var(--accent,#f7931a);border-radius:8px;color:var(--accent,#f7931a);font-size:0.85rem;font-weight:600;cursor:pointer;font-family:inherit;touch-action:manipulation;">üìã Copy Address</button>' +
                '</div>' +
                '<p style="color:var(--text-faint,#666);font-size:0.75rem;margin:0;">‚ö†Ô∏è Donations are non-refundable</p>' +
            '</div>';
        document.body.appendChild(modal);
        // Copy button handler (avoids inline this-binding issues on mobile)
        var copyBtn = document.getElementById('donateCopyBtn');
        if (copyBtn) {
            copyBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                var btn = this;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(lnAddr).then(function() {
                        btn.textContent = '‚úÖ Copied!';
                        setTimeout(function() { btn.textContent = 'üìã Copy Address'; }, 2000);
                    });
                } else {
                    // Fallback for older browsers
                    var ta = document.createElement('textarea');
                    ta.value = lnAddr; ta.style.position = 'fixed'; ta.style.opacity = '0';
                    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
                    document.body.removeChild(ta);
                    btn.textContent = '‚úÖ Copied!';
                    setTimeout(function() { btn.textContent = 'üìã Copy Address'; }, 2000);
                }
            });
        }
        modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
    };

    function copyLink(url, btn) {
        navigator.clipboard.writeText(url).then(() => {
            btn.classList.add('copied');
            btn.textContent = '‚úÖ Copied!';
            setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = 'üîó Copy Link'; }, 2000);
        });
    }

    // goRandom defined above with floating button support

    let supportRevealed = false;
    function handleSupportClick() {
        const btn = document.getElementById('supportBtn');
        if (!supportRevealed) {
            // First click: reveal email with flash animation
            supportRevealed = true;
            btn.style.transition = '0.3s';
            btn.style.background = 'var(--accent)';
            btn.style.color = '#fff';
            btn.style.borderColor = 'var(--accent)';
            btn.innerHTML = 'info.603btc.com@gmail.com <span style="font-size:0.7rem;opacity:0.8;margin-left:4px;">tap to copy</span>';
            setTimeout(function() {
                btn.style.background = 'var(--card-bg)';
                btn.style.color = 'var(--text)';
                btn.style.borderColor = 'var(--border)';
            }, 400);
        } else {
            // Second click: copy email and open mailto
            navigator.clipboard.writeText('info.603btc.com@gmail.com').then(function() {
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.color = '#22c55e';
                setTimeout(function() {
                    btn.innerHTML = 'info.603btc.com@gmail.com <span style="font-size:0.7rem;opacity:0.8;margin-left:4px;">tap to copy</span>';
                    btn.style.color = 'var(--text)';
                }, 1500);
            }).catch(function() {});
            window.location.href = 'mailto:info.603btc.com@gmail.com?subject=Support%20-%20Bitcoin%20Education%20Archive';
        }
    }

    // ---- NACHO MODE ----
    window._nachoMode = false;
    window._nachoModeEarnings = { points: 0, badges: [], interactions: 0 };

    window.enterNachoMode = function(fromPopState) {
        window._nachoMode = true;
        window._nachoBusy = true; // suppress ALL popups
        window._nachoModeEarnings = { points: 0, badges: [], interactions: 0 };
        window._nachoModeStartTime = Date.now();
        window._nachoModeTopics = []; // Track user questions for conversation quiz
        window._nachoConvoQuizOffered = false;

        // Hook into awardPoints to track earnings during Nacho Mode
        if (!window._nachoPointsHooked) {
            window._nachoPointsHooked = true;
            var _origAward = window.awardPoints;
            if (_origAward) {
                window.awardPoints = function(pts, reason) {
                    if (window._nachoMode && window._nachoModeEarnings) {
                        window._nachoModeEarnings.points += pts;
                    }
                    return _origAward.apply(this, arguments);
                };
            }
            // Hook into badge toast to track badge earns
            var _origToast = window.showToast;
            if (_origToast) {
                window.showToast = function(msg) {
                    if (window._nachoMode && window._nachoModeEarnings && typeof msg === 'string' && (msg.indexOf('badge') !== -1 || msg.indexOf('Badge') !== -1 || msg.indexOf('üèÖ') !== -1)) {
                        window._nachoModeEarnings.badges.push(msg);
                    }
                    return _origToast.apply(this, arguments);
                };
            }
        }

        // Push history state so browser back button returns to Nacho Mode
        if (!fromPopState) history.pushState({ nachoMode: true }, '', '#nacho');

        // Hide everything
        document.getElementById('home').classList.add('hidden');
        document.getElementById('hero').innerHTML = '';
        document.getElementById('msgs').innerHTML = '';
        document.querySelectorAll('aside, #rankBar, #lbFloatBtn, #floatingRandomBtn, #userDisplay, #backToTop, #scrollToBottom, #nacho-container, #nacho-toggle').forEach(function(el) {
            if (el) el.style.display = 'none';
        });
        // Hide mobile top bar in Nacho mode (fullscreen takeover)
        var mbar = document.querySelector('.mobile-bar');
        if (mbar) mbar.style.display = 'none';

        // Build Nacho Mode screen
        var main = document.getElementById('main');
        main.scrollTop = 0;

        var nachoSvg = typeof NACHO_SVG !== 'undefined' ? NACHO_SVG : 'ü¶å';
        var userName = (typeof currentUser !== 'undefined' && currentUser && currentUser.username) ? currentUser.username : '';
        var greeting = userName ? "Hey " + userName + "! Let's talk Bitcoin." : "Hey! Let's talk Bitcoin.";

        var hasSpeech = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
        var micHtml = hasSpeech ?
            '<button id="nachoModeMic" onclick="nachoModeVoice()" style="position:absolute;right:60px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:1.2rem;cursor:pointer;padding:4px;opacity:0.6;transition:0.2s;touch-action:manipulation;" title="Voice input">üéôÔ∏è</button>' : '';

        // Init chat history from localStorage
        window._nachoChatHistory = JSON.parse(localStorage.getItem('btc_nacho_chat') || '[]');
        window._nachoSentHistory = JSON.parse(localStorage.getItem('btc_nacho_sent') || '[]');
        window._nachoSentIdx = -1;

        var screen = document.createElement('div');
        screen.id = 'nachoModeScreen';
        screen.style.cssText = 'display:flex;flex-direction:column;height:100vh;animation:fadeSlideIn 0.4s ease-out;';
        screen.innerHTML =
            '<style>' +
                '@keyframes nachoModeBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }' +
                '@keyframes nachoModeTalk { 0%,100%{transform:scale(1)} 15%{transform:scale(1.03)} 30%{transform:scale(0.98)} 45%{transform:scale(1.02)} }' +
                '@keyframes nachoModeGlow { 0%,100%{filter:drop-shadow(0 0 20px rgba(247,147,26,0.4))} 50%{filter:drop-shadow(0 0 40px rgba(247,147,26,0.7))} }' +
                '@keyframes nachoCapeBlow { 0%,100%{transform:rotate(-5deg) skewX(-2deg)} 50%{transform:rotate(-12deg) skewX(-5deg)} }' +
                '@keyframes nmTitleGlow { 0%,100%{text-shadow:0 0 20px rgba(247,147,26,0.3),0 0 40px rgba(247,147,26,0.1)} 50%{text-shadow:0 0 30px rgba(247,147,26,0.6),0 0 60px rgba(247,147,26,0.2)} }' +
                '#nachoHeroAvatar { animation: nachoModeBounce 3s ease-in-out infinite, nachoModeGlow 4s ease-in-out infinite; transition: transform 0.3s; cursor:pointer; }' +
                '#nachoHeroAvatar.talking { animation: nachoModeTalk 0.5s ease-in-out infinite, nachoModeGlow 1s ease-in-out infinite; }' +
                '#nachoHeroAvatar:hover { transform: scale(1.08); }' +
                '#nachoModeChat { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:8px 16px 16px; scroll-behavior:smooth; }' +
                '#nachoModeChat::-webkit-scrollbar { width:4px; }' +
                '#nachoModeChat::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }' +
                '.nm-msg { margin-bottom:10px; max-width:500px; margin-left:auto; margin-right:auto; }' +
                '.nm-user { text-align:right; }' +
                '.nm-user span { background:var(--accent-bg,#2a1a00);border:1px solid var(--accent);padding:10px 14px;border-radius:16px 16px 4px 16px;display:inline-block;max-width:80%;color:var(--text);font-size:0.9rem;text-align:left;line-height:1.4; }' +
                '.nm-nacho { text-align:left; }' +
                '.nm-nacho span { background:var(--card-bg);border:1px solid var(--border);padding:10px 14px;border-radius:16px 16px 16px 4px;display:inline-block;max-width:80%;color:var(--text);font-size:0.9rem;line-height:1.5; }' +
                '.nm-time { font-size:0.65rem;color:var(--text-faint);margin-top:2px; }' +
                '.nm-nacho .nm-time { text-align:left; }' +
                '.nm-user .nm-time { text-align:right; }' +
                '@media(max-width:768px){.nm-hero-avatar{width:120px!important;height:120px!important;}.nm-hero-avatar img{width:120px!important;height:120px!important;}.nm-hero-cape{width:50px!important;height:65px!important;right:-10px!important;top:25px!important;}.nm-hero-title{font-size:1.8rem!important;letter-spacing:4px!important;}.nm-hero-bar{flex-wrap:wrap;gap:6px!important;}}' +
            '</style>' +
            /* ===== HERO SECTION ===== */
            '<div style="flex-shrink:0;background:linear-gradient(180deg,rgba(247,147,26,0.08) 0%,transparent 100%);border-bottom:1px solid var(--border);padding:16px 16px 12px;text-align:center;position:relative;">' +
                /* Top bar: back + tools */
                '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">' +
                    '<button onclick="exitNachoMode()" style="background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;padding:4px;touch-action:manipulation;" title="Back">‚Üê</button>' +
                    '<div id="nachoModePrice" style="color:var(--accent);font-size:0.8rem;font-weight:700;"></div>' +
                    '<div class="nm-hero-bar" style="display:flex;align-items:center;gap:12px;">' +
                        '<button id="nachoEli5Btn" onclick="toggleNachoEli5()" style="background:none;border:none;font-size:1.6rem;cursor:pointer;padding:6px;opacity:0.5;touch-action:manipulation;transition:0.2s;" title="Explain Like I\'m 5">üßí</button>' +
                        '<button onclick="nachoChatExport()" style="background:none;border:none;color:var(--text-muted);font-size:1.6rem;cursor:pointer;padding:6px;touch-action:manipulation;transition:0.2s;" title="Download chat">üíæ</button>' +
                        '<button onclick="nachoChatClear()" style="background:none;border:none;color:var(--text-muted);font-size:1.6rem;cursor:pointer;padding:6px;touch-action:manipulation;transition:0.2s;" title="Clear chat">üóëÔ∏è</button>' +
                        '<img src="images/btc-grad-logo.jpg" alt="Home" style="width:36px;height:36px;border-radius:50%;cursor:pointer;box-shadow:0 0 8px rgba(247,147,26,0.3);" onclick="exitNachoMode()" title="Go to Home">' +
                        '<span class="donate-circle" onclick="showDonateModal()"><svg viewBox="0 0 64 64" width="32" height="32" style="cursor:pointer;" title="Donate"><circle cx="32" cy="32" r="30" fill="#f7931a"/><polygon points="36,10 22,38 30,38 28,54 42,26 34,26" fill="#fff"/></svg></span>' +
                    '</div>' +
                '</div>' +
                /* Avatar with cape */
                '<div id="nachoHeroAvatar" class="nm-hero-avatar" style="position:relative;display:inline-block;width:160px;height:160px;margin:0 auto 8px;" onclick="nachoModeAvatarTap()">' +
                    '<img src="nacho-deer.svg" alt="Nacho" style="width:160px;height:160px;pointer-events:none;position:relative;z-index:2;">' +
                    /* Orange cape SVG */
                    '<svg class="nm-hero-cape" viewBox="0 0 80 100" style="position:absolute;right:-15px;top:30px;width:65px;height:80px;z-index:1;animation:nachoCapeBlow 3s ease-in-out infinite;" xmlns="http://www.w3.org/2000/svg">' +
                        '<defs><linearGradient id="capeGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f7931a;stop-opacity:1"/><stop offset="100%" style="stop-color:#e67e00;stop-opacity:0.9"/></linearGradient></defs>' +
                        '<path d="M10,5 Q15,0 25,3 L70,15 Q80,18 78,30 L72,85 Q70,95 60,92 L15,75 Q5,72 8,60 Z" fill="url(#capeGrad)" opacity="0.9"/>' +
                        '<path d="M15,10 Q20,6 28,8 L65,20 Q72,22 70,32 L66,78 Q64,86 56,84 L20,70 Q12,68 14,58 Z" fill="url(#capeGrad)" opacity="0.3"/>' +
                    '</svg>' +
                    '<div id="nachoModeOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:3;"></div>' +
                '</div>' +
                /* Title */
                '<div class="nm-hero-title" style="font-size:2.2rem;font-weight:900;letter-spacing:6px;color:var(--accent);text-transform:uppercase;animation:nmTitleGlow 4s ease-in-out infinite;margin-bottom:4px;">NACHO MODE</div>' +
                '<div id="nachoModeFriendship" style="color:var(--text-faint);font-size:0.75rem;"></div>' +
            '</div>' +
            /* ===== CHAT AREA ===== */
            '<div id="nachoModeChat" style="flex:1;"></div>' +
            /* Input bar */
            '<div style="flex-shrink:0;padding:12px 16px;border-top:1px solid var(--border);background:var(--bg-side,#0a0a0a);">' +
                '<div style="max-width:500px;margin:0 auto;position:relative;">' +
                    '<input type="text" id="nachoModeInput" placeholder="' + (hasSpeech ? 'Type or tap üéôÔ∏è to speak...' : 'Ask Nacho anything about Bitcoin...') + '" maxlength="500" style="width:100%;padding:12px ' + (hasSpeech ? '96px' : '56px') + ' 12px 16px;background:var(--input-bg,#111);border:1px solid var(--border,#333);border-radius:24px;color:var(--text,#eee);font-size:0.95rem;font-family:inherit;outline:none;box-sizing:border-box;" onkeydown="nachoModeKeydown(event)">' +
                    micHtml +
                    '<button onclick="nachoModeSend()" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);background:var(--accent);color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:1rem;cursor:pointer;font-family:inherit;touch-action:manipulation;display:flex;align-items:center;justify-content:center;">‚ñ∂</button>' +
                '</div>' +
            '</div>';

        main.appendChild(screen);

        // Render saved chat history
        nachoChatRender();
        updateNachoModeFriendship();

        // Set ELI5 button state
        var eli5Btn = document.getElementById('nachoEli5Btn');
        if (eli5Btn) eli5Btn.style.opacity = window._nachoEli5 ? '1' : '0.5';

        // Render equipped outfit on Nacho Mode avatar
        nachoModeRenderOutfit();

        // Fetch BTC price and start refresh timer
        setTimeout(fetchBtcPrice, 300);
        if (window._btcPriceTimer) clearInterval(window._btcPriceTimer);
        window._btcPriceTimer = setInterval(fetchBtcPrice, 60000);

        // Focus input
        setTimeout(function() {
            var inp = document.getElementById('nachoModeInput');
            if (inp) inp.focus();
        }, 300);
    };

    // Fallback reply when no scripts/AI available
    function nachoModeFallbackReply(q, reply) {
        if (typeof checkOffTopic === 'function') {
            var ot = checkOffTopic(q);
            if (ot) { reply(typeof personalize === 'function' ? personalize(ot) : ot, 'offtopic'); return; }
        }
        var ql = q.toLowerCase().trim();
        if (/^(hey|hi|hello|yo|sup|howdy|hola|what'?s up|how are you|how'?s it going|good morning|good evening|good afternoon|gm|greetings)$/i.test(ql) || /^(hey|hi|hello|yo) (nacho|there|buddy|friend|deer)/i.test(ql)) {
            var greetings = [
                "Hey there! ü¶å Doing great ‚Äî just hanging out waiting for someone to ask me about Bitcoin! What's on your mind?",
                "Hey hey! üß° Welcome! I'm Nacho, your Bitcoin buddy. What would you like to learn about today?",
                "Well hello! ü¶å Nice to see you. Ask me anything about Bitcoin ‚Äî I've got 146 channels of knowledge in these antlers!",
                "Hey! üëã I'm good, thanks for asking! Ready to talk Bitcoin whenever you are. What's on your mind?"
            ];
            reply(greetings[Math.floor(Math.random() * greetings.length)], 'offtopic');
            return;
        }
        if (typeof nachoTrackMiss === 'function') nachoTrackMiss(q);
        reply("Give me just a moment ‚Äî I'm loading up my Bitcoin knowledge! Try again in a few seconds. ü¶å", 'fallback');
    }

    // Keyboard handler: Enter=send, ArrowUp/Down=history
    window.nachoModeKeydown = function(e) {
        if (e.key === 'Enter') { nachoModeSend(); return; }
        var inp = document.getElementById('nachoModeInput');
        if (!inp) return;
        var hist = window._nachoSentHistory || [];
        if (e.key === 'ArrowUp') {
            if (hist.length === 0) return;
            if (window._nachoSentIdx === -1) window._nachoSentDraft = inp.value;
            window._nachoSentIdx = Math.min(window._nachoSentIdx + 1, hist.length - 1);
            inp.value = hist[hist.length - 1 - window._nachoSentIdx];
            e.preventDefault();
            setTimeout(function() { inp.setSelectionRange(inp.value.length, inp.value.length); }, 0);
        } else if (e.key === 'ArrowDown') {
            if (window._nachoSentIdx <= 0) { window._nachoSentIdx = -1; inp.value = window._nachoSentDraft || ''; return; }
            window._nachoSentIdx--;
            inp.value = hist[hist.length - 1 - window._nachoSentIdx];
            e.preventDefault();
        }
    };

    // Format time for chat bubbles
    function nmTime(ts) {
        if (!ts) return '';
        var d = new Date(ts);
        var h = d.getHours(); var m = d.getMinutes();
        var ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12; if (h === 0) h = 12;
        return h + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
    }

    // Daily Bitcoin facts ‚Äî rotates daily
    var NACHO_DAILY_FACTS = [
        "There will only ever be 21 million Bitcoin. No government, company, or person can change this. üîí",
        "The Bitcoin network has been running non-stop since January 3, 2009 ‚Äî over 99.98% uptime. No bank can say that! üè¶",
        "The first Bitcoin transaction was 10,000 BTC for two pizzas. Today that's worth hundreds of millions! üçï",
        "Bitcoin processes over $10 billion in transactions daily ‚Äî more than most countries' payment systems. üí∏",
        "Bitcoin mining now uses more renewable energy than almost any other industry ‚Äî over 50%! ‚ö°",
        "Satoshi Nakamoto's true identity remains unknown. They hold about 1 million BTC and have never spent any. üïµÔ∏è",
        "A 'satoshi' (sat) is the smallest unit of Bitcoin: 0.00000001 BTC. You don't need to buy a whole coin! ü™ô",
        "The Bitcoin Lightning Network can process millions of transactions per second ‚Äî faster than Visa! ‚ö°",
        "El Salvador became the first country to adopt Bitcoin as legal tender in September 2021. üá∏üáª",
        "Bitcoin's code is completely open source ‚Äî anyone can read, verify, and contribute to it. üìñ",
        "Every 4 years, Bitcoin's new supply gets cut in half. This is called the 'halving.' The next one is in 2028! üìâ",
        "There are more Bitcoin wallets than bank accounts in most countries. Over 100 million and growing! üìà",
        "Bitcoin can be sent anywhere in the world in minutes, 24/7, with no middleman. Try that on a Sunday with a bank! üåç",
        "The Genesis Block contains a hidden message: 'The Times 03/Jan/2009 Chancellor on brink of second bailout for banks.' üì∞",
        "About 20% of all Bitcoin is estimated to be permanently lost ‚Äî mostly from early users who lost their keys. üîë",
        "Bitcoin's difficulty adjustment is like a thermostat ‚Äî it automatically adapts every 2 weeks to keep blocks at ~10 minutes. ‚öôÔ∏è",
        "Running a Bitcoin node means YOU verify every transaction yourself. No trust required. Don't trust, verify! ‚úÖ",
        "The Lightning Network lets you send payments as small as 1 sat (~$0.0003). Try doing that with a credit card! üí≥",
        "Bitcoin has survived 400+ declared 'deaths' by media. It keeps coming back stronger every time. üí™",
        "Over 50 publicly traded companies now hold Bitcoin on their balance sheets, led by MicroStrategy. üè¢",
        "Bitcoin transactions are pseudonymous, not anonymous. Every transaction is recorded on the public blockchain forever. üîç",
        "The Bitcoin network is protected by more computing power than all the world's supercomputers combined. üñ•Ô∏è",
        "You can run a full Bitcoin node on a Raspberry Pi ‚Äî a $50 computer can verify the entire monetary system. ü•ß",
        "Bitcoin's inflation rate is currently lower than gold's. After the 2028 halving, it'll be even lower. ü•á",
        "Multisig wallets require multiple keys to spend Bitcoin ‚Äî like a safety deposit box that needs 2 of 3 keys. üóùÔ∏è",
        "Bitcoin doesn't care about borders, politics, or holidays. It works the same everywhere, always. üåê",
        "The last Bitcoin won't be mined until approximately the year 2140. We're still very early! ‚è∞",
        "Jack Dorsey, Elon Musk, and many tech leaders have publicly supported Bitcoin's vision. üöÄ",
        "A Bitcoin block is mined roughly every 10 minutes. That's about 144 blocks per day, every day, forever. ‚õèÔ∏è",
        "Nostr is a decentralized social protocol that many Bitcoiners are building on ‚Äî social media you can't be censored from. üì°",
    ];

    function getDailyFact() {
        var dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(),0,0)) / 86400000);
        return NACHO_DAILY_FACTS[dayOfYear % NACHO_DAILY_FACTS.length];
    }

    // Topic chips HTML
    function nachoTopicChips() {
        // Ordered to guide beginners: understand ‚Üí believe ‚Üí act
        var chips = [
            { emoji: 'üìò', label: 'What is Bitcoin?', q: 'What is Bitcoin and what problem does it solve?' },
            { emoji: 'üí∞', label: 'Why Bitcoin?', q: 'Why is Bitcoin better than regular money and why should I care?' },
            { emoji: 'üîí', label: '21 Million', q: 'Why is the 21 million cap important and why can\'t it be changed?' },
            { emoji: 'üõí', label: 'How to Buy', q: 'How do I buy my first Bitcoin and start stacking sats?' },
            { emoji: 'üîë', label: 'Self-Custody', q: 'What is self-custody and why is it the most important thing in Bitcoin?' },
            { emoji: '‚ö°', label: 'Lightning', q: 'What is the Lightning Network and how does it make Bitcoin faster?' },
            { emoji: 'ü™ô', label: 'Why Not Altcoins?', q: 'Why do Bitcoiners only focus on Bitcoin and not other cryptocurrencies?' },
            { emoji: 'üåç', label: 'Fix the World', q: 'How is Bitcoin actually changing the world for the better?' },
        ];
        var html = '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:400px;margin:0 auto;">';
        for (var i = 0; i < chips.length; i++) {
            html += '<button onclick="nachoModeChip(\'' + chips[i].q.replace(/'/g,"\\'") + '\')" style="padding:8px 14px;background:var(--card-bg);border:1px solid var(--border);border-radius:20px;color:var(--text);font-size:0.8rem;cursor:pointer;font-family:inherit;transition:0.2s;display:flex;align-items:center;gap:4px;touch-action:manipulation;" onmouseover="this.style.borderColor=\'var(--accent)\';this.style.background=\'var(--accent-bg)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.background=\'var(--card-bg)\'">' + chips[i].emoji + ' ' + chips[i].label + '</button>';
        }
        html += '</div>';
        return html;
    }

    // Chip click handler
    window.nachoModeChip = function(question) {
        var inp = document.getElementById('nachoModeInput');
        if (inp) { inp.value = question; nachoModeSend(); }
    };

    // Follow-up suggestions based on topic
    // Follow-up suggestions designed to guide users deeper into the Bitcoin rabbit hole
    // Strategy: every answer should nudge toward understanding WHY Bitcoin matters
    // Flow: curiosity ‚Üí understanding ‚Üí conviction ‚Üí action (self-custody, running a node)
    var NACHO_MODE_FOLLOWUPS = {
        // Beginner ‚Üí deepen understanding of WHY Bitcoin
        bitcoin: [
            'Why is Bitcoin better than regular money?',
            'What problem does Bitcoin actually solve?',
            'Why can\'t governments just ban Bitcoin?'
        ],
        // Money/economics ‚Üí understand the broken system Bitcoin fixes
        money: [
            'What is inflation doing to my savings?',
            'Why can\'t Bitcoin\'s supply be changed?',
            'What is the Cantillon Effect?'
        ],
        inflation: [
            'How does Bitcoin protect against inflation?',
            'Why is 21 million important?',
            'What happened to currencies that got printed too much?'
        ],
        // Mining ‚Üí understand security and decentralization
        mining: [
            'Why is proof of work important for security?',
            'Why can\'t Bitcoin be hacked?',
            'Is mining actually wasteful or is that FUD?'
        ],
        // Lightning ‚Üí understand scaling and daily use
        lightning: [
            'Can I actually buy coffee with Bitcoin?',
            'How fast are Lightning payments?',
            'Why is Lightning better than Visa?'
        ],
        // Wallets/security ‚Üí push toward self-custody (maxi behavior)
        wallet: [
            'Why is self-custody so important?',
            'What happens if an exchange goes bankrupt?',
            'What does "not your keys, not your coins" really mean?'
        ],
        seed: [
            'Why should I NEVER store my seed phrase digitally?',
            'What is the best way to backup a seed phrase?',
            'Why is self-custody the most important thing in Bitcoin?'
        ],
        // Halving ‚Üí understand scarcity and long-term value
        halving: [
            'Why does scarcity make Bitcoin valuable?',
            'Is it too late to buy Bitcoin?',
            'What happens when all 21 million are mined?'
        ],
        // Buying ‚Üí push toward stacking sats and self-custody
        buy: [
            'What is dollar cost averaging and why is it the best strategy?',
            'Should I move my Bitcoin off the exchange?',
            'Why do Bitcoiners say "stay humble, stack sats"?'
        ],
        price: [
            'Why shouldn\'t I worry about short-term price?',
            'What is low time preference?',
            'Why do Bitcoiners think in sats, not dollars?'
        ],
        // Security ‚Üí build conviction in Bitcoin\'s strength
        security: [
            'Has the Bitcoin network ever been hacked?',
            'What protects Bitcoin from quantum computers?',
            'Why is Bitcoin the most secure network on Earth?'
        ],
        // Privacy ‚Üí maxi values
        privacy: [
            'Why is financial privacy a human right?',
            'What is KYC and why do Bitcoiners avoid it?',
            'How can I buy Bitcoin more privately?'
        ],
        // Node ‚Üí ultimate maxi action
        node: [
            'Why does running a node make Bitcoin stronger?',
            'What does "don\'t trust, verify" actually mean?',
            'Can I run a Bitcoin node on a Raspberry Pi?'
        ],
        // Altcoins ‚Üí strengthen Bitcoin maximalist conviction
        altcoin: [
            'Why is Bitcoin the only truly decentralized cryptocurrency?',
            'What makes Bitcoin different from every other crypto?',
            'Why do all altcoins eventually fail against Bitcoin?'
        ],
        ethereum: [
            'Why is proof of stake inferior to proof of work?',
            'Can Ethereum really compete with Bitcoin?',
            'Why do Bitcoiners say "there is no second best"?'
        ],
        // Regulation ‚Üí understand Bitcoin\'s resilience
        regulation: [
            'Can any government actually stop Bitcoin?',
            'Why did El Salvador adopt Bitcoin?',
            'How does Bitcoin protect human rights?'
        ],
        // Energy ‚Üí debunk FUD
        energy: [
            'Does Bitcoin actually waste energy?',
            'How does Bitcoin mining help renewable energy?',
            'Why is energy use a feature, not a bug?'
        ],
        // Scams/FUD ‚Üí arm them against misinformation
        scam: [
            'What are the most common Bitcoin scams to avoid?',
            'Why do people say Bitcoin is dead when it keeps growing?',
            'How do I know what Bitcoin information to trust?'
        ],
        fud: [
            'What are the biggest misconceptions about Bitcoin?',
            'Why do banks and media attack Bitcoin?',
            'Is Bitcoin really used by criminals?'
        ],
        // History ‚Üí build appreciation for what Bitcoin is
        satoshi: [
            'Why is it important that Satoshi disappeared?',
            'What was the financial crisis that inspired Bitcoin?',
            'Why is Bitcoin\'s immaculate conception so rare?'
        ],
        // Layer 2
        layer: [
            'What is the Lightning Network and why does it matter?',
            'What are Fedimints and Cashu?',
            'How does Bitcoin scale without sacrificing decentralization?'
        ],
        // General fallback ‚Äî always push toward conviction
        general: [
            'Why do people who study Bitcoin the most become maximalists?',
            'What\'s the most important thing about Bitcoin that most people don\'t know?',
            'How is Bitcoin changing the world right now?'
        ],
    };

    function getFollowUps(question, answer) {
        var text = (question + ' ' + (answer || '')).toLowerCase();
        var suggestions = [];

        // Match topic-specific follow-ups
        for (var topic in NACHO_MODE_FOLLOWUPS) {
            if (topic !== 'general' && text.indexOf(topic) !== -1) {
                suggestions = suggestions.concat(NACHO_MODE_FOLLOWUPS[topic]);
            }
        }

        // If no topic matched, use general rabbit hole questions
        if (suggestions.length === 0) {
            suggestions = NACHO_MODE_FOLLOWUPS.general;
        }

        // Always try to include one "deeper" question to push the rabbit hole
        var deepQuestions = [
            'Why is Bitcoin the only cryptocurrency that matters?',
            'What would a world on a Bitcoin standard look like?',
            'Why do Bitcoiners say "fix the money, fix the world"?',
            'How does Bitcoin give power back to individuals?',
            'Why is self-custody the most revolutionary act?',
        ];

        // Dedupe and limit to 3
        var seen = {};
        var unique = [];
        var qLower = question.toLowerCase();
        for (var i = 0; i < suggestions.length; i++) {
            var s = suggestions[i];
            if (!seen[s] && s.toLowerCase() !== qLower) { seen[s] = true; unique.push(s); }
            if (unique.length >= 2) break;
        }

        // Add one deep rabbit hole question if we have room
        if (unique.length < 3) {
            var deep = deepQuestions[Math.floor(Math.random() * deepQuestions.length)];
            if (!seen[deep] && deep.toLowerCase() !== qLower) unique.push(deep);
        }

        return unique;
    }

    function followUpChipsHtml(followUps) {
        if (!followUps || followUps.length === 0) return '';
        var html = '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;">';
        for (var i = 0; i < followUps.length; i++) {
            html += '<button onclick="nachoModeChip(\'' + followUps[i].replace(/'/g, "\\'") + '\')" style="padding:5px 10px;background:none;border:1px solid var(--border);border-radius:14px;color:var(--text-muted);font-size:0.75rem;cursor:pointer;font-family:inherit;transition:0.2s;touch-action:manipulation;" onmouseover="this.style.borderColor=\'var(--accent)\';this.style.color=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.color=\'var(--text-muted)\'">üí¨ ' + followUps[i] + '</button>';
        }
        html += '</div>';
        return html;
    }

    // =============================================
    // üëï Nacho Mode Outfit Overlay
    // =============================================
    function nachoModeRenderOutfit() {
        var overlay = document.getElementById('nachoModeOverlay');
        if (!overlay) return;
        overlay.innerHTML = '';
        if (typeof getEquippedItem !== 'function') return;
        var item = getEquippedItem();
        if (!item) return;
        var emoji = item.hidden ? item.revealEmoji : item.emoji;
        var el = document.createElement('span');
        el.textContent = item.overlay && item.overlay.custom ? item.overlay.custom : emoji;
        el.style.cssText = 'position:absolute;font-size:2.5rem;pointer-events:none;';
        // Scale overlay position to the larger avatar
        if (item.overlay) {
            if (item.overlay.top) el.style.top = item.overlay.top;
            if (item.overlay.left) el.style.left = item.overlay.left;
            if (item.overlay.right) el.style.right = item.overlay.right;
            if (item.overlay.bottom) el.style.bottom = item.overlay.bottom;
            if (item.overlay.transform) el.style.transform = item.overlay.transform;
        }
        overlay.appendChild(el);
    }

    // =============================================
    // üßí ELI5 Mode (Explain Like I'm 5)
    // =============================================
    window._nachoEli5 = localStorage.getItem('btc_nacho_eli5') === 'true';

    window.toggleNachoEli5 = function() {
        window._nachoEli5 = !window._nachoEli5;
        localStorage.setItem('btc_nacho_eli5', window._nachoEli5 ? 'true' : 'false');
        var btn = document.getElementById('nachoEli5Btn');
        if (btn) {
            btn.style.opacity = window._nachoEli5 ? '1' : '0.5';
            btn.title = window._nachoEli5 ? 'ELI5 Mode ON ‚Äî Simple language' : 'Explain Like I\'m 5';
        }
        if (typeof showToast === 'function') showToast(window._nachoEli5 ? 'üßí ELI5 Mode ON ‚Äî Nacho will use simple language' : 'üßí ELI5 Mode OFF');
    };

    // =============================================
    // ‚Çø Live Bitcoin Price in Header
    // =============================================
    function fetchBtcPrice() {
        var el = document.getElementById('nachoModePrice');
        if (!el) return;
        fetch('https://mempool.space/api/v1/prices').then(function(r) { return r.json(); }).then(function(data) {
            if (data && data.USD) {
                el.textContent = '‚Çø $' + parseInt(data.USD).toLocaleString();
            }
        }).catch(function() {});
    }

    // =============================================
    // üì§ Share Answer
    // =============================================
    window.nachoShareAnswer = function(text) {
        var clean = text.replace(/<[^>]+>/g, '').replace(/ü¶å\s*/g, '');
        var shareText = 'ü¶å I learned this from Nacho at bitcoineducation.quest:\n\n' + clean.substring(0, 280);
        if (navigator.share) {
            navigator.share({ title: 'Bitcoin Fact from Nacho ü¶å', text: shareText, url: 'https://bitcoineducation.quest' }).catch(function() {});
        } else {
            // Fallback: copy to clipboard
            var ta = document.createElement('textarea');
            ta.value = shareText;
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch(e) {}
            document.body.removeChild(ta);
            if (typeof showToast === 'function') showToast('üìã Copied to clipboard!');
        }
    };

    // =============================================
    // üéâ Conversation Milestones
    // =============================================
    function checkNachoMilestone() {
        var interactions = parseInt(localStorage.getItem('btc_nacho_interactions') || '0');
        var milestones = { 10: 'beginner', 25: 'explorer', 50: 'apprentice', 100: 'scholar', 200: 'expert', 500: 'legend' };
        var shown = JSON.parse(localStorage.getItem('btc_nacho_milestones') || '[]');
        for (var count in milestones) {
            if (interactions >= parseInt(count) && shown.indexOf(count) === -1) {
                shown.push(count);
                localStorage.setItem('btc_nacho_milestones', JSON.stringify(shown));
                var msgs = {
                    10: "üéâ 10 questions! You're officially a Bitcoin Beginner! Keep going ‚Äî there's so much to learn! ü¶å",
                    25: "üéâ 25 questions! You've leveled up to Bitcoin Explorer! You're asking the right questions! üí™",
                    50: "üéâ 50 questions! Bitcoin Apprentice unlocked! You know more than most people already! üß†",
                    100: "üèÜ 100 questions! You're a Bitcoin Scholar now! Satoshi would be proud! üéì",
                    200: "üî• 200 questions! Bitcoin Expert status! You could probably teach ME a thing or two! ü¶åüí°",
                    500: "üëë 500 QUESTIONS! You are a Bitcoin LEGEND! There's nothing Nacho can't discuss with you now! ü¶åüèÜüî•"
                };
                return msgs[count] || null;
            }
        }
        return null;
    }

    // =============================================
    // üó∫Ô∏è Guided Learning Path
    // =============================================
    var NACHO_LEARNING_PATH = [
        { step: 1, emoji: 'üìò', title: 'What is Bitcoin?', q: 'What is Bitcoin and how does it work?' },
        { step: 2, emoji: 'üí°', title: 'Why Bitcoin Matters', q: 'Why is Bitcoin important? Why should I care?' },
        { step: 3, emoji: 'üìà', title: 'Bitcoin vs Money', q: 'How is Bitcoin different from regular money and gold?' },
        { step: 4, emoji: 'üõí', title: 'Buying Your First Bitcoin', q: 'How do I buy my first Bitcoin? Where do I start?' },
        { step: 5, emoji: 'üíº', title: 'Wallets & Storage', q: 'What Bitcoin wallet should I use? What are the types?' },
        { step: 6, emoji: 'üîë', title: 'Seed Phrases & Security', q: 'What is a seed phrase and how do I keep my Bitcoin safe?' },
        { step: 7, emoji: '‚ö°', title: 'Lightning Network', q: 'What is the Lightning Network and why does it matter?' },
        { step: 8, emoji: '‚õèÔ∏è', title: 'Mining & Proof of Work', q: 'How does Bitcoin mining work? What is proof of work?' },
        { step: 9, emoji: 'üèÉ', title: 'Running a Node', q: 'What is a Bitcoin node and should I run one?' },
        { step: 10, emoji: 'üîí', title: 'Privacy & KYC', q: 'How private is Bitcoin? What is KYC and why does it matter?' },
    ];

    window.nachoLearningPath = function() {
        var progress = parseInt(localStorage.getItem('btc_nacho_path_step') || '0');
        var chat = document.getElementById('nachoModeChat');
        if (!chat) return;

        var html = '<div style="font-weight:700;color:var(--heading);margin-bottom:6px;">üó∫Ô∏è Your Bitcoin Journey</div>' +
            '<div style="color:var(--text-muted);font-size:0.8rem;margin-bottom:12px;">' + Math.round(progress / NACHO_LEARNING_PATH.length * 100) + '% complete ‚Äî ' + progress + '/' + NACHO_LEARNING_PATH.length + ' topics</div>';

        // Progress bar
        html += '<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:8px;height:8px;margin-bottom:12px;overflow:hidden;">' +
            '<div style="background:var(--accent);height:100%;width:' + Math.round(progress / NACHO_LEARNING_PATH.length * 100) + '%;border-radius:8px;transition:0.3s;"></div></div>';

        for (var i = 0; i < NACHO_LEARNING_PATH.length; i++) {
            var step = NACHO_LEARNING_PATH[i];
            var done = i < progress;
            var current = i === progress;
            html += '<button onclick="nachoPathStep(' + i + ')" style="display:flex;align-items:center;gap:10px;width:100%;padding:10px;margin-bottom:6px;background:' + (current ? 'var(--accent-bg)' : 'var(--card-bg)') + ';border:1px solid ' + (current ? 'var(--accent)' : 'var(--border)') + ';border-radius:10px;cursor:pointer;font-family:inherit;text-align:left;transition:0.2s;touch-action:manipulation;">' +
                '<span style="font-size:1.2rem;flex-shrink:0;">' + (done ? '‚úÖ' : step.emoji) + '</span>' +
                '<div>' +
                    '<div style="color:' + (done ? 'var(--text-faint)' : 'var(--text)') + ';font-size:0.85rem;font-weight:' + (current ? '700' : '500') + ';' + (done ? 'text-decoration:line-through;' : '') + '">Step ' + step.step + ': ' + step.title + '</div>' +
                '</div>' +
                (current ? '<span style="margin-left:auto;color:var(--accent);font-size:0.7rem;font-weight:700;">NEXT ‚Üí</span>' : '') +
            '</button>';
        }

        if (progress >= NACHO_LEARNING_PATH.length) {
            html += '<div style="text-align:center;padding:12px;background:var(--accent-bg);border:1px solid var(--accent);border-radius:10px;margin-top:8px;">' +
                '<div style="font-size:1.5rem;margin-bottom:4px;">üéìü¶åüéâ</div>' +
                '<div style="color:var(--accent);font-weight:700;">Journey Complete!</div>' +
                '<div style="color:var(--text-muted);font-size:0.8rem;">You\'ve covered all the Bitcoin basics. You\'re officially not a normie anymore!</div></div>';
        }

        nachoChatAppend('nacho', '', html);
    };

    window.nachoPathStep = function(stepIdx) {
        var step = NACHO_LEARNING_PATH[stepIdx];
        if (!step) return;
        // Mark progress
        var progress = parseInt(localStorage.getItem('btc_nacho_path_step') || '0');
        if (stepIdx >= progress) {
            localStorage.setItem('btc_nacho_path_step', (stepIdx + 1).toString());
        }
        // Ask the question
        nachoModeChip(step.q);
    };

    // =============================================
    // üéÆ Quiz Me Button
    // =============================================
    window.nachoQuizMe = function(topic) {
        // Pull from existing quest questions if available
        if (typeof QUEST_QUESTIONS !== 'undefined' && QUEST_QUESTIONS.length > 0) {
            var filtered = topic ? QUEST_QUESTIONS.filter(function(q) {
                return q.category && q.category.toLowerCase().indexOf(topic.toLowerCase()) !== -1;
            }) : QUEST_QUESTIONS;
            if (filtered.length === 0) filtered = QUEST_QUESTIONS;
            var q = filtered[Math.floor(Math.random() * filtered.length)];
            var html = '<div style="font-weight:700;color:var(--heading);margin-bottom:8px;">üéÆ Quiz Time!</div>' +
                '<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;">' +
                '<div style="color:var(--text);font-size:0.9rem;margin-bottom:12px;">' + escapeHtml(q.question) + '</div>';
            var opts = q.options || [];
            for (var i = 0; i < opts.length; i++) {
                var isCorrect = i === q.answer;
                html += '<button onclick="nachoQuizAnswer(this,' + (isCorrect ? 'true' : 'false') + ')" style="display:block;width:100%;padding:8px 12px;margin-bottom:4px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;cursor:pointer;font-family:inherit;text-align:left;transition:0.2s;touch-action:manipulation;">' + escapeHtml(opts[i]) + '</button>';
            }
            html += '</div>';
            html += '<button onclick="nachoQuizMe()" style="padding:6px 14px;background:none;border:1px solid var(--border);border-radius:14px;color:var(--text-muted);font-size:0.75rem;cursor:pointer;font-family:inherit;touch-action:manipulation;">üéÆ Another question</button>';
            nachoChatAppend('nacho', '', html);
        } else {
            nachoChatAppend('nacho', '', "Quiz questions are still loading! Try again in a moment. ü¶å");
        }
    };

    window.nachoQuizAnswer = function(btn, correct) {
        // Track for daily challenge
        sessionStorage.setItem('btc_quiz_done', 'true');
        // Disable all quiz buttons
        var parent = btn.parentElement;
        var buttons = parent.querySelectorAll('button');
        buttons.forEach(function(b) {
            b.disabled = true;
            b.style.cursor = 'default';
            b.style.opacity = '0.7';
        });
        if (correct) {
            btn.style.background = '#22c55e';
            btn.style.color = '#fff';
            btn.style.borderColor = '#22c55e';
            btn.style.opacity = '1';
            if (typeof awardPoints === 'function') awardPoints(5, 'üéÆ Quiz correct!');
            if (typeof showToast === 'function') showToast('üéÆ +5 pts ‚Äî Quiz correct!');
            // Add result text
            var resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'margin-top:8px;padding:8px;background:rgba(34,197,94,0.1);border:1px solid #22c55e;border-radius:8px;color:#22c55e;font-size:0.85rem;font-weight:700;text-align:center;';
            resultDiv.textContent = '‚úÖ Correct! +5 pts';
            btn.parentElement.appendChild(resultDiv);
        } else {
            btn.style.background = '#ef4444';
            btn.style.color = '#fff';
            btn.style.borderColor = '#ef4444';
            btn.style.opacity = '1';
            // Highlight correct answer
            buttons.forEach(function(b) {
                if (b !== btn && b.onclick && b.onclick.toString().indexOf('true') !== -1) {
                    b.style.background = '#22c55e';
                    b.style.color = '#fff';
                    b.style.borderColor = '#22c55e';
                    b.style.opacity = '1';
                }
            });
            var wrongDiv = document.createElement('div');
            wrongDiv.style.cssText = 'margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border:1px solid #ef4444;border-radius:8px;color:#ef4444;font-size:0.85rem;font-weight:700;text-align:center;';
            wrongDiv.textContent = '‚ùå Not quite! Correct answer highlighted above.';
            btn.parentElement.appendChild(wrongDiv);
        }
    };

    // Render full chat from history
    function nachoChatRender() {
        var chat = document.getElementById('nachoModeChat');
        if (!chat) return;
        var hist = window._nachoChatHistory || [];
        if (hist.length === 0) {
            // Show welcome with daily fact + topic chips
            var userName = (typeof currentUser !== 'undefined' && currentUser && currentUser.username) ? currentUser.username : '';
            chat.innerHTML =
                '<div style="text-align:center;padding:30px 20px;">' +
                    '<div id="nachoModeAvatar" style="width:160px;height:160px;margin:0 auto 16px;cursor:pointer;" onclick="nachoModeAvatarTap()"><img src="nacho-deer.svg" alt="Nacho" style="width:160px;height:160px;pointer-events:none;"></div>' +
                    '<div style="color:var(--accent);font-size:0.7rem;text-transform:uppercase;letter-spacing:2px;font-weight:800;margin-bottom:6px;">ü¶å NACHO MODE</div>' +
                    '<div style="color:var(--heading);font-size:1.2rem;font-weight:800;margin-bottom:12px;">' +
                        (userName ? 'Hey ' + escapeHtml(userName) + '! Let\'s talk Bitcoin.' : 'Hey! Let\'s talk Bitcoin.') +
                    '</div>' +
                    /* Daily fact */
                    '<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin:0 auto 20px;max-width:380px;text-align:left;">' +
                        '<div style="font-size:0.7rem;color:var(--accent);font-weight:700;margin-bottom:4px;">üí° DID YOU KNOW?</div>' +
                        '<div style="color:var(--text);font-size:0.85rem;line-height:1.5;">' + getDailyFact() + '</div>' +
                    '</div>' +
                    /* Topic chips */
                    '<div style="color:var(--text-muted);font-size:0.8rem;margin-bottom:12px;">Tap a topic or ask me anything:</div>' +
                    nachoTopicChips() +
                    /* Action buttons */
                    '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:16px;max-width:400px;margin-left:auto;margin-right:auto;">' +
                        '<button onclick="nachoLearningPath()" style="padding:8px 16px;background:var(--accent-bg);border:1px solid var(--accent);border-radius:20px;color:var(--accent);font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;touch-action:manipulation;">üó∫Ô∏è Start Bitcoin Journey</button>' +
                        '<button onclick="nachoQuizMe()" style="padding:8px 16px;background:var(--card-bg);border:1px solid var(--border);border-radius:20px;color:var(--text);font-size:0.8rem;cursor:pointer;font-family:inherit;touch-action:manipulation;">üéÆ Quiz Me</button>' +
                    '</div>' +
                '</div>';
            return;
        }
        var html = '';
        var lastDate = '';
        for (var i = 0; i < hist.length; i++) {
            var m = hist[i];
            // Date separator
            var msgDate = new Date(m.ts).toLocaleDateString();
            if (msgDate !== lastDate) {
                html += '<div style="text-align:center;margin:16px 0 8px;"><span style="background:var(--card-bg);border:1px solid var(--border);padding:4px 12px;border-radius:12px;font-size:0.7rem;color:var(--text-faint);">' + msgDate + '</span></div>';
                lastDate = msgDate;
            }
            if (m.role === 'user') {
                html += '<div class="nm-msg nm-user"><span>' + escapeHtml(m.text) + '</span><div class="nm-time">' + nmTime(m.ts) + '</div></div>';
            } else {
                html += '<div class="nm-msg nm-nacho"><span>ü¶å ' + m.html + '</span><div class="nm-time">' + nmTime(m.ts) + '</div></div>';
            }
        }
        chat.innerHTML = html;
        chat.scrollTop = chat.scrollHeight;
    }

    // Save chat to localStorage (keep last 100 messages)
    function nachoChatSave() {
        var hist = window._nachoChatHistory || [];
        if (hist.length > 100) hist = hist.slice(hist.length - 100);
        window._nachoChatHistory = hist;
        try { localStorage.setItem('btc_nacho_chat', JSON.stringify(hist)); } catch(e) {}
    }

    // Add message to chat
    function nachoChatAdd(role, text, html) {
        var msg = { role: role, text: text || '', html: html || escapeHtml(text || ''), ts: Date.now() };
        window._nachoChatHistory.push(msg);
        nachoChatSave();
        return msg;
    }

    // Show a message bubble and scroll
    function nachoChatAppend(role, text, html) {
        var chat = document.getElementById('nachoModeChat');
        if (!chat) return;
        // Clear welcome screen if first message
        if (window._nachoChatHistory.length <= 1 && chat.querySelector('#nachoModeAvatar')) {
            chat.innerHTML = '';
        }
        var ts = nmTime(Date.now());
        var div = document.createElement('div');
        div.className = 'nm-msg ' + (role === 'user' ? 'nm-user' : 'nm-nacho');
        if (role === 'user') {
            div.innerHTML = '<span>' + escapeHtml(text) + '</span><div class="nm-time">' + ts + '</div>';
        } else {
            div.innerHTML = '<span>ü¶å ' + html + '</span><div class="nm-time">' + ts + '</div>';
        }
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    // Show thinking indicator
    // ---- Conversation Quiz: generated from topics discussed ----
    function offerConversationQuiz() {
        if (!window._nachoMode) return;
        var topics = window._nachoModeTopics || [];
        if (topics.length < 3) return;

        // Build quiz from conversation history + QUEST_QUESTIONS
        var quizQuestions = [];
        if (typeof QUEST_QUESTIONS !== 'undefined' && QUEST_QUESTIONS.length > 0) {
            // Try to match questions to topics the user asked about
            for (var t = 0; t < topics.length && quizQuestions.length < 5; t++) {
                var topicWords = topics[t].toLowerCase().split(/\s+/);
                for (var qi = 0; qi < QUEST_QUESTIONS.length && quizQuestions.length < 5; qi++) {
                    var qq = QUEST_QUESTIONS[qi];
                    if (quizQuestions.indexOf(qq) !== -1) continue;
                    var qText = (qq.question + ' ' + (qq.category || '')).toLowerCase();
                    for (var w = 0; w < topicWords.length; w++) {
                        if (topicWords[w].length > 3 && qText.indexOf(topicWords[w]) !== -1) {
                            quizQuestions.push(qq);
                            break;
                        }
                    }
                }
            }
            // Fill remaining with random questions
            while (quizQuestions.length < 3) {
                var rq = QUEST_QUESTIONS[Math.floor(Math.random() * QUEST_QUESTIONS.length)];
                if (quizQuestions.indexOf(rq) === -1) quizQuestions.push(rq);
            }
        }

        if (quizQuestions.length === 0) return;

        // Offer the quiz
        var offerHtml = '<div style="background:linear-gradient(135deg,rgba(247,147,26,0.15),rgba(234,88,12,0.1));border:2px solid var(--accent);border-radius:14px;padding:16px;text-align:center;">' +
            '<div style="font-size:1.2rem;margin-bottom:4px;">üéØ</div>' +
            '<div style="font-weight:800;color:var(--heading);font-size:0.95rem;margin-bottom:4px;">Conversation Quest!</div>' +
            '<div style="color:var(--text-muted);font-size:0.8rem;margin-bottom:12px;">You\'ve been learning a lot! Let\'s see how much you remember from our chat.</div>' +
            '<div style="display:flex;gap:8px;justify-content:center;">' +
                '<button onclick="startConversationQuiz()" style="padding:10px 20px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:0.85rem;font-weight:700;cursor:pointer;font-family:inherit;">Let\'s go! ‚ö°</button>' +
                '<button onclick="this.parentElement.parentElement.style.opacity=\'0.4\';this.parentElement.parentElement.style.pointerEvents=\'none\'" style="padding:10px 16px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;color:var(--text-muted);font-size:0.85rem;cursor:pointer;font-family:inherit;">Maybe later</button>' +
            '</div></div>';
        nachoChatAppend('nacho', '', offerHtml);

        // Store quiz for when they accept
        window._convoQuizQuestions = quizQuestions;
    }

    window.startConversationQuiz = function() {
        var questions = window._convoQuizQuestions || [];
        if (questions.length === 0) return;
        window._convoQuizIdx = 0;
        window._convoQuizScore = 0;
        window._convoQuizTotal = Math.min(questions.length, 5);
        showConvoQuizQuestion();
    };

    function showConvoQuizQuestion() {
        var questions = window._convoQuizQuestions || [];
        var idx = window._convoQuizIdx || 0;
        if (idx >= window._convoQuizTotal || idx >= questions.length) {
            finishConvoQuiz();
            return;
        }
        var q = questions[idx];
        var html = '<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:14px;">' +
            '<div style="font-size:0.7rem;color:var(--accent);font-weight:700;margin-bottom:6px;">Question ' + (idx + 1) + ' of ' + window._convoQuizTotal + '</div>' +
            '<div style="color:var(--text);font-size:0.85rem;margin-bottom:10px;font-weight:600;">' + escapeHtml(q.question) + '</div>';
        var opts = q.options || [];
        for (var i = 0; i < opts.length; i++) {
            var isCorrect = i === q.answer;
            html += '<button onclick="convoQuizAnswer(this,' + isCorrect + ')" style="display:block;width:100%;padding:8px 12px;margin-bottom:4px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.8rem;cursor:pointer;font-family:inherit;text-align:left;transition:0.2s;touch-action:manipulation;">' + escapeHtml(opts[i]) + '</button>';
        }
        html += '</div>';
        nachoChatAppend('nacho', '', html);
    }

    window.convoQuizAnswer = function(btn, correct) {
        var parent = btn.parentElement;
        var buttons = parent.querySelectorAll('button');
        buttons.forEach(function(b) {
            b.disabled = true;
            b.style.cursor = 'default';
            b.style.opacity = '0.6';
        });

        if (correct) {
            btn.style.background = '#22c55e';
            btn.style.color = '#fff';
            btn.style.borderColor = '#22c55e';
            btn.style.opacity = '1';
            window._convoQuizScore = (window._convoQuizScore || 0) + 1;
            var correctDiv = document.createElement('div');
            correctDiv.style.cssText = 'margin-top:6px;color:#22c55e;font-size:0.8rem;font-weight:700;';
            correctDiv.textContent = '‚úÖ Correct!';
            parent.appendChild(correctDiv);
        } else {
            btn.style.background = '#ef4444';
            btn.style.color = '#fff';
            btn.style.borderColor = '#ef4444';
            btn.style.opacity = '1';
            buttons.forEach(function(b) {
                if (b !== btn && b.getAttribute('onclick') && b.getAttribute('onclick').indexOf('true') !== -1) {
                    b.style.background = '#22c55e'; b.style.color = '#fff'; b.style.borderColor = '#22c55e'; b.style.opacity = '1';
                }
            });
            var wrongDiv = document.createElement('div');
            wrongDiv.style.cssText = 'margin-top:6px;color:#ef4444;font-size:0.8rem;font-weight:700;';
            wrongDiv.textContent = '‚ùå Not quite!';
            parent.appendChild(wrongDiv);
        }

        // Next question after delay
        window._convoQuizIdx = (window._convoQuizIdx || 0) + 1;
        setTimeout(showConvoQuizQuestion, 1500);
    };

    function finishConvoQuiz() {
        var score = window._convoQuizScore || 0;
        var total = window._convoQuizTotal || 3;
        var pct = Math.round((score / total) * 100);
        var pts = score * 5; // 5 pts per correct answer

        var emoji = pct >= 80 ? 'üèÜ' : pct >= 60 ? '‚≠ê' : pct >= 40 ? 'üí™' : 'üìö';
        var msg = pct >= 80 ? 'Outstanding! You really paid attention!' :
                  pct >= 60 ? 'Great job! You learned a lot from our chat!' :
                  pct >= 40 ? 'Not bad! Keep learning and you\'ll get there!' :
                  'Keep going! Every question is a learning opportunity!';

        var html = '<div style="background:linear-gradient(135deg,rgba(247,147,26,0.15),rgba(234,88,12,0.1));border:2px solid ' + (pct >= 60 ? '#22c55e' : 'var(--accent)') + ';border-radius:14px;padding:20px;text-align:center;">' +
            '<div style="font-size:2rem;margin-bottom:8px;">' + emoji + '</div>' +
            '<div style="font-weight:800;color:var(--heading);font-size:1rem;margin-bottom:4px;">Conversation Quest Complete!</div>' +
            '<div style="font-size:1.2rem;font-weight:900;color:var(--accent);margin-bottom:4px;">' + score + '/' + total + ' correct</div>' +
            '<div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:8px;">' + msg + '</div>' +
            (pts > 0 ? '<div style="color:#22c55e;font-weight:700;font-size:0.9rem;">+' + pts + ' pts earned! üéâ</div>' : '') +
        '</div>';
        nachoChatAppend('nacho', '', html);

        if (pts > 0) {
            if (typeof awardPoints === 'function') awardPoints(pts, 'üéØ Conversation Quest!');
            if (typeof showToast === 'function') showToast('üéØ +' + pts + ' pts ‚Äî Conversation Quest!');
        }
    }

    function nachoChatThinking() {
        var chat = document.getElementById('nachoModeChat');
        if (!chat) return;
        if (chat.querySelector('#nachoModeAvatar')) chat.innerHTML = '';
        var div = document.createElement('div');
        div.id = 'nmThinking';
        div.className = 'nm-msg nm-nacho';
        div.innerHTML = '<span style="color:var(--text-muted);">ü¶å Thinking<span class="nacho-dots"></span></span>';
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        var dotsEl = div.querySelector('.nacho-dots');
        var dc = 0;
        window._nmDotsTimer = setInterval(function() { dc=(dc+1)%4; if(dotsEl) dotsEl.textContent='.'.repeat(dc); }, 400);
    }

    function nachoChatClearThinking() {
        if (window._nmDotsTimer) { clearInterval(window._nmDotsTimer); window._nmDotsTimer = null; }
        var t = document.getElementById('nmThinking');
        if (t) t.remove();
    }

    // Export chat
    window.nachoChatExport = function() {
        var hist = window._nachoChatHistory || [];
        if (hist.length === 0) { if (typeof showToast === 'function') showToast('No chat to save!'); return; }
        var lines = ['=== Nacho Mode Chat Export ===', 'Exported: ' + new Date().toLocaleString(), ''];
        for (var i = 0; i < hist.length; i++) {
            var m = hist[i];
            var time = new Date(m.ts).toLocaleString();
            var who = m.role === 'user' ? 'You' : 'Nacho ü¶å';
            // Strip HTML tags for export
            var text = m.role === 'user' ? m.text : (m.html || m.text || '').replace(/<[^>]+>/g, '');
            lines.push('[' + time + '] ' + who + ': ' + text);
        }
        lines.push('', '--- bitcoineducation.quest ---');
        var blob = new Blob([lines.join('\n')], { type: 'text/plain' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'nacho-chat-' + new Date().toISOString().slice(0,10) + '.txt';
        a.click();
        URL.revokeObjectURL(a.href);
        if (typeof showToast === 'function') showToast('üíæ Chat saved!');
    };

    // Clear chat
    window.nachoChatClear = function() {
        if (!confirm('Clear all chat history with Nacho?')) return;
        window._nachoChatHistory = [];
        localStorage.removeItem('btc_nacho_chat');
        nachoChatRender();
        if (typeof showToast === 'function') showToast('üóëÔ∏è Chat cleared');
    };

    window.nachoModeSend = function() {
        var inp = document.getElementById('nachoModeInput');
        if (!inp) return;
        var q = inp.value.trim();
        if (!q) return;
        inp.value = '';
        window._nachoSentIdx = -1;
        window._nachoSentDraft = '';

        // Save to sent history (for ArrowUp recall, max 50)
        window._nachoSentHistory.push(q);
        if (window._nachoSentHistory.length > 50) window._nachoSentHistory.shift();
        try { localStorage.setItem('btc_nacho_sent', JSON.stringify(window._nachoSentHistory)); } catch(e) {}

        // Start talking animation
        nachoModeStartTalking();

        // Track interaction + topic for conversation quiz
        if (typeof trackNachoInteraction === 'function') trackNachoInteraction();
        window._nachoModeEarnings.interactions++;
        if (window._nachoModeTopics && q.length > 10) {
            window._nachoModeTopics.push(q);
        }

        // Check if it's time for a conversation quiz (15+ min, 5+ questions)
        if (!window._nachoConvoQuizOffered && window._nachoModeStartTime && window._nachoModeTopics) {
            var minsInMode = (Date.now() - window._nachoModeStartTime) / 60000;
            if (minsInMode >= 15 && window._nachoModeTopics.length >= 5) {
                window._nachoConvoQuizOffered = true;
                // Delay so current Q&A finishes first
                setTimeout(function() { offerConversationQuiz(); }, 8000);
            }
        }

        // Show user message + save
        nachoChatAdd('user', q);
        nachoChatAppend('user', q);

        // Show thinking
        nachoChatThinking();

        // Answer pipeline helper
        var _replyMsgId = 'nm_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
        function reply(html, source) {
            nachoChatClearThinking();
            nachoModeStopTalking();
            var extras = '';
            // Add action buttons for non-safety responses
            if (source && source !== 'safety') {
                // Thumbs up/down + share + bookmark row
                // Store answer data for Share/Bookmark buttons (avoids inline HTML escaping issues)
                if (!window._nachoAnswerData) window._nachoAnswerData = {};
                window._nachoAnswerData[_replyMsgId] = html;

                var _abtnStyle = 'background:none;border:1px solid var(--border);border-radius:16px;cursor:pointer;font-size:0.75rem;padding:4px 10px;transition:0.2s;color:var(--text-muted);display:inline-flex;align-items:center;gap:3px;touch-action:manipulation;';
                var actionRow = '<div style="margin-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">';
                if (typeof nachoRatingHtml === 'function') {
                    actionRow += '<button id="nachoUp_' + _replyMsgId + '" onclick="event.stopPropagation();nachoRate(\'' + _replyMsgId + '\',1)" style="' + _abtnStyle + '" onmouseover="this.style.borderColor=\'#22c55e\';this.style.color=\'#22c55e\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.color=\'var(--text-muted)\'">üëç Helpful</button>';
                    actionRow += '<button id="nachoDn_' + _replyMsgId + '" onclick="event.stopPropagation();nachoRate(\'' + _replyMsgId + '\',-1)" style="' + _abtnStyle + '" onmouseover="this.style.borderColor=\'#ef4444\';this.style.color=\'#ef4444\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.color=\'var(--text-muted)\'">üëé Not quite</button>';
                }
                actionRow += '<button onclick="event.stopPropagation();nachoShareAnswer(window._nachoAnswerData[\'' + _replyMsgId + '\']||\'\')" style="' + _abtnStyle + '">üì§ Share</button>';
                actionRow += '</div>';
                extras += actionRow;

                // Follow-up chips
                var fups = getFollowUps(q, html);
                extras += followUpChipsHtml(fups);
            }
            nachoChatAdd('nacho', '', html + extras);
            nachoChatAppend('nacho', '', html + extras);
            updateNachoModeFriendship();
            // Track topic + source
            if (typeof nachoTrackTopic === 'function') nachoTrackTopic(q, source || 'unknown');
            // Check milestones
            var milestone = checkNachoMilestone();
            if (milestone) {
                setTimeout(function() {
                    nachoChatAdd('nacho', '', milestone);
                    nachoChatAppend('nacho', '', milestone);
                }, 1500);
            }
        }

        // Use unified pipeline (same logic as regular Nacho bubble)
        if (typeof nachoUnifiedAnswer === 'function') {
            nachoUnifiedAnswer(q, function(result) {
                var channelLink = '';
                if (result.channel) {
                    channelLink = '<br><br><a href="#" onclick="event.preventDefault();exitNachoMode();setTimeout(function(){go(\'' + result.channel + '\')},300)" style="color:var(--accent);font-weight:600;">üìñ Read more: ' + (result.channelName || result.channel) + ' ‚Üí</a>';
                }
                reply(result.answer + channelLink, result.type);
            });
            return;
        }

        // Fallback if unified pipeline not loaded yet
        if (!document.querySelector('script[data-nacho-retry]')) {
            var s = document.createElement('script');
            s.src = 'nacho-qa.js?v=' + Date.now();
            s.setAttribute('data-nacho-retry', '1');
            document.head.appendChild(s);
        }
        setTimeout(function() {
            if (typeof nachoUnifiedAnswer === 'function') {
                nachoUnifiedAnswer(q, function(result) {
                    var channelLink = '';
                    if (result.channel) {
                        channelLink = '<br><br><a href="#" onclick="event.preventDefault();exitNachoMode();setTimeout(function(){go(\'' + result.channel + '\')},300)" style="color:var(--accent);font-weight:600;">üìñ Read more: ' + (result.channelName || result.channel) + ' ‚Üí</a>';
                    }
                    reply(result.answer + channelLink, result.type);
                });
            } else {
                nachoModeFallbackReply(q, reply);
            }
        }, 2000);
    };

    // Nacho Mode avatar tap ‚Äî random fun reaction
    window.nachoModeAvatarTap = function() {
        var avatar = document.getElementById('nachoModeAvatar');
        if (!avatar) return;
        avatar.style.transform = 'scale(1.1) rotate(' + (Math.random() > 0.5 ? '5' : '-5') + 'deg)';
        setTimeout(function() { avatar.style.transform = ''; }, 300);
        if (typeof trackNachoInteraction === 'function') trackNachoInteraction();
        window._nachoModeEarnings.interactions++;
        updateNachoModeFriendship();
    };

    // Nacho Mode talking animation
    function nachoModeStartTalking() {
        var hero = document.getElementById('nachoHeroAvatar');
        if (hero) hero.classList.add('talking');
    }
    function nachoModeStopTalking() {
        var hero = document.getElementById('nachoHeroAvatar');
        if (hero) hero.classList.remove('talking');
    }

    // Nacho Mode voice input
    window._nachoModeRecognition = null;
    window._nachoModeListening = false;
    window.nachoModeVoice = function() {
        var SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRec) return;
        var inp = document.getElementById('nachoModeInput');
        var mic = document.getElementById('nachoModeMic');
        if (!inp || !mic) return;

        if (window._nachoModeListening && window._nachoModeRecognition) {
            window._nachoModeRecognition.stop();
            return;
        }

        var rec = new SpeechRec();
        window._nachoModeRecognition = rec;
        rec.lang = 'en-US';
        rec.interimResults = true;
        rec.maxAlternatives = 1;
        rec.continuous = false;

        mic.style.opacity = '1';
        mic.innerHTML = 'üî¥';
        inp.placeholder = 'Listening...';
        inp.style.borderColor = '#f7931a';
        window._nachoModeListening = true;

        var finalTranscript = '';
        rec.onresult = function(e) {
            var interim = '';
            for (var i = e.resultIndex; i < e.results.length; i++) {
                if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
                else interim += e.results[i][0].transcript;
            }
            inp.value = finalTranscript || interim;
        };

        rec.onend = function() {
            window._nachoModeListening = false;
            mic.innerHTML = 'üéôÔ∏è';
            mic.style.opacity = '0.6';
            inp.style.borderColor = 'var(--border,#333)';
            inp.placeholder = 'Type or tap üéôÔ∏è to speak...';
            if (inp.value.trim().length > 0) nachoModeSend();
        };

        rec.onerror = function() {
            window._nachoModeListening = false;
            mic.innerHTML = 'üéôÔ∏è';
            mic.style.opacity = '0.6';
            inp.style.borderColor = 'var(--border,#333)';
            inp.placeholder = 'Voice error ‚Äî try typing';
        };

        try { rec.start(); } catch(e) {
            window._nachoModeListening = false;
            mic.innerHTML = 'üéôÔ∏è';
            mic.style.opacity = '0.6';
        }
    };

    function updateNachoModeFriendship() {
        var el = document.getElementById('nachoModeFriendship');
        if (!el) return;
        var f = typeof getNachoFriendship === 'function' ? getNachoFriendship() : { emoji: 'ü¶å', name: 'Unknown', level: 0 };
        var interactions = parseInt(localStorage.getItem('btc_nacho_interactions') || '0');
        el.textContent = f.emoji + ' Friendship: ' + f.name + ' ¬∑ ' + interactions + ' interactions';
    }

    window.exitNachoMode = function() {
        window._nachoMode = false;
        window._nachoBusy = false;
        if (window._btcPriceTimer) { clearInterval(window._btcPriceTimer); window._btcPriceTimer = null; }

        // Remove Nacho Mode screen
        var screen = document.getElementById('nachoModeScreen');
        if (screen) screen.remove();

        // Restore everything that was hidden on enter
        document.querySelectorAll('aside, #rankBar, #lbFloatBtn, #floatingRandomBtn, #userDisplay, #backToTop, #scrollToBottom, #nacho-container, #nacho-toggle').forEach(function(el) {
            if (el) el.style.display = '';
        });
        // Restore mobile top bar
        var mbar = document.querySelector('.mobile-bar');
        if (mbar && window.innerWidth <= 900) mbar.style.display = 'flex';

        // Show summary of what was earned
        var e = window._nachoModeEarnings;
        if (e.interactions > 0 && typeof showToast === 'function') {
            var parts = ['ü¶å ' + e.interactions + ' interactions'];
            if (e.points > 0) parts.push('+' + e.points + ' pts');
            var bc = Array.isArray(e.badges) ? e.badges.length : (e.badges || 0);
            if (bc > 0) parts.push(bc + ' badge' + (bc > 1 ? 's' : ''));
            showToast(parts.join(' ¬∑ '));
        }

        goHome();
    };

    window.goHome = function goHome(fromPopState) {
        var fb = document.getElementById('floatingRandomBtn');
        if (fb) fb.style.display = 'none';
        // Hide forum container
        var fc = document.getElementById('forumContainer');
        if (fc) { fc.style.display = 'none'; fc.innerHTML = ''; }
        document.getElementById('hero').style.display = '';
        document.getElementById('msgs').style.display = '';
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('hero').innerHTML = '';
        document.getElementById('msgs').innerHTML = '';
        document.querySelectorAll('.ch-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('main').scrollTop = 0;
        if (!fromPopState) history.pushState({ channel: null }, '', window.location.pathname);
        if (isMobile()) {
            document.getElementById('sidebar').classList.remove('open');
            setFloatingElementsVisible(true);
            // Ensure mobile top bar is always visible
            var mbar = document.querySelector('.mobile-bar');
            if (mbar) mbar.style.display = 'flex';
        }
        // Show continue reading
        showContinueReading();
        // Refresh exploration map to reflect newly visited channels
        if (typeof renderExplorationMap === 'function') renderExplorationMap();
    }

    function showContinueReading() {
        const el = document.getElementById('continueReading');
        if (!el) return;
        const lastCh = localStorage.getItem('btc_last_channel');
        if (lastCh && CHANNELS[lastCh]) {
            const meta = CHANNELS[lastCh];
            el.style.display = 'block';
            el.innerHTML = '<div style="background:var(--card-bg);border:1px solid var(--accent-glow);border-radius:16px;padding:16px 20px;cursor:pointer;transition:0.2s;" onclick="go(\'' + lastCh + '\')" onmouseover="this.style.borderColor=\'var(--accent)\';this.style.boxShadow=\'0 4px 20px var(--accent-glow)\'" onmouseout="this.style.borderColor=\'var(--accent-glow)\';this.style.boxShadow=\'none\'">' +
                '<div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--accent);font-weight:800;margin-bottom:6px;">üìñ Continue Reading</div>' +
                '<div style="color:var(--heading);font-size:1.05rem;font-weight:700;margin-bottom:2px;">' + meta.title + '</div>' +
                '<div style="color:var(--text-muted);font-size:0.8rem;">' + meta.cat + '</div></div>';
        } else {
            el.style.display = 'none';
        }
    }

    // Keyboard shortcuts (desktop) ‚Äî MMORPG style!
    document.addEventListener('keydown', function(e) {
        // Don't fire in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
        var key = e.key.toLowerCase();
        var ctrl = e.ctrlKey || e.metaKey;
        if (ctrl) return; // Don't hijack browser shortcuts

        // === Navigation ===
        // H = go home
        if (key === 'h') { goHome(); return; }
        // S or / = focus search
        if (key === 's' || key === '/') { e.preventDefault(); var si = document.getElementById('searchInput'); if (si) { si.focus(); if (isMobile()) document.getElementById('sidebar').classList.add('open'); } return; }
        // C = random channel
        if (key === 'c') { goRandom(); return; }
        // R = random meme
        if (key === 'r') { if (typeof goRandomMeme === 'function') goRandomMeme(); return; }
        // M = marketplace
        if (key === 'm') { go('marketplace'); return; }
        // A = ask Nacho
        if (key === 'a') { if (typeof showNachoInput === 'function') showNachoInput(); return; }

        // === Quick Actions ===
        // L = toggle leaderboard
        if (key === 'l') { if (typeof toggleLeaderboard === 'function') toggleLeaderboard(); return; }
        // Q = start quest on current channel
        if (key === 'q') { var qb = document.getElementById('questBtn'); if (qb) qb.click(); return; }
        // F = favorite/save current channel
        if (key === 'f') { go('forum'); return; }
        if (key === 'z') { var fb = document.getElementById('favBtn'); if (fb) fb.click(); return; }
        // N = talk to Nacho (open Q&A input)
        if (key === 'n') { if (typeof enterNachoMode === 'function') enterNachoMode(); return; }
        // T = toggle theme (dark/light)
        if (key === 't') { var tb = document.getElementById('themeToggle'); if (tb) tb.click(); return; }
        // G = gallery view (on supported channels)
        if (key === 'g') { var gb = document.getElementById('galleryBtn'); if (gb) gb.click(); return; }

        // === Scroll ===
        // J = scroll down
        if (key === 'j') { document.getElementById('main').scrollBy({ top: 300, behavior: 'smooth' }); return; }
        // K = scroll up
        if (key === 'k') { document.getElementById('main').scrollBy({ top: -300, behavior: 'smooth' }); return; }
        // Space = page down (unless in modal)
        if (key === ' ') { e.preventDefault(); document.getElementById('main').scrollBy({ top: window.innerHeight * 0.8, behavior: 'smooth' }); return; }

        // === Info ===
        // ? = show keyboard shortcuts help
        if (key === '?' || (e.shiftKey && key === '/')) { showKeyboardHelp(); return; }
        // I = open settings
        if (key === 'i') { if (typeof showSettingsPage === 'function') showSettingsPage('account'); return; }
        // D = donate ‚Äî go home and scroll to donation section
        if (key === 'd') {
            showDonateModal();
            return;
        }
        // B = back to previous channel
        if (key === 'b') { var lc = localStorage.getItem('btc_last_channel'); if (lc) go(lc); return; }

        // === Hidden Easter Eggs (shhh!) ===
        // 2 = "There is no second best."
        if (key === '2') { speakEasterEgg("There is no second best."); return; }
        // 1 = "One more block."
        if (key === '1') { speakEasterEgg("One more block."); return; }
        // 0 = "Don't trust. Verify."
        if (key === '0') { speakEasterEgg("Don't trust. Verify."); if (typeof earnSticker === 'function') earnSticker('cool'); return; }
        // 9 = "Number go up!"
        if (key === '9') { speakEasterEgg("Number go up!"); if (typeof nachoFly === 'function') nachoFly(); return; }
        // P = "Stay humble, stack sats."
        if (key === 'p') { if (typeof goRandomArt === 'function') goRandomArt(); return; }
        if (key === 'w') { speakEasterEgg("Stay humble. Stack sats."); return; }
        // Secret: type "btc" to unlock Bitcoin Eyes
        window._eggBuffer = (window._eggBuffer || '') + key;
        if (window._eggBuffer.length > 10) window._eggBuffer = window._eggBuffer.slice(-10);
        if (window._eggBuffer.indexOf('btc') !== -1) {
            window._eggBuffer = '';
            localStorage.setItem('btc_bitcoin_eyes_unlocked', 'true');
            if (typeof showToast === 'function') showToast('‚Çø‚Çø Secret unlocked: Bitcoin Eyes! Check Nacho\'s Closet!');
            if (typeof haptic === 'function') haptic('success');
        }

        // === Escape = close modals ===
        if (key === 'escape') {
            if (document.getElementById('lb').classList.contains('open')) document.getElementById('lb').classList.remove('open');
            if (document.getElementById('usernameModal').classList.contains('open')) hideUsernamePrompt();
            if (document.getElementById('questModal').classList.contains('open')) document.getElementById('questModal').classList.remove('open');
            if (isMobile() && document.getElementById('sidebar').classList.contains('open')) { document.getElementById('sidebar').classList.remove('open'); setFloatingElementsVisible(true); }
        }
    });

    // Easter egg speech
    var lastEasterEgg = 0;
    function speakEasterEgg(text) {
        var now = Date.now();
        if (now - lastEasterEgg < 3000) return; // cooldown
        lastEasterEgg = now;
        // Show toast
        if (typeof showToast === 'function') showToast('üü† ' + text);
        // Speak it
        try {
            var utter = new SpeechSynthesisUtterance(text);
            utter.rate = 0.9;
            utter.pitch = 0.85;
            utter.volume = 0.8;
            // Try to pick a deep/dramatic voice
            var voices = speechSynthesis.getVoices();
            var preferred = voices.find(function(v) { return v.name.indexOf('Daniel') !== -1 || v.name.indexOf('Google UK English Male') !== -1 || v.name.indexOf('Male') !== -1; });
            if (preferred) utter.voice = preferred;
            speechSynthesis.cancel();
            speechSynthesis.speak(utter);
        } catch(e) {}
    }
    // Preload voices
    if (typeof speechSynthesis !== 'undefined') speechSynthesis.getVoices();

    // Keyboard shortcuts help modal
    function showKeyboardHelp() {
        var existing = document.getElementById('kbHelpModal');
        if (existing) { existing.remove(); return; }
        var modal = document.createElement('div');
        modal.id = 'kbHelpModal';
        modal.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);';
        modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
        modal.innerHTML =
            '<div style="background:var(--bg-side,#1a1a2e);border:2px solid var(--accent);border-radius:16px;padding:28px 32px;max-width:480px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,0.5);">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">' +
                '<h2 style="color:var(--accent);font-size:1.2rem;margin:0;">‚å®Ô∏è Keyboard Shortcuts</h2>' +
                '<span onclick="document.getElementById(\'kbHelpModal\').remove()" style="cursor:pointer;font-size:1.3rem;color:var(--text-faint);">‚úï</span>' +
            '</div>' +
            '<div style="font-size:0.8rem;color:var(--text-faint);margin-bottom:12px;">Press <kbd style="background:var(--card-bg);border:1px solid var(--border);padding:2px 6px;border-radius:4px;font-family:monospace;">?</kbd> to toggle this menu</div>' +
            '<div style="display:grid;grid-template-columns:auto 1fr;gap:6px 16px;font-size:0.85rem;">' +
                '<div style="color:var(--accent);font-weight:700;grid-column:1/-1;margin-top:8px;border-bottom:1px solid var(--border);padding-bottom:4px;">Navigation</div>' +
                kbRow('H','Go home') + kbRow('S / /','Search') + kbRow('R','Random channel') +
                kbRow('M','Random meme') + kbRow('A','Random art') + kbRow('B','Back to last channel') +
                '<div style="color:var(--accent);font-weight:700;grid-column:1/-1;margin-top:12px;border-bottom:1px solid var(--border);padding-bottom:4px;">Actions</div>' +
                kbRow('L','Leaderboard') + kbRow('Q','Start quest') + kbRow('F','Favorite channel') +
                kbRow('N','Ask Nacho') + kbRow('T','Toggle theme') + kbRow('G','Gallery view') +
                kbRow('I','Settings') + kbRow('D','Donate') +
                '<div style="color:var(--accent);font-weight:700;grid-column:1/-1;margin-top:12px;border-bottom:1px solid var(--border);padding-bottom:4px;">Scrolling</div>' +
                kbRow('J','Scroll down') + kbRow('K','Scroll up') + kbRow('Space','Page down') + kbRow('Esc','Close modals') +
            '</div></div>';
        document.body.appendChild(modal);
    }
    function kbRow(key, desc) {
        return '<div><kbd style="background:var(--card-bg);border:1px solid var(--border);padding:3px 8px;border-radius:4px;font-family:monospace;font-size:0.8rem;color:var(--heading);min-width:24px;display:inline-block;text-align:center;">' + key + '</kbd></div><div style="color:var(--text-muted);">' + desc + '</div>';
    }

    // ---- Mobile Gestures ----
    (function() {
        if (!('ontouchstart' in window)) return; // Desktop, skip

        // Shake to hear a random Bitcoin quote (easter egg)
        // High threshold so walking/normal movement doesn't trigger it
        var shakeThreshold = 50; // High threshold ‚Äî requires obvious deliberate shake
        var shakeCount = 0; // Require multiple hits to confirm real shake
        var lastShake = 0;
        var lastAccel = { x: 0, y: 0, z: 0 };
        window.addEventListener('devicemotion', function(e) {
            var a = e.accelerationIncludingGravity;
            if (!a) return;
            var dx = Math.abs(a.x - lastAccel.x);
            var dy = Math.abs(a.y - lastAccel.y);
            var dz = Math.abs(a.z - lastAccel.z);
            lastAccel = { x: a.x, y: a.y, z: a.z };
            if (dx + dy + dz > shakeThreshold) {
                shakeCount++;
                // Reset count if movements are too far apart
                clearTimeout(window._shakeResetTimer);
                window._shakeResetTimer = setTimeout(function() { shakeCount = 0; }, 1000);
                // Require 3 strong movements within 1 second for a real shake
                if (shakeCount < 3) return;
                shakeCount = 0;
                var now = Date.now();
                if (now - lastShake < 10000) return; // 10s cooldown
                lastShake = now;
                var quotes = [
                    "There is no second best.",
                    "One more block.",
                    "Don't trust. Verify.",
                    "Number go up!",
                    "Stay humble. Stack sats.",
                    "Not your keys, not your coins.",
                    "Bitcoin fixes this.",
                    "Tick tock, next block."
                ];
                speakEasterEgg(quotes[Math.floor(Math.random() * quotes.length)]);
                if (Math.random() < 0.3 && typeof nachoFly === 'function') nachoFly();
            }
        });

        // Swipe left/right on content area for random channel navigation
        var touchStartX = 0, touchStartY = 0, touchStartTime = 0;
        var mainEl = document.getElementById('main');
        mainEl.addEventListener('touchstart', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });

        mainEl.addEventListener('touchend', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            var dx = e.changedTouches[0].clientX - touchStartX;
            var dy = e.changedTouches[0].clientY - touchStartY;
            var dt = Date.now() - touchStartTime;
            // Must be a quick, horizontal swipe (not a scroll)
            // Strict: fast, very horizontal, long swipe ‚Äî won't trigger during normal scrolling
            if (dt > 300 || Math.abs(dx) < 150 || Math.abs(dy) > Math.abs(dx) * 0.3) return;

            if (dx > 150) {
                goHome();
            } else if (dx < -150) {
                goRandom();
            }
        }, { passive: true });

        // Two-finger tap ‚Üí toggle leaderboard
        // Must be a quick tap (touchend within 300ms), not during scroll
        var twoFingerLast = 0;
        var twoFingerStart = 0;
        document.getElementById('main').addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) twoFingerStart = Date.now();
        }, { passive: true });
        document.getElementById('main').addEventListener('touchend', function(e) {
            if (twoFingerStart && e.touches.length === 0 && e.changedTouches.length >= 1) {
                var dt = Date.now() - twoFingerStart;
                twoFingerStart = 0;
                if (dt > 400) return; // Not a tap, was a hold/scroll
                var now = Date.now();
                if (now - twoFingerLast < 3000) return; // 3s cooldown
                twoFingerLast = now;
                if (typeof toggleLeaderboard === 'function') toggleLeaderboard();
            }
        }, { passive: true });

        // Long-press on logo ‚Üí Nacho Mode
        // Uses MutationObserver to also catch dynamically added channel logos
        function attachLogoGesture(logo) {
            if (logo._nachoLongPress) return; // Already attached
            logo._nachoLongPress = true;
            var lp;
            logo.addEventListener('touchstart', function(e) {
                lp = setTimeout(function() {
                    if (typeof enterNachoMode === 'function') enterNachoMode();
                }, 800);
            }, { passive: true });
            logo.addEventListener('touchend', function() { clearTimeout(lp); });
            logo.addEventListener('touchmove', function() { clearTimeout(lp); });
        }
        document.querySelectorAll('.home-logos img, .channel-logos .channel-logo-img').forEach(attachLogoGesture);
        // Watch for dynamically added channel logos
        new MutationObserver(function() {
            document.querySelectorAll('.channel-logos .channel-logo-img').forEach(attachLogoGesture);
        }).observe(document.getElementById('main'), { childList: true, subtree: true });

        // Three-finger tap ‚Üí Community Forum
        // Must be a quick tap, not during scroll
        var threeFingerLast = 0;
        var threeFingerStart = 0;
        document.getElementById('main').addEventListener('touchstart', function(e) {
            if (e.touches.length === 3) threeFingerStart = Date.now();
        }, { passive: true });
        document.getElementById('main').addEventListener('touchend', function(e) {
            if (threeFingerStart && e.touches.length === 0) {
                var dt = Date.now() - threeFingerStart;
                threeFingerStart = 0;
                if (dt > 400) return; // Not a tap
                var now = Date.now();
                if (now - threeFingerLast < 3000) return; // 3s cooldown
                threeFingerLast = now;
                go('forum');
            }
        }, { passive: true });
    })();

    // Cache loaded channel data
    const channelCache = {};

    // Audio system
    let audioEnabled = localStorage.getItem('btc_audio') !== 'false';
    let audioVolume = parseFloat(localStorage.getItem('btc_volume') || '0.5');

    function getVolume() { return audioEnabled ? audioVolume : 0; }

    function playChannelSound() {
        if (document.hidden) return;
        if (!audioEnabled || audioVolume <= 0) return;
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const vol = audioVolume;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 880;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.08 * vol, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.15);
            const osc2 = ctx.createOscillator();
            const gain2 = ctx.createGain();
            osc2.connect(gain2);
            gain2.connect(ctx.destination);
            osc2.frequency.value = 1318.5;
            osc2.type = 'sine';
            gain2.gain.setValueAtTime(0.05 * vol, ctx.currentTime + 0.05);
            gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
            osc2.start(ctx.currentTime + 0.05);
            osc2.stop(ctx.currentTime + 0.25);
        } catch(e) {}
    }
    function toggleAudio() {
        audioEnabled = !audioEnabled;
        localStorage.setItem('btc_audio', audioEnabled);
        updateAudioUI();
        if (typeof showToast === 'function') showToast(audioEnabled ? 'üîä Sound on' : 'üîá Sound off');
    }
    function setVolume(val) {
        audioVolume = parseFloat(val);
        localStorage.setItem('btc_volume', audioVolume);
        if (audioVolume <= 0) {
            audioEnabled = false;
            localStorage.setItem('btc_audio', 'false');
        } else if (!audioEnabled) {
            audioEnabled = true;
            localStorage.setItem('btc_audio', 'true');
        }
        updateAudioUI();
    }
    function updateAudioUI() {
        const btn = document.getElementById('audioBtn');
        if (btn) btn.textContent = audioEnabled && audioVolume > 0 ? (audioVolume > 0.5 ? 'üîä' : 'üîâ') : 'üîá';
        const slider = document.getElementById('volumeSlider');
        if (slider) slider.value = audioEnabled ? audioVolume : 0;
    }

    window.go = async function go(id, btn, fromPopState) {
        // Forum route
        if (id === 'forum' || id === 'marketplace') {
            if (window._nachoMode) exitNachoMode();
            document.getElementById('home').classList.add('hidden');
            document.getElementById('hero').innerHTML = '';
            document.getElementById('msgs').innerHTML = '';
            document.getElementById('msgs').style.display = 'none';
            document.getElementById('hero').style.display = 'none';
            var fc = document.getElementById('forumContainer');
            if (fc) { fc.style.display = 'block'; }
            if (!fromPopState) history.pushState({ channel: id }, '', '#' + id);
            if (isMobile()) { document.getElementById('sidebar').classList.remove('open'); setFloatingElementsVisible(true); }
            if (id === 'marketplace' && typeof renderMarketplace === 'function') renderMarketplace();
            else if (typeof renderForum === 'function') renderForum();
            return;
        }

        const meta = CHANNELS[id];
        if (!meta) return;
        // Hide forum container when navigating to a channel
        var fc = document.getElementById('forumContainer');
        if (fc) { fc.style.display = 'none'; fc.innerHTML = ''; }
        document.getElementById('hero').style.display = '';
        document.getElementById('msgs').style.display = '';
        // Hide floating random button when navigating to a different channel
        if (!window._keepFloatingBtn) {
            var fb = document.getElementById('floatingRandomBtn');
            if (fb && fb.style.display !== 'none' && id !== 'memes-funny' && id !== 'art-inspiration') fb.style.display = 'none';
        }

        localStorage.setItem('btc_last_channel', id);
        playChannelSound();
        document.getElementById('home').classList.add('hidden');
        document.querySelectorAll('.ch-btn').forEach(b => b.classList.remove('active'));
        if (btn) { btn.classList.add('active'); expandCatForChannel(btn); }
        else {
            // Find the button by channel id and expand its section
            document.querySelectorAll('.ch-btn').forEach(b => {
                if (b.getAttribute('onclick') && b.getAttribute('onclick').indexOf("'" + id + "'") !== -1) {
                    b.classList.add('active');
                    expandCatForChannel(b);
                }
            });
        }

        // Show loading state
        // Check if this is an image-heavy channel
        const GALLERY_CHANNELS = ['graphics','memes-funny','art-inspiration','charts','swag-merch','fun-facts'];
        const isGallery = GALLERY_CHANNELS.includes(id);

        const shareUrl = 'https://bitcoineducation.quest/#' + id;
        const shareText = meta.title + ' ‚Äî Bitcoin Education Archive';
        document.getElementById('hero').innerHTML =
            '<div class="channel-logos">' +
                '<img src="images/btc-grad-logo.jpg" alt="Home" class="channel-logo-img" onclick="goHome()" style="cursor:pointer;" title="Home ‚Äî Long-press for Nacho Mode ü¶å">' +
                '<span class="donate-circle" onclick="showDonateModal()"><svg viewBox="0 0 64 64" width="50" height="50" style="cursor:pointer;" title="Donate"><circle cx="32" cy="32" r="30" fill="#f7931a"/><polygon points="36,10 22,38 30,38 28,54 42,26 34,26" fill="#fff"/></svg></span>' +
            '</div>' +
            '<div class="cat">' + meta.cat + '</div>' +
            '<h1>' + meta.title + '</h1>' +
            '<p class="desc" id="channelDesc">' + meta.desc + '</p>' +
            '<div class="share-bar">' +
                '<a class="share-btn" href="https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareText) + '&url=' + encodeURIComponent(shareUrl) + '" target="_blank">ùïè Share</a>' +
                '<button class="share-btn" onclick="shareNostr(\'' + shareText.replace(/'/g, "\\'") + '\', \'' + shareUrl + '\')">üü£ Nostr</button>' +
                '<button class="share-btn" onclick="copyLink(\'' + shareUrl + '\', this)">üîó Copy Link</button>' +
                '<button class="share-btn" id="favBtn" onclick="toggleFav(\'' + id + '\', this)">' + (getFavs().includes(id) ? '‚≠ê Saved' : '‚òÜ Save') + '</button>' +
            '</div>' +
            (isGallery ? '<button class="gallery-toggle" id="galleryBtn" style="display:inline-block;" onclick="toggleGallery(\'' + id + '\')">üñºÔ∏è Gallery View</button>' : '');
        document.getElementById('hero').classList.remove('fade-in');
        document.getElementById('msgs').innerHTML = '<div style="padding:40px;text-align:center;">' +
            '<div style="display:inline-block;width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px;"></div>' +
            '<div style="color:var(--text-faint);font-size:0.85rem;">Loading channel...</div></div>';
        document.getElementById('main').scrollTop = 0;
        if (!fromPopState) history.pushState({ channel: id }, '', '#' + id);

        // On mobile, close the menu immediately
        if (isMobile()) {
            document.getElementById('sidebar').classList.remove('open');
            setFloatingElementsVisible(true);
        }

        // Fetch channel data (lazy load with cache)
        let d;
        if (channelCache[id]) {
            d = channelCache[id];
        } else {
            try {
                const resp = await fetch(meta.file);
                d = await resp.json();
                channelCache[id] = d;
            } catch(e) {
                document.getElementById('msgs').innerHTML = '<div style="padding:40px;color:#ef4444;">Error loading channel data</div>';
                return;
            }
        }

        // Store channel data and render
        currentChannelData = d;
        currentChannelId = id;
        galleryMode = false;

        // Update description with full text from data, with working links and embeds
        const descEl = document.getElementById('channelDesc');
        if (descEl && d.msgs && d.msgs[0] && d.msgs[0].text) {
            let t = d.msgs[0].text;
            // YouTube embeds
            let ytEmbeds = [];
            t = t.replace(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([\w-]+)(?:[&?][^\s]*)?/g, function(match, id) {
                ytEmbeds.push(id); return '%%YT' + (ytEmbeds.length - 1) + '%%';
            });
            t = t.replace(/(?:https?:\/\/)?youtu\.be\/([\w-]+)(?:\?[^\s]*)?/g, function(match, id) {
                ytEmbeds.push(id); return '%%YT' + (ytEmbeds.length - 1) + '%%';
            });
            // Twitter/X embeds
            let twEmbeds = [];
            t = t.replace(/(?:https?:\/\/)?(?:twitter\.com|x\.com)\/([\w]+)\/status\/(\d+)(?:[^\s]*)?/g, function(match) {
                var url = match.startsWith('http') ? match : 'https://' + match;
                twEmbeds.push(url); return '%%TW' + (twEmbeds.length - 1) + '%%';
            });
            // Linkify remaining URLs
            t = t.replace(/(https?:\/\/[^\s<>"]+)/g, '<a class="msg-link" href="$1" target="_blank">$1</a>');
            // Restore YouTube
            t = t.replace(/%%YT(\d+)%%/g, function(match, idx) {
                return '<div class="yt-embed"><iframe src="https://www.youtube-nocookie.com/embed/' + ytEmbeds[parseInt(idx)] + '" frameborder="0" allowfullscreen loading="lazy"></iframe></div>';
            });
            // Restore Twitter
            t = t.replace(/%%TW(\d+)%%/g, function(match, idx) {
                var twUrl = twEmbeds[parseInt(idx)], twId = 'tw_' + Math.random().toString(36).substr(2, 8);
                var isMob = typeof isMobile === 'function' && isMobile();
                var hm = twUrl.match(/(?:twitter\.com|x\.com)\/([\w]+)\//);
                var dh = hm ? '@' + hm[1] : twUrl.replace(/https?:\/\/(www\.)?/, '');
                return '<div class="tw-preview" id="' + twId + '" onclick="loadTweetEmbed(\'' + twId + '\',\'' + twUrl + '\')"><div class="tw-preview-icon">ùïè</div><div class="tw-preview-content"><div class="tw-preview-url">' + dh + '</div><div class="tw-preview-hint">' + (isMob ? '‚ñ∂ Tap to display tweet' : '‚ñ∂ Click to display tweet') + '</div></div><div class="tw-preview-arrow">‚Üí</div></div>';
            });
            t = t.replace(/üü† (.+)/g, '<span class="orange-glow">$1</span>');
            descEl.innerHTML = t;
        }

        renderContent(id);

        // Trigger fade-in animation
        document.getElementById('hero').classList.add('fade-in');
        document.getElementById('msgs').classList.add('fade-in');

        // Setup load-more for list view (skip first msg, shown in hero)
        window._currentMsgs = d.msgs.length > 1 ? d.msgs.slice(1) : d.msgs;
        window._currentOffset = 50;
        window.loadMoreMsgs = function() {
            const offset = window._currentOffset;
            const msgs = window._currentMsgs;
            const btn = document.getElementById('loadMoreBtn');
            const nextBatch = msgs.slice(offset, offset + 50);
            let html = '';
            nextBatch.forEach((m, bi) => {
                html += '<div class="msg" id="msg-' + (offset + bi) + '">';
                if (m.text) { let t = m.text; let yt=[],tw=[]; t=t.replace(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([\w-]+)(?:[&?][^\s]*)?/g,function(m,id){yt.push(id);return '%%YT'+(yt.length-1)+'%%';}); t=t.replace(/(?:https?:\/\/)?youtu\.be\/([\w-]+)(?:\?[^\s]*)?/g,function(m,id){yt.push(id);return '%%YT'+(yt.length-1)+'%%';}); t=t.replace(/(?:https?:\/\/)?(?:twitter\.com|x\.com)\/([\w]+)\/status\/(\d+)(?:[^\s]*)?/g,function(m){var u=m.startsWith('http')?m:'https://'+m;tw.push(u);return '%%TW'+(tw.length-1)+'%%';}); t=t.replace(/(https?:\/\/[^\s<>"]+)/g,'<a class="msg-link" href="$1" target="_blank">$1</a>'); t=t.replace(/%%YT(\d+)%%/g,function(m,i){return '<div class="yt-embed"><iframe src="https://www.youtube-nocookie.com/embed/'+yt[parseInt(i)]+'" frameborder="0" allowfullscreen loading="lazy"></iframe></div>';}); t=t.replace(/%%TW(\d+)%%/g,function(m,i){var u=tw[parseInt(i)],tid='tw_'+Math.random().toString(36).substr(2,8),mob=typeof isMobile==='function'&&isMobile(),hm=u.match(/(?:twitter\.com|x\.com)\/([\w]+)\//),dh=hm?'@'+hm[1]:u.replace(/https?:\/\/(www\.)?/,'');return '<div class="tw-preview" id="'+tid+'" onclick="loadTweetEmbed(\''+tid+'\',\''+u+'\')"><div class="tw-preview-icon">ùïè</div><div class="tw-preview-content"><div class="tw-preview-url">'+dh+'</div><div class="tw-preview-hint">'+(mob?'‚ñ∂ Tap to display tweet':'‚ñ∂ Click to display tweet')+'</div></div><div class="tw-preview-arrow">‚Üí</div></div>';}); t=t.replace(/üü† (.+)/g,'<span class="orange-glow">$1</span>'); html += '<div class="msg-text">' + t + '</div>'; }
                if (m.imgs) m.imgs.forEach(img => { if (m.link) { html += '<a href="' + m.link + '" target="_blank" style="display:block;"><img class="msg-img" src="' + img + '" loading="lazy" title="Click to open source"></a>'; } else { html += '<img class="msg-img" src="' + img + '" onclick="openImg(this.src)" loading="lazy">'; } });
                html += '</div>';
            });
            btn.insertAdjacentHTML('beforebegin', html);
            window._currentOffset = offset + 50;
            if (window._currentOffset >= msgs.length) { btn.remove(); }
            else { btn.textContent = 'Load more (' + (msgs.length - window._currentOffset) + ' remaining)'; }
        };

        // Mark channel as visited in sidebar
        document.querySelectorAll('.ch-btn').forEach(b => {
            if (b.getAttribute('onclick') && b.getAttribute('onclick').includes("'" + id + "'")) {
                b.classList.add('visited');
            }
        });

        // Save visited channels locally
        let visited = JSON.parse(localStorage.getItem('btc_visited_channels') || '[]');
        if (!visited.includes(id)) { visited.push(id); localStorage.setItem('btc_visited_channels', JSON.stringify(visited)); }

        // Ranking: award points for opening channel
        if (typeof onChannelOpen === 'function') onChannelOpen(id);
    }

    // Search index cache for deep search
    let searchIndexLoaded = false;
    let searchFullData = {};

    async function loadSearchIndex() {
        if (searchIndexLoaded) return;
        // Load all data files in background for deep search
        const promises = Object.entries(CHANNELS).map(async ([key, meta]) => {
            if (channelCache[key]) { searchFullData[key] = channelCache[key]; return; }
            try {
                const resp = await fetch(meta.file);
                const d = await resp.json();
                channelCache[key] = d;
                searchFullData[key] = d;
            } catch(e) {}
        });
        await Promise.all(promises);
        searchIndexLoaded = true;
    }

    let searchTimeout = null;
    // Internal app pages searchable by keyword
    const APP_PAGES = [
        { id: '_nacho', title: 'ü¶å Nacho Mode', desc: 'Interactive AI-powered Bitcoin tutor', keywords: 'nacho mode ai chat ask question tutor learn mascot deer', action: 'enterNachoMode()' },
        { id: '_forum', title: 'üó£Ô∏è Community Forum', desc: 'Discuss Bitcoin with the community', keywords: 'forum community chat discuss talk conversation post', action: "go('forum')" },
        { id: '_market', title: 'üõí Marketplace', desc: 'Buy and sell with Bitcoin', keywords: 'marketplace market buy sell trade shop store bitcoin sats lightning wallet hardware merch', action: "go('marketplace')" },
        { id: '_settings', title: '‚öôÔ∏è Settings', desc: 'Profile, rank, tickets, referral link, theme', keywords: 'settings profile account rank level points tickets referral theme dark light audio sound notifications push', action: 'showSettings()' },
        { id: '_spin', title: 'üé° Daily Spin', desc: 'Spin the wheel for free Orange Tickets', keywords: 'spin wheel daily reward ticket prize free', action: 'showSpinWheel()' },
        { id: '_quest', title: '‚ö° Start a Quest', desc: 'Guided learning quests through Bitcoin topics', keywords: 'quest mission journey learn guided start challenge', action: 'startQuestManual()' },
        { id: '_scholar', title: 'üéì Scholar Certification', desc: 'Bitcoin Scholar Certification Quest', keywords: 'scholar certification exam test certificate diploma bitcoin', action: 'startScholarQuest()' },
        { id: '_leaderboard', title: 'üèÜ Leaderboard', desc: 'See top ranked Bitcoiners', keywords: 'leaderboard ranking top leaders scoreboard competition', action: 'toggleLeaderboard()' },
        { id: '_tickets', title: 'üéüÔ∏è Orange Tickets', desc: 'Earn tickets for giveaways and rewards', keywords: 'tickets orange giveaway raffle prize sats reward earn', action: 'showSettings()' },
        { id: '_referral', title: 'üîó Referral Program', desc: 'Invite friends and earn 50 tickets each', keywords: 'referral invite share link friend earn bonus', action: 'showSettings()' },
        { id: '_closet', title: 'üéΩ Nacho\'s Closet', desc: 'Dress up Nacho with items you unlock', keywords: 'closet outfit clothes dress costume item equip nacho customize color', action: "showSettings();setTimeout(function(){var t=document.querySelector('[onclick*=nacho]');if(t)t.click()},300)" },
        { id: '_badges', title: 'üèÖ Badges', desc: 'View your earned badges and goals', keywords: 'badges achievement trophy unlock goal progress medal', action: "showSettings();setTimeout(function(){var t=document.querySelector('[onclick*=nacho]');if(t)t.click()},300)" },
        { id: '_story', title: 'üìñ Nacho\'s Story', desc: 'Read Nacho\'s Bitcoin adventure ‚Äî one chapter per day', keywords: 'story chapter read book adventure nacho tale', action: 'showNachoStory()' },
        { id: '_predict', title: 'üìà Price Prediction', desc: 'Predict if Bitcoin goes up or down in 24 hours', keywords: 'predict prediction price bitcoin up down forecast', action: 'showPrediction()' },
        { id: '_random', title: 'üé≤ Random Channel', desc: 'Jump to a random Bitcoin channel', keywords: 'random channel surprise discover explore dice', action: 'goRandom()' },
        { id: '_meme', title: 'üòÇ Random Meme', desc: 'See a random Bitcoin meme', keywords: 'meme funny joke random humor laugh memes', action: 'goRandomMeme()' },
        { id: '_art', title: 'üé® Random Art', desc: 'See random Bitcoin art and inspiration', keywords: 'art random artwork creative inspiration gallery', action: 'goRandomArt()' },
        { id: '_quiz', title: 'üéÆ Quiz Me', desc: 'Test your Bitcoin knowledge with Nacho', keywords: 'quiz question test knowledge trivia game answer', action: 'nachoQuizMe()' },
        { id: '_donate', title: 'üíõ Donate', desc: 'Support Bitcoin Education Archive with sats', keywords: 'donate support tip sats lightning contribute funding', action: 'showDonateModal()' },
        { id: '_theme', title: 'üåô Toggle Theme', desc: 'Switch between dark and light mode', keywords: 'theme dark light mode toggle switch appearance color night day', action: 'document.getElementById("themeToggle").click()' },
        { id: '_audio', title: 'üîä Toggle Audio', desc: 'Turn sound effects on or off', keywords: 'audio sound music mute volume effects toggle', action: 'toggleAudio()' },
        { id: '_keyboard', title: '‚å®Ô∏è Keyboard Shortcuts', desc: 'View all keyboard shortcuts', keywords: 'keyboard shortcut hotkey key binding keys shortcuts help', action: 'showKeyboardHelp()' },
        { id: '_explore', title: 'üó∫Ô∏è Exploration Map', desc: 'See which channels you have visited', keywords: 'exploration map progress visited channels grid complete coverage', action: 'goHome()' },
        { id: '_signin', title: 'üîê Sign In', desc: 'Sign in or create an account', keywords: 'sign in login register create account google twitter github facebook email', action: 'showUsernamePrompt()' },
        { id: '_home', title: 'üè† Home', desc: 'Return to the homepage', keywords: 'home main start beginning', action: 'goHome()' },
    ];

    function doSearch(q) {
        const sr = document.getElementById('searchResults');
        const cl = document.getElementById('channelList');
        if (!q || q.length < 2) {
            sr.classList.remove('active');
            sr.innerHTML = '';
            cl.style.display = '';
            return;
        }
        q = q.toLowerCase();
        cl.style.display = 'none';
        sr.classList.add('active');

        // Search internal app pages first
        let appResults = [];
        for (const page of APP_PAGES) {
            if (page.title.toLowerCase().includes(q) || page.keywords.includes(q) || page.desc.toLowerCase().includes(q)) {
                appResults.push({ key: page.id, title: page.title, cat: '‚ö° App', match: page.desc, action: page.action });
            }
        }

        // Search channel titles from index
        let results = [];
        for (const [key, meta] of Object.entries(CHANNELS)) {
            if (meta.title.toLowerCase().includes(q) || meta.desc.toLowerCase().includes(q)) {
                results.push({key, title: meta.title, cat: meta.cat, match: 'Channel match'});
            }
        }

        renderSearchResults([...appResults, ...results], sr);

        // Deep search: load full data and search message content (debounced)
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            await loadSearchIndex();
            let deepResults = [];
            for (const [key, d] of Object.entries(searchFullData)) {
                const meta = CHANNELS[key];
                if (!meta) continue;
                // Skip if already found by title
                if (results.some(r => r.key === key)) continue;
                for (const m of (d.msgs || [])) {
                    if (m.text && m.text.toLowerCase().includes(q)) {
                        let idx = m.text.toLowerCase().indexOf(q);
                        let start = Math.max(0, idx - 30);
                        let snippet = (start > 0 ? '...' : '') + m.text.substring(start, idx + q.length + 30).replace(/<[^>]+>/g, '') + '...';
                        deepResults.push({key, title: meta.title, cat: meta.cat, match: snippet});
                        break;
                    }
                }
            }
            renderSearchResults([...appResults, ...results, ...deepResults], sr);
        }, 500);
    }

    function renderSearchResults(results, sr) {
        if (results.length === 0) {
            sr.innerHTML = '<div style="padding:16px;color:#475569;text-align:center;">No results found</div>';
            return;
        }
        sr.innerHTML = results.slice(0, 30).map(r => {
            const isApp = r.key && r.key.startsWith('_');
            const onclick = isApp && r.action ? r.action : "selectResult('" + r.key + "')";
            const style = isApp ? 'border-left:3px solid var(--accent);' : '';
            return '<div class="sr-item" style="' + style + '" onclick="' + onclick + ';document.getElementById(\'searchResults\').classList.remove(\'active\');document.getElementById(\'searchResults\').innerHTML=\'\';document.getElementById(\'channelList\').style.display=\'\';document.getElementById(\'searchInput\').value=\'\';if(isMobile())document.getElementById(\'sidebar\').classList.remove(\'open\')">' +
                '<div class="sr-cat">' + r.cat + '</div>' +
                '<div>' + r.title + '</div>' +
                '<div class="sr-match">' + r.match + '</div></div>';
        }).join('');
    }

    function selectResult(key) {
        document.getElementById('searchInput').value = '';
        doSearch('');
        go(key);
    }

    // Unique visit counter via Firebase
    (function() {
        const vc = document.getElementById('visitCount');
        function updateVisitDisplay() {
            if (typeof firebase === 'undefined' || !firebase.firestore) return;
            const fdb = firebase.firestore();
            const today = new Date().toISOString().split('T')[0];

            // Generate a fingerprint-based visitor ID (harder to spoof than random)
            // Combines screen, timezone, language, platform ‚Äî same device = same ID
            var fp = [
                screen.width, screen.height, screen.colorDepth,
                Intl.DateTimeFormat().resolvedOptions().timeZone,
                navigator.language, navigator.hardwareConcurrency || 0,
                navigator.platform
            ].join('|');
            // Simple hash
            var hash = 0;
            for (var i = 0; i < fp.length; i++) {
                hash = ((hash << 5) - hash) + fp.charCodeAt(i);
                hash |= 0;
            }
            var fingerprintId = 'fp_' + Math.abs(hash).toString(36);

            // Also keep localStorage ID for cross-session persistence
            var storedId = localStorage.getItem('btc_visitor_id');
            if (!storedId) {
                storedId = fingerprintId;
                localStorage.setItem('btc_visitor_id', storedId);
            }

            // Use both: if fingerprint matches an existing visitor, use that
            // This prevents incognito/clear-storage from creating new visitors on the same device
            var visitorId = fingerprintId;

            // Rate limit: don't count more than once per session
            if (window._visitCounted) {
                fdb.collection('stats').doc('visits').get().then(function(d) {
                    if (d.exists) vc.textContent = (d.data().total || 0).toLocaleString();
                });
                return;
            }
            window._visitCounted = true;

            // Check if this visitor already counted today
            var visitRef = fdb.collection('visits').doc(visitorId);
            visitRef.get().then(function(doc) {
                if (!doc.exists || doc.data().lastVisit !== today) {
                    // New unique visit ‚Äî increment counter and mark visitor
                    var counterRef = fdb.collection('stats').doc('visits');
                    fdb.runTransaction(function(t) {
                        return t.get(counterRef).then(function(counterDoc) {
                            var newCount = (counterDoc.exists ? counterDoc.data().total : 0) + 1;
                            t.set(counterRef, { total: newCount });
                            t.set(visitRef, { lastVisit: today, fp: fingerprintId });
                            return newCount;
                        });
                    }).then(function(newCount) {
                        vc.textContent = newCount.toLocaleString();
                    });
                } else {
                    // Already counted today ‚Äî just display current total
                    fdb.collection('stats').doc('visits').get().then(function(d) {
                        if (d.exists) vc.textContent = (d.data().total || 0).toLocaleString();
                    });
                }
            }).catch(function() { vc.textContent = '‚Äî'; });
        }
        // Wait a moment for Firebase to init
        setTimeout(updateVisitDisplay, 2000);
    })();

    // Suggest a topic
    function expandSuggest() {
        const fields = document.getElementById('suggestFields');
        if (fields.style.display === 'none') {
            fields.style.display = 'block';
        } else {
            fields.style.display = 'none';
        }
    }

    let lastSuggestionTime = 0;
    async function submitSuggestion() {
        // Rate limit suggestions to 1 per 30 seconds
        const now = Date.now();
        if (now - lastSuggestionTime < 30000) {
            document.getElementById('suggestStatus').innerHTML = '<span style="color:#ef4444;">Please wait before submitting another suggestion.</span>';
            return;
        }
        lastSuggestionTime = now;
        const name = typeof sanitizeInput === 'function' ? sanitizeInput(document.getElementById('suggestName').value.trim()) : document.getElementById('suggestName').value.trim();
        const text = typeof sanitizeInput === 'function' ? sanitizeInput(document.getElementById('suggestText').value.trim()) : document.getElementById('suggestText').value.trim();
        const status = document.getElementById('suggestStatus');
        const btn = document.querySelector('.suggest-submit');

        if (!text) { status.innerHTML = '<span style="color:#ef4444;">Please enter a suggestion!</span>'; return; }

        btn.disabled = true;
        btn.textContent = 'Submitting...';
        try {
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                await firebase.firestore().collection('suggestions').add({
                    name: name || 'Anonymous',
                    suggestion: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            status.innerHTML = '<span style="color:#22c55e;">‚úÖ Thank you! Your suggestion has been submitted.</span>';
            document.getElementById('suggestName').value = '';
            document.getElementById('suggestText').value = '';
            btn.textContent = 'Submitted!';
            setTimeout(() => { btn.textContent = 'Submit Suggestion'; btn.disabled = false; }, 3000);
        } catch(e) {
            status.innerHTML = '<span style="color:#ef4444;">Error submitting. Please try again.</span>';
            btn.textContent = 'Submit Suggestion';
            btn.disabled = false;
        }
    }

    // Daily featured channel
    (function() {
        const keys = Object.keys(CHANNELS);
        // Use day of year as seed for deterministic daily rotation
        const now = new Date();
        const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
        const dailyKey = keys[dayOfYear % keys.length];
        const ch = CHANNELS[dailyKey];
        if (ch) {
            const el = document.getElementById('dailyChannel');
            el.innerHTML = '<div class="daily-label">üìÖ Channel of the Day</div>' +
                '<div class="daily-title">' + ch.title + '</div>' +
                '<div class="daily-desc">' + ch.desc + '</div>';
            el.onclick = () => go(dailyKey);
        }
    })();

    // Reading progress bar + back to top
    document.getElementById('main').addEventListener('scroll', function() {
        const el = this;
        const pct = el.scrollTop / (el.scrollHeight - el.clientHeight) * 100;
        document.getElementById('progressBar').style.width = Math.min(100, Math.max(0, pct)) + '%';
        document.getElementById('backToTop').classList.toggle('visible', el.scrollTop > 400);
        var nearBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 200;
        document.getElementById('scrollToBottom').classList.toggle('visible', !nearBottom);
    });

    window.onload = () => {
        // Auto-launch Nacho Mode if user has it set as default
        if (localStorage.getItem('btc_nacho_mode_default') === 'true' && !window.location.hash) {
            setTimeout(function() { if (typeof enterNachoMode === 'function') enterNachoMode(); }, 1500);
        }

        // Restore visited channel checkmarks
        const visited = JSON.parse(localStorage.getItem('btc_visited_channels') || '[]');
        visited.forEach(id => {
            document.querySelectorAll('.ch-btn').forEach(b => {
                if (b.getAttribute('onclick') && b.getAttribute('onclick').includes("'" + id + "'")) {
                    b.classList.add('visited');
                }
            });
        });

        renderFavs();
        showContinueReading();

        // Handle browser back/forward buttons
        // Set initial state so there's always a base entry to land on
        if (!history.state) history.replaceState({ home: true }, '', window.location.pathname + window.location.hash);

        window.addEventListener('popstate', function(e) {
            var state = e.state || {};
            var hash = location.hash.slice(1);

            // If we've gone back to null state (would leave site), push home state and stay
            if (!e.state && !hash) {
                history.pushState({ home: true }, '', window.location.pathname);
                goHome(true);
                return;
            }

            // Exit Nacho Mode if we're leaving it
            if (window._nachoMode && hash !== 'nacho' && !state.nachoMode) {
                window._nachoMode = false;
                window._nachoBusy = false;
                if (window._btcPriceTimer) { clearInterval(window._btcPriceTimer); window._btcPriceTimer = null; }
                var nmScreen = document.getElementById('nachoModeScreen');
                if (nmScreen) nmScreen.remove();
                document.querySelectorAll('aside, #rankBar, #lbFloatBtn, #floatingRandomBtn, #userDisplay, #backToTop, #scrollToBottom, #nacho-container, #nacho-toggle').forEach(function(el) { if (el) el.style.display = ''; });
                var mbar2 = document.querySelector('.mobile-bar');
                if (mbar2 && window.innerWidth <= 900) mbar2.style.display = 'flex';
            }

            // Nacho Mode
            if (hash === 'nacho' || state.nachoMode) {
                if (!window._nachoMode) enterNachoMode(true);
                return;
            }

            // Marketplace sub-views (listing detail, my listings)
            if (state.channel === 'marketplace' && state.mktView) {
                if (typeof handleMarketplacePopState === 'function') {
                    handleMarketplacePopState(state, hash);
                    return;
                }
            }
            if (hash && hash.indexOf('marketplace/') === 0) {
                if (typeof handleMarketplacePopState === 'function') {
                    handleMarketplacePopState(state, hash);
                    return;
                }
            }

            // Marketplace browse
            if (hash === 'marketplace' || state.channel === 'marketplace') {
                go('marketplace', null, true);
                return;
            }

            // Forum post detail
            if ((state.channel === 'forum' && state.forumPost) || (hash && hash.indexOf('forum/post/') === 0)) {
                var postId = state.forumPost || hash.replace('forum/post/', '');
                if (typeof forumViewPost === 'function') {
                    // Make sure forum container is visible
                    document.getElementById('home').classList.add('hidden');
                    document.getElementById('msgs').style.display = 'none';
                    document.getElementById('hero').style.display = 'none';
                    var fc = document.getElementById('forumContainer');
                    if (fc) fc.style.display = 'block';
                    forumViewPost(postId, true);
                }
                return;
            }

            // Forum listing
            if (hash === 'forum' || (state.channel && state.channel.indexOf('forum') === 0)) {
                go('forum', null, true);
                return;
            }

            // Channel
            if (hash) {
                go(hash, null, true);
            } else {
                goHome(true);
            }
        });

        const h = location.hash.slice(1);
        if (h === 'nacho') { enterNachoMode(true); }
        else if (h === 'forum') { setTimeout(function() { if (typeof renderForum === 'function') renderForum(); }, 500); }
        else if (h) go(h);
    };
    </script>
<div id="recaptcha-container"></div>
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').then(function(reg) {
            // Check for updates every 5 minutes
            setInterval(function() { reg.update(); }, 300000);

            reg.addEventListener('updatefound', function() {
                var newWorker = reg.installing;
                if (!newWorker) return;
                newWorker.addEventListener('statechange', function() {
                    if (newWorker.state === 'activated' && navigator.serviceWorker.controller) {
                        // New version installed ‚Äî show update banner
                        var banner = document.createElement('div');
                        banner.id = 'updateBanner';
                        banner.style.cssText = 'position:fixed;bottom:70px;left:16px;right:16px;z-index:9999;background:linear-gradient(135deg,#f7931a,#ea580c);color:#fff;padding:14px 16px;border-radius:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 8px 30px rgba(0,0,0,0.4);animation:slideInUp 0.3s;font-family:inherit;';
                        banner.innerHTML =
                            '<div style="flex:1;">' +
                                '<div style="font-weight:700;font-size:0.9rem;">üÜï Update Available!</div>' +
                                '<div style="font-size:0.75rem;opacity:0.9;">New features and improvements are ready.</div>' +
                            '</div>' +
                            '<button onclick="location.reload()" style="padding:8px 16px;background:#fff;color:#f7931a;border:none;border-radius:8px;font-weight:700;font-size:0.8rem;cursor:pointer;font-family:inherit;white-space:nowrap;touch-action:manipulation;">Refresh</button>' +
                            '<button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(255,255,255,0.7);font-size:1.2rem;cursor:pointer;padding:4px;">‚úï</button>';
                        document.body.appendChild(banner);
                    }
                });
            });
        }).catch(function() {});
    });
}
</script>
</body>
</html>
<!-- v1771873982 -->
